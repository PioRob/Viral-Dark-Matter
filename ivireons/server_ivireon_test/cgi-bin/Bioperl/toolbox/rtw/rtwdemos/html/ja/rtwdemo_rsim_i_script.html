
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!-- This HTML was auto-generated from MATLAB code. To make changes, update the MATLAB code and republish this document.       --><title>ラピッド シミュレーションに対して、データを Inport ブロックに入力するための MAT ファイルの利用</title><meta name="generator" content="MATLAB 7.11"><link rel="schema.DC" href="../http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2010-05-27"><meta name="DC.source" content="rtwdemo_rsim_i_script.m"><link rel="stylesheet" type="text/css" href="../../../../matlab/demos/private/style.css"></head><body><div class="header"><div class="left"><a href="matlab:edit rtwdemo_rsim_i_script">エディターで rtwdemo_rsim_i_script.m を開く</a></div><div class="right"><a href="matlab:echodemo rtwdemo_rsim_i_script">コマンド ウィンドウで実行</a></div></div><div class="content"><h1>ラピッド シミュレーションに対して、データを Inport ブロックに入力するための MAT ファイルの利用</h1><!--introduction--><p>Real-Time Workshop&reg; の RSim -i オプションを使用すると、ラピッド シミュレーションの Inport ブロックのための入力データ ソースとして MAT ファイルを使用できます。このような MAT ファイルのデータは、次の形式のいずれかで示すことができます。</p><pre> (1) double 値の時間/入力データ行列を定義する 1 つの変数。</pre><pre> (2) Simulink(R) データ型の組み合わせを使用する構造体を定義する 1 つの変数。
</pre><pre> (3) Simulink データ型の組み合わせを使用する構造体を個別に定義する複数の変数。
</pre><p>このような柔軟性は、複数のデータ ファイルに保存されている入力データの範囲にわたるシミュレーションを実行する必要のあるアプリケーションに向いています。このデモでは、この機能を利用する方法を説明します。</p><!--/introduction--><h2>目次</h2><div><ul><li><a href="#1">手順 1.  準備</a></li><li><a href="#3">手順 2.  Inport ブロックの設定</a></li><li><a href="#4">手順 3.  モデルのビルド</a></li><li><a href="#5">手順 4.  入力信号</a></li><li><a href="#6">手順 5.  MAT ファイルの準備</a></li><li><a href="#10">手順 6.  複数のファイルを使用した 3 個の RSim シミュレーションの実行、および結果のプロット</a></li></ul></div><h2>手順 1.  準備<a name="1"></a></h2><p>現在のディレクトリ内が書き込み可能であることを確認します。このデモではファイルを作成します。</p><pre class="codeinput">[stat, fa] = fileattrib(pwd);
<span class="keyword">if</span> ~fa.UserWrite
    disp(<span class="string">'RSim -i option Demo must be run in a writable directory'</span>);
    <span class="keyword">return</span>;
<span class="keyword">end</span>
</pre><p>モデルを開き、Real-Time Workshop RSim ターゲットを使用するように設定します。操作のグラフィカルな説明および他の RSim ターゲット関連オプションの詳細は、<a href="matlab:helpview(fullfile(docroot,'toolbox','rtw','helptargets.map'),'config_target')">こちらを参照</a>してください。</p><pre class="codeinput">mdlName = <span class="string">'rtwdemo_rsim_i'</span>;
open_system(mdlName);
cs = getActiveConfigSet(mdlName);
cs.switchTarget(<span class="string">'rsim.tlc'</span>,[]);
</pre><img vspace="5" hspace="5" src="../rtwdemo_rsim_i_script_01.png" alt=""> <h2>手順 2.  Inport ブロックの設定<a name="3"></a></h2><p>RSim -i オプションを使用するには、各 Inport ブロックを適切に設定する必要があります。 Inport ブロックをダブルクリックすると、そのプロパティを表示できます。 既定の設定では、Inport ブロックは下流のブロックからプロパティを継承します。 外部 MAT ファイルからデータをインポートする前に、MAT ファイルのデータと一致するように各 Inport ブロックのパラメーターを設定する必要があります。 多くの場合、Inport ブロックの Interpolate Data、Port Dimensions、Data Type、および Signal Type の各パラメーターの設定が必要です。 これらのパラメーターの詳細は、ヘルプ ボタンをクリックします。  このデモ モデルには、3 つの Inport ブロックが存在します。 Inport 1 および 2 については、データ間を補間し、Inport 3 については補間しないものとします。 各 Inport ブロックの次元は、それぞれ、2、1、2 です。  すべての信号は実信号です。 設定は、以下のとおりです。</p><pre class="codeinput"><span class="keyword">for</span> i = 1:3
    portName      =[<span class="string">'/In'</span>, num2str(i)];
    Interp        = get_param(strcat(mdlName,portName),<span class="string">'Interpolate'</span>);
    PortDimension = get_param(strcat(mdlName,portName),<span class="string">'PortDimensions'</span>);
    DataType      = get_param(strcat(mdlName,portName),<span class="string">'DataType'</span>);
    SignalType    = get_param(strcat(mdlName,portName),<span class="string">'SignalType'</span>);
    s1= sprintf(<span class="string">'For inport %s '</span>, portName(2:4));
    disp(<span class="string">'-----------------------------'</span>);
    disp(s1);
    s2= sprintf(<span class="string">'The interpolation flag is %s'</span>, Interp);
    disp(s2);
    s3 = sprintf(<span class="string">'    The port dimension is %s'</span>, PortDimension);
    disp(s3);
    s4 = sprintf(<span class="string">'        The data type  is %s'</span>, DataType);
    disp(s4);
    s5 = sprintf(<span class="string">'       The signal type is %s\n'</span>, SignalType);
    disp(s5);
<span class="keyword">end</span>
</pre><pre class="codeoutput">-----------------------------
For inport In1 
The interpolation flag is on
    The port dimension is 2
        The data type  is double
       The signal type is real

-----------------------------
For inport In2 
The interpolation flag is on
    The port dimension is 1
        The data type  is double
       The signal type is real

-----------------------------
For inport In3 
The interpolation flag is off
    The port dimension is 2
        The data type  is double
       The signal type is real

</pre><h2>手順 3.  モデルのビルド<a name="4"></a></h2><p>モデルの RSim 実行可能ファイルをビルドします。ビルド プロセスの間、モデルについて構造的なチェックサムが計算され、生成された実行可能ファイルに組み込まれます。このチェックサムは、実行可能ファイルに渡されたパラメーター セットが互換性があることを確認するために使用されます。</p><pre class="codeinput"> evalc(<span class="string">'rtwbuild(mdlName)'</span>);
</pre><h2>手順 4.  入力信号<a name="5"></a></h2><p>Inport ブロックが設定されると、Inport ブロックに基づいてデータ ファイルを準備する必要があります。次の図は、使用する入力信号を示しています。</p><pre class="codeinput">t=[0:0.01:2*pi]';
s1 = [2*sin(t) 2*cos(t)];
s2 = sin(2*t);
s3 = [0.5*sin(3*t) 0.5*cos(3*t)];
figure(1);
plot(t, [s1 s2 s3]);
disp(<span class="string">'The following figure displays the input signals.'</span>);
</pre><pre class="codeoutput">The following figure displays the input signals.
</pre><img vspace="5" hspace="5" src="../rtwdemo_rsim_i_script_02.png" alt=""> <h2>手順 5.  MAT ファイルの準備<a name="6"></a></h2><p>通常、ワークスペース変数から、MAT ファイルを作成できます。RSim -i オプションは、次の 3 つのデータ ファイル形式をサポートします。</p><p>1) TU 行列形式の double の 1 つの変数を含む MAT ファイル。この形式の場合、最初の列は時間ベクトルであり、残りの列は入力ベクトルです。TU 行列の列数は、すべてのルート Inport ブロックの次元の和に 1 を加えた値に等しくなります。次の MATLAB コードは、TU 行列形式の 1 つの変数 var_matrix を含む MAT ファイルを生成します。モデル内のすべての入力端子が同じデータ型を持つ場合にのみ、この形式を使用できることに注意してください。</p><pre class="codeinput">t=[0:0.1:2*pi]';
Ina1 = [2*sin(t) 2*cos(t)];
Ina2 = sin(2*t);
Ina3 = [0.5*sin(3*t) 0.5*cos(3*t)];
var_matrix = [ t Ina1 Ina2 Ina3];
save <span class="string">rsim_i_matrix.mat</span> <span class="string">var_matrix</span>;
disp(<span class="string">'rsim_i_matrix.mat contains one variable var_matrix in TU matrix format.'</span>);
</pre><pre class="codeoutput">rsim_i_matrix.mat contains one variable var_matrix in TU matrix format.
</pre><p>2) 構造体形式の 1 つの変数を含む MAT ファイル。この形式の場合、変数は、'time' および 'signal' の 2 つのフィールドを含まなければなりません。Inport ブロックの 1 つが Interpolate Data を On に設定する場合、変数の 'time' フィールドを空のベクトルにすることはできません。また、信号の幅は、Inport ブロックの幅の合計に等しくする必要があります。次のコードは、信号変数構造体形式の 1 つの変数 var_matrix を含む MAT ファイルを生成します。この形式は、異なるデータ型の入力端子をサポートできるため、TU 行列形式よりも柔軟性に富んでいます。</p><pre class="codeinput">t=[0:0.1:2*pi]';
var_single_struct.time = t;
var_single_struct.signals(1).values(:,1) = 2*sin(t);
var_single_struct.signals(1).values(:,2) = 2*cos(t);
var_single_struct.signals(2).values = sin(2*t);
var_single_struct.signals(3).values(:,1) = 0.5*sin(3*t) ;
var_single_struct.signals(3).values(:,2) = 0.5*cos(3*t) ;
v=[var_single_struct.signals(1).values var_single_struct.signals(2).values <span class="keyword">...</span>
    var_single_struct.signals(3).values ];
save <span class="string">rsim_i_single_struct.mat</span> <span class="string">var_single_struct</span>;
disp(<span class="string">'rsim_i_single_struct.mat contains one variable var_single_struct in'</span>)
disp(<span class="string">'struct format.'</span>);
</pre><pre class="codeoutput">rsim_i_single_struct.mat contains one variable var_single_struct in
struct format.
</pre><p>3) 構造体形式の複数の変数を含む MAT ファイル。この形式の場合、変数の数は、Inport ブロックの数と等しくなります。異なる変数が、別々の時間ベクトルを持つことができます。次のコードは、構造体形式の複数の変数を含む MAT ファイルを生成します。この方法は、各 Inport ブロックが独自の時間ベクトルを持つことができるため、最も柔軟性が高い方法です。</p><pre class="codeinput">t=[0:0.1:2*pi]';
Inb1.time = t;
Inb1.signals.values(:,1) = 2*sin(t);
Inb1.signals.values(:,2) = 2*cos(t);
t=[0:0.2:2*pi]';
Inb2.time = t;
Inb2.signals.values(:,1) = sin(2*t);
t=[0:0.1:2*pi]';
Inb3.time =  t;
Inb3.signals.values(:,1) = 0.5*sin(3*t);
Inb3.signals.values(:,2) = 0.5*cos(3*t);
save <span class="string">rsim_i_multi_struct.mat</span> <span class="string">Inb1</span>;
save <span class="string">rsim_i_multi_struct.mat</span> <span class="string">Inb2</span> <span class="string">-append</span>;
save <span class="string">rsim_i_multi_struct.mat</span> <span class="string">Inb3</span> <span class="string">-append</span>;
disp(<span class="string">'rsim_i_multi_struct.mat contains three variables Inb1\Inb2\Inb3'</span>);
disp(<span class="string">'in struct format.Note that command save -append option must be'</span>);
disp(<span class="string">'used to generate the MAT-file in order to preserve the order of'</span>);
disp(<span class="string">'the variables in the MAT-file generated.Note that the command:'</span>)
disp(<span class="string">'save rsim_i_multi_struct.mat Inb1 Inb2 Inb3 will not guarantee'</span>);
disp(<span class="string">'the order of the variables in MAT-file and should not be used'</span>);
disp(<span class="string">'to generate the MAT-file.'</span>);
</pre><pre class="codeoutput">rsim_i_multi_struct.mat contains three variables Inb1\Inb2\Inb3
in struct format.Note that command save -append option must be
used to generate the MAT-file in order to preserve the order of
the variables in the MAT-file generated.Note that the command:
save rsim_i_multi_struct.mat Inb1 Inb2 Inb3 will not guarantee
the order of the variables in MAT-file and should not be used
to generate the MAT-file.
</pre><h2>手順 6.  複数のファイルを使用した 3 個の RSim シミュレーションの実行、および結果のプロット<a name="10"></a></h2><p>RSim -i オプションは、バッチ モードのシミュレーションでも使用できます。すべての MAT ファイルを準備し、RSim ターゲットを別々の MAT ファイルで実行するだけで済みます。</p><pre class="codeinput">figure(2)
fileName = ({<span class="string">'rsim_i_matrix'</span>, <span class="string">'rsim_i_single_struct'</span>, <span class="string">'rsim_i_multi_struct'</span>});
<span class="keyword">for</span> i=1:3
  <span class="comment">% bang out and run a simulation using new parameter data</span>
  name = fileName(i);
  runstr = [<span class="string">'.'</span>, filesep, <span class="string">'rtwdemo_rsim_i -i '</span>,char(name),<span class="string">'.mat'</span>, <span class="string">' -v'</span>];
  evalc(<span class="string">'system(runstr)'</span>);
  pause(0.5);
  <span class="comment">% load simulation data into MATLAB(R) for plotting.</span>
  load <span class="string">rtwdemo_rsim_i.mat</span>;
  subplot(3,1,i);
  axis([0,6, -5, 5]);
  plot(rt_tout, rt_yout);
  hold <span class="string">on</span>
<span class="keyword">end</span>

disp(<span class="string">'This part of the demo illustrates a sequence of 3 plots.Each plot'</span>);
disp(<span class="string">'shows the simulation results by using input MAT-file with different'</span>);
disp(<span class="string">'variable format.Notice that the model is compiled only once.'</span>);
close_system(mdlName, 0);
</pre><pre class="codeoutput">This part of the demo illustrates a sequence of 3 plots.Each plot
shows the simulation results by using input MAT-file with different
variable format.Notice that the model is compiled only once.
</pre><img vspace="5" hspace="5" src="../rtwdemo_rsim_i_script_03.png" alt=""> <p class="footer">Copyright 2005-2010 The MathWorks, Inc.<br>Published with MATLAB&reg; 7.11</p><p class="footer" id="trademarks">MATLAB and Simulink are registered trademarks of The MathWorks, Inc.  Please see <a href="http://www.mathworks.com/trademarks">www.mathworks.com/trademarks</a> for a list of other trademarks owned by The MathWorks, Inc.  Other product or brand names are trademarks or registered trademarks of their respective owners.</p></div><!-- ##### SOURCE BEGIN ##### %% Using MAT-Files to Feed Data to Inport Blocks for Rapid Simulations % % The RSim -i option in Real-Time Workshop(R) lets you use a MAT-file as the  % input data source for Inport blocks for rapid simulations.  The data in  % such a MAT-file can be presented in any of the following formats: % %   (1) One variable that defines a time/input data matrix of double values. % %   (2) One variable that defines a structure that uses any combination of %       Simulink(R) data types. % %   (3) Multiple variables, each defining a structure that uses any combination  %       of Simulink data types.  % % This flexibility lends itself well to applications for which you must run % simulations over a range of input data stored in different data files. % This demo explains how to use this feature.  % Copyright 2005-2010 The MathWorks, Inc.  %% Step 1.  Preparation % Make sure the current directory is writable. This demo creates files. % [stat, fa] = fileattrib(pwd); if ~fa.UserWrite     disp('RSim -i option Demo must be run in a writable directory');     return; end %% % Open the model and configure it to use the Real-Time Workshop RSim target.  % For more information on doing this graphically and setting up other RSim  % target related options, % <matlab:helpview(fullfile(docroot,'toolbox','rtw','helptargets.map'),'config_target')  % look here>. %  mdlName = 'rtwdemo_rsim_i'; open_system(mdlName); cs = getActiveConfigSet(mdlName); cs.switchTarget('rsim.tlc',[]);  %% Step 2. Configure the Inport Blocks % To use the RSim -i option, you must configure each Inport block properly.  % You can double-click an Inport block to view its properties. By default,  % Inport blocks inherit their properties from downstream blocks. Before you  % can import data from external MAT-files, you must set the parameters  % of each Inport block to match the data in the MAT file. In most cases,  % the following parameters of an Inport block must be set: Interpolate Data,  % Port Dimensions, Data Type, and Signal Type. For more information on these  % parameters, click the Help button.  In this demo model, three Inport blocks  % exist. We want Inport 1 and Inport 2 to interpolate between data, and  % Inport 3 to not interpolate. The dimension of the Inport blocks are 2, 1,  % and 2, respectively.  All signals are real. The settings are as follows:  % for i =1:3         portName      =['/In', num2str(i)];     Interp        = get_param(strcat(mdlName,portName),'Interpolate');     PortDimension = get_param(strcat(mdlName,portName),'PortDimensions');     DataType      = get_param(strcat(mdlName,portName),'DataType');     SignalType    = get_param(strcat(mdlName,portName),'SignalType');     s1= sprintf('For inport %s ', portName(2:4));     disp('REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-');     disp(s1);     s2= sprintf('The interpolation flag is %s', Interp);     disp(s2);     s3 = sprintf('    The port dimension is %s', PortDimension);     disp(s3);     s4 = sprintf('        The data type  is %s', DataType);     disp(s4);      s5 = sprintf('       The signal type is %s\n', SignalType);     disp(s5); end  %% Step 3.  Build the Model % Build the RSim executable for the model. During the build process, a % structural checksum is calculated for the model and embedded into the % generated executable. This checksum is used to check that any parameter  % set passed to the executable is compatible with it.  %  evalc('rtwbuild(mdlName)');    %% Step 4. The Input Signals  % Once the Inport block is configured, the data file should be prepared % based on the Inport blocks. The following figure shows the input signals % to be used.   t=[0:0.01:2*pi]'; s1 = [2*sin(t) 2*cos(t)]; s2 = sin(2*t); s3 = [0.5*sin(3*t) 0.5*cos(3*t)]; figure(1); plot(t, [s1 s2 s3]); disp('The following figure displays the input signals.');  %% Step 5. Prepare the MAT-File % Generally, the MAT-file can be created from a workspace variable.  % The RSim -i option supports three data file formats:  %% % 1) The MAT-file contains one variable in TU matrix format of doubles.  % For this format, the first column is the time vector and the remaining  % columns are input vectors. The number of columns in the TU matrix equals  % the sum of the dimensions of all the root Inport blocks plus 1. The  % following MATLAB code generates a MAT-file containing one variable var_matrix  % in TU matrix format. Note that you can use this format only if all input  % ports in your model have the same data type.  t=[0:0.1:2*pi]'; Ina1 = [2*sin(t) 2*cos(t)]; Ina2 = sin(2*t); Ina3 = [0.5*sin(3*t) 0.5*cos(3*t)]; var_matrix = [ t Ina1 Ina2 Ina3]; save rsim_i_matrix.mat var_matrix; disp('rsim_i_matrix.mat contains one variable var_matrix in TU matrix format.');  %% % 2) The MAT-file contains one variable in structure format. For this format,  % the variable must contain two fields called time and signals. If one of  % the Inport block sets Interpolate Data to On, then the time field of the % variable must not be an empty vector. Also, the width of the signals must  % equal the total width of the Inport blocks. The following code generates  % a MAT-file that contains one variable var_matrix in signal variable structure  % format. This format is more flexible than the TU matrix format because it  % can support input ports with different data types.  t= [0:0.1:2*pi]'; var_single_struct.time = t; var_single_struct.signals(1).values(:,1) = 2*sin(t); var_single_struct.signals(1).values(:,2) = 2*cos(t); var_single_struct.signals(2).values = sin(2*t); var_single_struct.signals(3).values(:,1) = 0.5*sin(3*t) ; var_single_struct.signals(3).values(:,2) = 0.5*cos(3*t) ; v=[var_single_struct.signals(1).values var_single_struct.signals(2).values ...     var_single_struct.signals(3).values ]; save rsim_i_single_struct.mat var_single_struct; disp('rsim_i_single_struct.mat contains one variable var_single_struct in') disp('struct format.');  %% % 3) The MAT-file contains multiple variables in structure format. For this format, % the number of variables equals the number of Inport blocks. Different variables % can have different time vectors. The following code generates a MAT-file that  % contains multiple variables, each in structure format. This is the most flexible  % format because it allows each Inport block to have its own time vector.   t= [0:0.1:2*pi]'; Inb1.time = t; Inb1.signals.values(:,1) = 2*sin(t); Inb1.signals.values(:,2) = 2*cos(t); t= [0:0.2:2*pi]';  Inb2.time = t; Inb2.signals.values(:,1) = sin(2*t); t= [0:0.1:2*pi]'; Inb3.time =  t; Inb3.signals.values(:,1) = 0.5*sin(3*t); Inb3.signals.values(:,2) = 0.5*cos(3*t); save rsim_i_multi_struct.mat Inb1; save rsim_i_multi_struct.mat Inb2 -append; save rsim_i_multi_struct.mat Inb3 -append; disp('rsim_i_multi_struct.mat contains three variables Inb1\Inb2\Inb3'); disp('in struct format. Note that command save -append option must be'); disp('used to generate the MAT-file in order to preserve the order of'); disp('the variables in the MAT-file generated. Note that the command:') disp('save rsim_i_multi_struct.mat Inb1 Inb2 Inb3 will not guarantee'); disp('the order of the variables in MAT-file and should not be used'); disp('to generate the MAT-file.');  %% Step 6. Run 3 RSim Simulations Using Different Files and Plot the Results % RSim -i options can also be used for batch mode simulation. Just prepare % all the MAT-files and run the RSim target with different MAT-files.   figure(2) fileName = ({'rsim_i_matrix', 'rsim_i_single_struct', 'rsim_i_multi_struct'});   for i=1:3   % bang out and run a simulation using new parameter data   name = fileName(i);   runstr = ['.', filesep, 'rtwdemo_rsim_i -i ',char(name),'.mat', ' -v'];   evalc('system(runstr)');   pause(0.5);   % load simulation data into MATLAB(R) for plotting.   load rtwdemo_rsim_i.mat;    subplot(3,1,i);   axis([0,6, -5, 5]);   plot(rt_tout, rt_yout);    hold on   end  disp('This part of the demo illustrates a sequence of 3 plots. Each plot');  disp('shows the simulation results by using input MAT-file with different'); disp('variable format. Notice that the model is compiled only once.');   close_system(mdlName, 0);  displayEndOfDemoMessage(mfilename)  ##### SOURCE END ##### --></body></html>