
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Saving and Restoring Simulation Using SimState</title><meta name="generator" content="MATLAB 7.11"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2010-06-30"><meta name="DC.source" content="sldemo_simstate_script.m"><link rel="stylesheet" type="text/css" href="../../../../matlab/demos/private/style.css"></head><body><div class="header"><div class="left"><a href="matlab:edit sldemo_simstate_script">Open sldemo_simstate_script.m in the Editor</a></div><div class="right"><a href="matlab:echodemo sldemo_simstate_script">Run in the Command Window</a></div></div><div class="content"><h1>Saving and Restoring Simulation Using SimState</h1><!--introduction--><p>This demo illustrates the capability of saving and restoring a simulation state (SimState) using SimState objects. The SimState object contains the set of all variables that are related to the simulation of a model. By saving the SimState object at the end of a simulation, Simulink&reg; is able to reload the SimState and reproduce the exact same simulation results at the time at which the SimState was saved.</p><p>This demo illustrates:</p><p>1. Saving the Final states (logged states) is not always sufficient for complete, accurate restoration of the final simulation state.</p><p>2. How you can use the SimState feature to save and restore a complete, final simulation state.</p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Difficulties with Models with Variable Transport Delay</a></li><li><a href="#6">Saving and Restoring the Complete SimState</a></li></ul></div><h2>Difficulties with Models with Variable Transport Delay<a name="1"></a></h2><p>Models with Transport Delay blocks are usually difficult to restore to their state because, when you save the "Final states", the state of the transport delay is not saved in the structure format or the array format.</p><p>We wish to compare the simulation results for two cases:</p><p>1. Simulate the model from 0 to 5 seconds and save the "Final states" in the workspace. Then load this first set of final states and simulate from 5 to 10 seconds.</p><p>2. Simulate the model from 0 to 10 seconds and force the model to produce an output at 5 seconds. We call the result of this simulation the baseline result since it is a nonstop simulation.</p><p>The results of the first simulation matches the first half of the baseline result. If the simulation state had been restored completely, the second simulation results should match the second half of the baseline.</p><pre class="codeinput">mdl = <span class="string">'sldemo_VariableTransportDelay'</span>;
load_system(mdl);
</pre><p>Simulate and save the final state in structure format.</p><pre class="codeinput">out = sim(mdl, <span class="string">'StopTime'</span>, <span class="string">'5'</span>, <span class="string">'SaveFinalState'</span>, <span class="string">'on'</span>,<span class="keyword">...</span>
          <span class="string">'SaveFormat'</span>,<span class="string">'Structure'</span>);
y1 = out.get(<span class="string">'ScopeData'</span>);
</pre><p>Load the final state from the last simulation and run.</p><pre class="codeinput">assignin(<span class="string">'base'</span>, <span class="string">'xFinal'</span>, out.get(<span class="string">'xFinal'</span>));
out1 = sim(mdl, <span class="string">'StartTime'</span>, <span class="string">'5'</span>, <span class="string">'StopTime'</span>, <span class="string">'10'</span>, <span class="keyword">...</span>
           <span class="string">'SaveFinalState'</span>, <span class="string">'off'</span>, <span class="keyword">...</span>
           <span class="string">'LoadInitialState'</span>, <span class="string">'on'</span>, <span class="string">'InitialState'</span>, <span class="string">'xFinal'</span>);
y2 = out1.get(<span class="string">'ScopeData'</span>);
</pre><p>Run a nonstop simulation to serve as the baseline result.</p><pre class="codeinput">out2 =  sim(mdl, <span class="string">'OutputOption'</span>, <span class="string">'AdditionalOutputTimes'</span> ,<span class="keyword">...</span>
             <span class="string">'OutputTimes'</span>,<span class="string">'[0 5 10]'</span>, <span class="string">'LoadInitialState'</span>, <span class="string">'off'</span>);
y = out2.get(<span class="string">'ScopeData'</span>);
</pre><p>Plot the results. The second half of the baseline result does not match the simulation from 5 to 10 seconds whose initial state was restored from the final state saved at 5 seconds.</p><pre class="codeinput"><span class="keyword">for</span> i=1:3
    subplot(3, 1, i);
    plot(y.time,y.signals(1).values);
    hold <span class="string">on</span>
    plot([y1.time; y2.time],[y1.signals(1).values;y2.signals(1).values], <span class="keyword">...</span>
        <span class="string">'r--'</span>);
<span class="keyword">end</span>
</pre><img vspace="5" hspace="5" src="sldemo_simstate_script_01.png" alt=""> <h2>Saving and Restoring the Complete SimState<a name="6"></a></h2><p>Simulink provides the option to save the complete final SimState in Simulink.SimState object. The SimState object contains all of the variables needed to restore the simulation results. By saving the complete SimState, Simulink is able to restore the simulation completely and to produce the baseline simulation results.</p><p>Set the parameter for Simulink to save the complete SimState at the end of the simulation.</p><pre class="codeinput">out3 = sim(mdl, <span class="string">'StopTime'</span>, <span class="string">'5'</span>, <span class="string">'SaveFinalState'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
          <span class="string">'LoadInitialState'</span>, <span class="string">'off'</span>, <span class="string">'SaveCompleteFinalSimState'</span>, <span class="string">'on'</span>);
xFinal = out3.get(<span class="string">'xFinal'</span>);
y1 = out3.get(<span class="string">'ScopeData'</span>);
</pre><p>Load the SimState from the last simulation and run for an additional 5 seconds. There is no need to provide the start time; however, the value must remain zero. The actual start time is stored in xFinal and will overwrite zero.</p><pre class="codeinput">out4 = sim(mdl, <span class="string">'StopTime'</span>, <span class="string">'10'</span>, <span class="string">'SaveFinalState'</span>, <span class="string">'off'</span>, <span class="keyword">...</span>
          <span class="string">'LoadInitialState'</span>, <span class="string">'on'</span>, <span class="string">'InitialState'</span>, <span class="string">'xFinal'</span>);
y2 = out4.get(<span class="string">'ScopeData'</span>);
</pre><p>Plot the results and compare them with the baseline simulation. The simulation state was completely restored and thus the SimState results match the baseline.</p><pre class="codeinput">clf;
<span class="keyword">for</span> i=1:3
    subplot(3, 1, i);
    plot(y.time,y.signals(1).values);
    hold <span class="string">on</span>
    plot([y1.time; y2.time],[y1.signals(1).values;y2.signals(1).values], <span class="keyword">...</span>
        <span class="string">'r--'</span>);
<span class="keyword">end</span>

close_system(mdl, 0);
</pre><img vspace="5" hspace="5" src="sldemo_simstate_script_02.png" alt=""> <p class="footer">Copyright 2008-2010 The MathWorks, Inc.<br>
          Published with MATLAB&reg; 7.11</p><p class="footer" id="trademarks">MATLAB and Simulink are registered trademarks of The MathWorks, Inc.  Please see <a href="http://www.mathworks.com/trademarks">www.mathworks.com/trademarks</a> for a list of other trademarks owned by The MathWorks, Inc.  Other product or brand names are trademarks or registered trademarks of their respective owners.</p></div><!--
##### SOURCE BEGIN #####
%% Saving and Restoring Simulation Using SimState
% This demo illustrates the capability of saving and restoring a simulation
% state (SimState) using SimState objects. The SimState object contains 
% the set of all variables that are related to the simulation of a model. 
% By saving the SimState object at the end of a simulation, Simulink(R) is 
% able to reload the SimState and reproduce the exact same simulation 
% results at the time at which the SimState was saved. 
%
% This demo illustrates:
%
% 1. Saving the Final states (logged states) is not always sufficient for
% complete, accurate restoration of the final simulation state.
%
% 2. How you can use the SimState feature to save and restore a complete, 
% final simulation state.

%   Copyright 2008-2010 The MathWorks, Inc.
%   $Revision: 1.1.6.3 $  $Date: 2010/05/20 03:16:26 $

%% Difficulties with Models with Variable Transport Delay
% Models with Transport Delay blocks are usually difficult to restore to
% their state because, when you save the "Final states", the state of the  
% transport delay is not saved in the structure format or the array format. 
%
% We wish to compare the simulation results for two cases:
% 
% 1. Simulate the model from 0 to 5 seconds and save the "Final states"
% in the workspace. Then load this first set of final states and simulate 
% from 5 to 10 seconds. 
%
% 2. Simulate the model from 0 to 10 seconds and force the model to
% produce an output at 5 seconds. We call the result of this simulation
% the baseline result since it is a nonstop simulation.
%
% The results of the first simulation matches the first half 
% of the baseline result. If the simulation state had been restored completely, 
% the second simulation results should match the second half of the baseline. 
%
mdl = 'sldemo_VariableTransportDelay';
load_system(mdl);

%%
% Simulate and save the final state in structure format.
out = sim(mdl, 'StopTime', '5', 'SaveFinalState', 'on',...
          'SaveFormat','Structure');
y1 = out.get('ScopeData');

%%
% Load the final state from the last simulation and run.
assignin('base', 'xFinal', out.get('xFinal'));
out1 = sim(mdl, 'StartTime', '5', 'StopTime', '10', ...
           'SaveFinalState', 'off', ...
           'LoadInitialState', 'on', 'InitialState', 'xFinal');
y2 = out1.get('ScopeData');

%%
% Run a nonstop simulation to serve as the baseline result.
out2 =  sim(mdl, 'OutputOption', 'AdditionalOutputTimes' ,...
             'OutputTimes','[0 5 10]', 'LoadInitialState', 'off');
y = out2.get('ScopeData');

%%
% Plot the results. The second half of the baseline result does not match the
% simulation from 5 to 10 seconds whose initial state was restored from the 
% final state saved at 5 seconds.
for i=1:3
    subplot(3, 1, i);
    plot(y.time,y.signals(1).values);
    hold on
    plot([y1.time; y2.time],[y1.signals(1).values;y2.signals(1).values], ...
        'rREPLACE_WITH_DASH_DASH');
end

%% Saving and Restoring the Complete SimState
% Simulink provides the option to save the complete final SimState in 
% Simulink.SimState object. The SimState object contains all of the variables
% needed to restore the simulation results. By saving the complete
% SimState, Simulink is able to restore the simulation completely and to
% produce the baseline simulation results. 

%%
% Set the parameter for Simulink to save the complete SimState at the
% end of the simulation.
out3 = sim(mdl, 'StopTime', '5', 'SaveFinalState', 'on', ...
          'LoadInitialState', 'off', 'SaveCompleteFinalSimState', 'on');
xFinal = out3.get('xFinal');
y1 = out3.get('ScopeData');

%%
% Load the SimState from the last simulation and run for an additional 5 seconds.
% There is no need to provide the start time; however, the value must remain zero. 
% The actual start time is stored in xFinal and will overwrite zero.
out4 = sim(mdl, 'StopTime', '10', 'SaveFinalState', 'off', ...
          'LoadInitialState', 'on', 'InitialState', 'xFinal');
y2 = out4.get('ScopeData');


%%
% Plot the results and compare them with the baseline simulation. The
% simulation state was completely restored and thus the SimState results match 
% the baseline.
clf;
for i=1:3
    subplot(3, 1, i);
    plot(y.time,y.signals(1).values);
    hold on
    plot([y1.time; y2.time],[y1.signals(1).values;y2.signals(1).values], ...
        'rREPLACE_WITH_DASH_DASH');
end

close_system(mdl, 0);
displayEndOfDemoMessage(mfilename)

##### SOURCE END #####
--></body></html>