
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Migration to Structure Parameters</title><meta name="generator" content="MATLAB 7.11"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2010-07-08"><meta name="DC.source" content="sldemo_applyVarStruct.m"><link rel="stylesheet" type="text/css" href="../../../../matlab/demos/private/style.css"></head><body><div class="header"><div class="left">sldemo_applyVarStruct.mdl</div><div class="right"><a href="matlab:sldemo_applyVarStruct">Open this model</a></div></div><div class="content"><h1>Migration to Structure Parameters</h1><!--introduction--><p>This demo illustrates the process of converting a Simulink&reg; model that is parameterized by unstructured workspace variables to a model that is parameterized by a MATLAB&reg; structure. The demo shows how to use Simulink utilities to organize model variables from the base workspace into a hierarchical structure and then apply the structure to the model.</p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Model Description</a></li><li><a href="#2">Demo Requirements</a></li><li><a href="#3">Typical Workflow</a></li><li><a href="#4">Collecting  Numeric Variables into a MATLAB Structure</a></li><li><a href="#8">Modifying the MATLAB Structure</a></li><li><a href="#9">Applying the  MATLAB Structure to the Model</a></li><li><a href="#11">Configuring the Structure Parameter to Appear in Generated Code</a></li></ul></div><h2>Model Description<a name="1"></a></h2><p>Open the demo model <a href="matlab:open_system('sldemo_applyVarStruct');"><tt>sldemo_applyVarStruct</tt></a>.</p><p>This model uses a number of numeric parameters from the base workspace.</p><img vspace="5" hspace="5" src="sldemo_applyVarStruct_01.png" alt=""> <h2>Demo Requirements<a name="2"></a></h2><p>This demo changes the original model and creates files in the current working directory. If you plan to save the demo models, save a copy in the current directory.</p><h2>Typical Workflow<a name="3"></a></h2><p>Migrating a model to use structure parameters follows these steps:</p><p>1. Collect all numeric variables used by the model into a MATLAB structure.</p><p>2. Modify the MATLAB structure (if necessary).</p><p>3. Apply the MATLAB structure to the model.</p><p>4. Configure the appearance of the parameter structure in the generated code (optional).</p><h2>Collecting  Numeric Variables into a MATLAB Structure<a name="4"></a></h2><p>You can use <b>Simulink.findVars</b> to find out what variables are used by the Simulink model.</p><pre>model = 'sldemo_applyVarStruct';
varList = Simulink.findVars(model, 'WorkspaceType', 'base')</pre><pre class="codeoutput">
varList = 

  20x1 Simulink.WorkspaceVar handle
  Package: Simulink

  Properties:
    Name
    Workspace
    WorkspaceType
    UsedByBlocks


</pre><pre>var = varList(1)</pre><pre class="codeoutput">
var = 

  Simulink.WorkspaceVar handle
  Package: Simulink

  Properties:
             Name: 'Ka'
        Workspace: 'base workspace'
    WorkspaceType: 'base'
     UsedByBlocks: {'sldemo_applyVarStruct/Controller/Gain3'}


</pre><p>You can use <b>Simulink.BlockDiagram.createVarStruct</b> to generate a MATLAB structure containing all numeric variables used by the model.</p><pre>ModelParam = Simulink.BlockDiagram.createVarStruct(model)</pre><pre class="codeoutput">
ModelParam = 

     Ka: 0.6770
     Kf: -1.7460
     Ki: -3.8640
     Kq: 0.8156
     Md: -6.8847
     Mq: -0.6571
     Mw: -0.0059
    Swg: 3
     Ta: 0.0500
    Tal: [0.3959 1]
     Ts: [0.1000 1]
     Uo: 689.4000
    Vto: 690.4000
     W1: [1 2.9710]
     W2: [1 4.1440]
     Zd: -63.9979
     Zw: -0.6385
      a: 2.5348
      b: 64.1300
      g: 32.2000

</pre><p>Variable <b>ModelParam</b> is a MATLAB structure that contains the numeric variables as fields (sorted by name).</p><p><b>NOTE:</b></p><div><ul><li>The model and all data that the model uses must be loaded before calling <b>Simulink.BlockDiagram.createVarStruct</b>.</li><li>Do not give MATLAB structure the same name as one of numeric variables.</li></ul></div><h2>Modifying the MATLAB Structure<a name="8"></a></h2><p>The original structure contains all the variables in one level of hierarchy. You can change the structure before applying it to the model. For example, reorder parameter fields, add extra levels to group model parameters, or add extra fields.</p><p><b>NOTE:</b></p><div><ul><li>Do not change the names of the leaf fields in the structure.</li><li>Do not clear the original variables until you have finished the migration process.</li></ul></div><p>1. One way to do this is to use <b>Simulink.saveVars</b> to write the structure to a MATLAB script and make changes in the file.</p><pre>Simulink.saveVars('sldemo_applyVarStruct_data.m','ModelParam')
edit sldemo_applyVarStruct_data.m</pre><p>2. Edit the MATLAB script as needed. For example, split the structure into two structures.</p><div><ul><li><b>'ControlParam'</b> contains all parameters for the Controller subsystem.</li><li><b>'ModelParam'</b> contains all other numeric parameters.</li></ul></div><pre>ControlParam = struct;
ControlParam.Ka = 0.677;
ControlParam.Kf = -1.746;
ControlParam.Ki = -3.864;
ControlParam.Kq = 0.8156;
ControlParam.Tal = [0.3959 1];
ControlParam.Ts = [0.1 1];
ControlParam.W1 = [1 2.971];
ControlParam.W2 = [1 4.144];</pre><pre>ModelParam = struct;
ModelParam.Md = -6.8847;
ModelParam.Mq = -0.6571;
ModelParam.Mw = -0.00592;
ModelParam.Swg = 3;
ModelParam.Ta = 0.05;
ModelParam.Uo = 689.4;
ModelParam.Vto = 690.4;
ModelParam.Zd = -63.9979;
ModelParam.Zw = -0.6385;
ModelParam.a = 2.5348;
ModelParam.b = 64.13;
ModelParam.g = 32.2;</pre><p>Save the modified data file. You can use it as a preload function.</p><p>3. Run the modified MATLAB script to create the MATLAB structures.</p><pre>sldemo_applyVarStruct_data;</pre><h2>Applying the  MATLAB Structure to the Model<a name="9"></a></h2><p>You can use <b>Simulink.BlockDiagram.applyVarStruct</b> to automatically replace the variable references in the block diagram by the equivalent structure references.</p><p>1. Apply the MATLAB structure to the model. The demo model will be changed. You can then save it to a writable directory.</p><pre>[applied,unapplied]=Simulink.BlockDiagram.applyVarStruct(model,'ControlParam')</pre><pre>[applied,unapplied]=Simulink.BlockDiagram.applyVarStruct(model,'ModelParam')</pre><p><b>NOTE:</b></p><div><ul><li>You can use <b>'preview'</b> ApplyMode to get information about what will be changed without actually changing the model:</li></ul></div><pre>Simulink.BlockDiagram.applyVarStruct(model,'ModelParam', 'ApplyMode', 'preview')</pre><div><ul><li>If the model has been compiled, you can use <b>'cached'</b> SearchMethod to avoid model recompiling:</li></ul></div><pre>Simulink.BlockDiagram.applyVarStruct(model,'ModelParam', 'SearchMethod', 'cached')</pre><div><ul><li>If <b>unapplied</b> output is not empty, you can investigate the reason using <b>Simulink.findVars(model,'WorkspaceType','base','Name',variableName).</b> The probable causes are: you changed structure field names or added extra fields; the variable is used by a block that needs special consideration, e.g., Stateflow&reg; chart, S-Function or Model block.</li></ul></div><p>2. Test the MATLAB structure in the modified model.</p><p>Clear unnecessary variables and run the simulation to check results.</p><pre>clear;
model = 'sldemo_applyVarStruct';
sldemo_applyVarStruct_data;</pre><pre>sim('sldemo_applyVarStruct');</pre><div><ul><li>Check for any warnings or errors.</li><li>Check simulation results.</li></ul></div><h2>Configuring the Structure Parameter to Appear in Generated Code<a name="11"></a></h2><p>By default, the MATLAB structure does not appear in generated code because numeric values are inlined. Code generation requires Real-Time Workshop&reg;.</p><p>1. To make the structure variable tunable, create <b>Simulink.Parameter</b> with the structure value and 'ExportedGlobal' storage class.</p><pre>p=Simulink.Parameter;
p.Value=ControlParam;
p.RTWInfo.StorageClass='ExportedGlobal';
ControlParam=p;
clear p;</pre><pre>rtwbuild('sldemo_applyVarStruct');</pre><p>The generated code now contains a structure type definition for the tunable structure in the <b>model_types.h</b> header file. By default, Real-Time Workshop generates an automatic name for the type of parameter structures. This name is unique, but not easy to recognize.</p><pre> typedef struct {
   real_T Ka;
   real_T Kf;
   real_T Ki;
   real_T Kq;
   real_T Tal[2];
   real_T Ts[2];
   real_T W1[2];
   real_T W2[2];
 } struct_mn4cJ7zsH8aqc8bBlbIkqC;</pre><p>2. You can control this type name by using <b>Simulink.Bus</b> to specify the data type of the Simulink.Parameter object.</p><p>You can use <b>Simulink.Bus.createObject</b> to create a bus object with the same shape as the MATLAB structure.</p><pre>busInfo=Simulink.Bus.createObject(ControlParam.Value)</pre><p>Assign the bus object name to the Simulink.Parameter DataType attribute.</p><pre>ParamType=eval(busInfo.busName);
ControlParam.DataType='Bus: ParamType';
clear(busInfo.busName);
clear busInfo;</pre><p><b>NOTE:</b> Only <b>Simulink.Parameter</b> can accept the bus object name as a data type. For MATLAB structures, Real-Time Workshop generates an automatic name for the type.</p><p>3. Resave the data file to include the modified workspace variables.</p><pre>Simulink.saveVars('sldemo_applyVarStruct_data.m', '-append')</pre><p>4. Regenerate code for the modified model (requires Real-Time Workshop).</p><pre>rtwbuild(model);</pre><p>The generated type definition now appears as:</p><pre>  typedef struct {
   real_T Ka;
   real_T Kf;
   real_T Ki;
   real_T Kq;
   real_T Tal[2];
   real_T Ts[2];
   real_T W1[2];
   real_T W2[2];
  } ParamType;</pre><p>The parameter definition is:</p><pre>  ParamType ControlParam = {
    0.677,
    -1.746,
    -3.864,
    0.8156,
    {0.3959, 1.0},
    {0.1, 1.0},
    {1.0, 2.971},
    {1.0, 4.144}
  }</pre><p class="footer">Copyright 2005-2010 The MathWorks, Inc.<br>
          Published with MATLAB&reg; 7.11</p><p class="footer" id="trademarks">MATLAB and Simulink are registered trademarks of The MathWorks, Inc.  Please see <a href="http://www.mathworks.com/trademarks">www.mathworks.com/trademarks</a> for a list of other trademarks owned by The MathWorks, Inc.  Other product or brand names are trademarks or registered trademarks of their respective owners.</p></div><!--
##### SOURCE BEGIN #####
%% Migration to Structure Parameters
% This demo illustrates the process of converting a Simulink(R) model that 
% is parameterized by unstructured workspace variables to a model that is
% parameterized by a MATLAB(R) structure. The demo shows how to use 
% Simulink utilities to organize model variables from the base workspace
% into a hierarchical structure and then apply the structure to the model.

% Copyright 2005-2010 The MathWorks, Inc.
% $Revision: 1.1.6.2.2.1 $  $Date: 2010/06/07 13:34:20 $

%% Model Description
% Open the demo model <matlab:open_system('sldemo_applyVarStruct'); |sldemo_applyVarStruct|>.
% 
% This model uses a number of numeric parameters from the base workspace.
model = 'sldemo_applyVarStruct';
open_system(model);

%% Demo Requirements 
% This demo changes the original model and creates files in the current
% working directory.
% If you plan to save the demo models, save a copy in the current directory.
%

%% Typical Workflow
% Migrating a model to use structure parameters follows these steps:
%
% 1. Collect all numeric variables used by the model into a MATLAB structure.
%
% 2. Modify the MATLAB structure (if necessary).
%
% 3. Apply the MATLAB structure to the model.
%
% 4. Configure the appearance of the parameter structure
% in the generated code (optional).

%% Collecting  Numeric Variables into a MATLAB Structure
% You can use *Simulink.findVars* to find out what variables are used by 
% the Simulink model.
%
%  model = 'sldemo_applyVarStruct'; 
%  varList = Simulink.findVars(model, 'WorkspaceType', 'base')
varList=Simulink.findVars(model,'WorkspaceType', 'base')

%%
%  var = varList(1)
var=varList(1)

%%
% You can use *Simulink.BlockDiagram.createVarStruct* to generate 
% a MATLAB structure containing all numeric variables used by the model.
%
%  ModelParam = Simulink.BlockDiagram.createVarStruct(model)
%
ModelParam = Simulink.BlockDiagram.createVarStruct(model)

%%
% Variable *ModelParam* is a MATLAB structure that contains the numeric variables as fields
% (sorted by name).
%
% *NOTE:* 
%
% * The model and all data that the model uses must be loaded before
% calling *Simulink.BlockDiagram.createVarStruct*. 
% * Do not give MATLAB structure the same name as one of numeric variables.
%

%% Modifying the MATLAB Structure
% The original structure contains all the variables in one level of hierarchy.
% You can change the structure before applying it to the model.
% For example, reorder parameter fields, add extra levels
% to group model parameters, or add extra fields.
%
% *NOTE:*
%
% * Do not change the names of the leaf fields in the structure. 
% * Do not clear the original variables until you have finished the migration process.
%
% 1. One way to do this is to use *Simulink.saveVars* to write the structure 
% to a MATLAB script and make changes in the file. 
%
%  Simulink.saveVars('sldemo_applyVarStruct_data.m','ModelParam')
%  edit sldemo_applyVarStruct_data.m
%
% 2. Edit the MATLAB script as needed. For example,
% split the structure into two structures.
%
% * *'ControlParam'* contains all parameters for the Controller subsystem.
% * *'ModelParam'* contains all other numeric parameters.
%
%  ControlParam = struct;
%  ControlParam.Ka = 0.677;
%  ControlParam.Kf = -1.746;
%  ControlParam.Ki = -3.864;
%  ControlParam.Kq = 0.8156;
%  ControlParam.Tal = [0.3959 1];
%  ControlParam.Ts = [0.1 1];
%  ControlParam.W1 = [1 2.971];
%  ControlParam.W2 = [1 4.144];
%
%  ModelParam = struct;
%  ModelParam.Md = -6.8847;
%  ModelParam.Mq = -0.6571;
%  ModelParam.Mw = -0.00592;
%  ModelParam.Swg = 3;
%  ModelParam.Ta = 0.05;
%  ModelParam.Uo = 689.4;
%  ModelParam.Vto = 690.4;
%  ModelParam.Zd = -63.9979;
%  ModelParam.Zw = -0.6385;
%  ModelParam.a = 2.5348;
%  ModelParam.b = 64.13;
%  ModelParam.g = 32.2;
%
% Save the modified data file. You can use it as a preload function.
%
% 3. Run the modified MATLAB script to create the MATLAB structures.
%
%  sldemo_applyVarStruct_data;
%

%% Applying the  MATLAB Structure to the Model
% You can use *Simulink.BlockDiagram.applyVarStruct*
% to automatically replace the variable references in the block diagram 
% by the equivalent structure references.
%
% 1. Apply the MATLAB structure to the model.
% The demo model will be changed. You can then save it to a writable directory.
% 
%  [applied,unapplied]=Simulink.BlockDiagram.applyVarStruct(model,'ControlParam')
% 
%  [applied,unapplied]=Simulink.BlockDiagram.applyVarStruct(model,'ModelParam') 
%
Simulink.BlockDiagram.applyVarStruct(model,'ModelParam');

%%
% *NOTE:*
%
% * You can use *'preview'* ApplyMode to get information 
% about what will be changed without actually changing the model:
%
%  Simulink.BlockDiagram.applyVarStruct(model,'ModelParam', 'ApplyMode', 'preview')
%
% * If the model has been compiled, you can use *'cached'* SearchMethod to avoid
% model recompiling: 
%
%  Simulink.BlockDiagram.applyVarStruct(model,'ModelParam', 'SearchMethod', 'cached')
%
% * If *unapplied* output is not empty, you can investigate the reason 
% using *Simulink.findVars(model,'WorkspaceType','base','Name',variableName).*
% The probable causes are: you changed structure field names or added extra fields;
% the variable is used by a block that needs special consideration, 
% e.g., Stateflow(R) chart, S-Function or Model block.
% 
% 2. Test the MATLAB structure in the modified model.
% 
% Clear unnecessary variables and run the simulation to check results.
%
%  clear;
%  model = 'sldemo_applyVarStruct'; 
%  sldemo_applyVarStruct_data;
% 
%  sim('sldemo_applyVarStruct');
%
% * Check for any warnings or errors.
% * Check simulation results.
%
clear -regexp ^(?!model|ModelParam|ControlParam).;
evalc('sim(model);');

%% Configuring the Structure Parameter to Appear in Generated Code
%
% By default, the MATLAB structure does not appear in generated code because
% numeric values are inlined. Code generation requires Real-Time Workshop(R).
%
% 1. To make the structure variable tunable, create *Simulink.Parameter*
% with the structure value and 'ExportedGlobal' storage class. 
%
%  p=Simulink.Parameter;
%  p.Value=ControlParam;
%  p.RTWInfo.StorageClass='ExportedGlobal';
%  ControlParam=p;
%  clear p;
%
%  rtwbuild('sldemo_applyVarStruct');
%
tmp=ModelParam;
p=Simulink.Parameter;
p.Value=ModelParam;
p.RTWInfo.StorageClass='ExportedGlobal';
ModelParam=p;
clear p;

origPath = path();
workDir = tempname;
mkdir(workDir);
origDir = cd(workDir);
addpath(origDir);

evalc('rtwbuild(model);');

%%
% The generated code now contains a structure type definition 
% for the tunable structure in the *model_types.h* header file.
% By default, Real-Time Workshop generates an automatic name for 
% the type of parameter structures. This name is unique, but 
% not easy to recognize.
%
%   typedef struct {
%     real_T Ka;
%     real_T Kf;
%     real_T Ki;
%     real_T Kq;
%     real_T Tal[2];
%     real_T Ts[2];
%     real_T W1[2];
%     real_T W2[2];
%   } struct_mn4cJ7zsH8aqc8bBlbIkqC;
% 
% 2. You can control this type name by using *Simulink.Bus*
% to specify the data type of the Simulink.Parameter object.
%
% You can use *Simulink.Bus.createObject* to create a bus object
% with the same shape as the MATLAB structure.
%
%  busInfo=Simulink.Bus.createObject(ControlParam.Value)
% 
busInfo=Simulink.Bus.createObject(ModelParam.Value);

%%
% Assign the bus object name to the Simulink.Parameter DataType attribute.
%
%  ParamType=eval(busInfo.busName); 
%  ControlParam.DataType='Bus: ParamType';
%  clear(busInfo.busName); 
%  clear busInfo;
%
% *NOTE:* Only *Simulink.Parameter* can accept the bus object name as a data type.
% For MATLAB structures, Real-Time Workshop generates 
% an automatic name for the type. 
%
% 3. Resave the data file to include the modified workspace variables.
%
%  Simulink.saveVars('sldemo_applyVarStruct_data.m', '-append')
%
% 4. Regenerate code for the modified model (requires Real-Time Workshop).
% 
%  rtwbuild(model);
%
ParamType=eval(busInfo.busName); 
ModelParam.DataType='Bus: ParamType';
clear(busInfo.busName); 
clear busInfo;

evalc('rtwbuild(model);');

%%
% The generated type definition now appears as:
%
%    typedef struct {
%     real_T Ka;
%     real_T Kf;
%     real_T Ki;
%     real_T Kq;
%     real_T Tal[2];
%     real_T Ts[2];
%     real_T W1[2];
%     real_T W2[2];
%    } ParamType;
%
% The parameter definition is:
%
%    ParamType ControlParam = {
%      0.677,
%      -1.746,
%      -3.864,
%      0.8156,
%      {0.3959, 1.0},
%      {0.1, 1.0},
%      {1.0, 2.971},
%      {1.0, 4.144}
%    } 

%%
cd(origDir);
path(origPath);
bdclose all;
rmdir(workDir, 's');
clear;
 

##### SOURCE END #####
--></body></html>