
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!-- This HTML was auto-generated from MATLAB code. To make changes, update the MATLAB code and republish this document.       --><title>Simulink モデルと生成したコードから外部 C コードの呼び出し</title><meta name="generator" content="MATLAB 7.11"><link rel="schema.DC" href="../http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2010-05-27"><meta name="DC.source" content="rtwdemo_pcgd_stage_4_p1.m"><link rel="stylesheet" type="text/css" href="../../../../matlab/demos/private/style.css"></head><body><div class="header"><div class="left"><a href="matlab:edit rtwdemo_pcgd_stage_4_p1">エディターで rtwdemo_pcgd_stage_4_p1.m を開く</a></div><div class="right"><a href="matlab:echodemo rtwdemo_pcgd_stage_4_p1">コマンド ウィンドウで実行</a></div></div><div class="content"><h1>Simulink モデルと生成したコードから外部 C コードの呼び出し</h1><!--introduction--><p><b>概要:</b>外部関数を呼び出すための方法として Legacy Code Tool を紹介します。Legacy Code Tool を使用すると、シミュレーション内や生成コード内から外部関数を呼び出すことができます。</p><p><b>所要時間: </b>45 分</p><p><b>目的</b></p><p>理解する内容は次のとおりです。</p><div><ul><li>Simulink モデル シミュレーションの一部である C 関数の評価方法</li><li>Real-Time Workshop で生成したコードからの C 関数の呼び出し方法</li></ul></div><p><a href="matlab:RTWDemos.pcgd_open_pcg_model(4,0);"><b>タスク: </b> モデルを開きます。</a></p><!--/introduction--><h2>目次</h2><div><ul><li><a href="#1">置換プロセス</a></li><li><a href="#2">C 関数を呼び出すブロックの作成</a></li><li><a href="#3">Simulink 環境での外部コードの確認</a></li><li><a href="#4">Simulink モデルの一部である C コードの確認</a></li><li><a href="#5">生成コードからの C 関数 の呼び出し</a></li><li><a href="#6">一歩進んだ学習トピック</a></li></ul></div><h2>置換プロセス<a name="1"></a></h2><p>Simulink&reg; モデルはモデル ベース デザインの一部です。多くのアプリケーションの設計には、試験によって確認ずみの既存の C 関数のセットも含まれています。これらの関数を Simulink モデルと生成コードに容易に統合できることは、Simulink を使用して制御を開発するプロセスにおいて非常に重要です。</p><p>このモジュールでは既存の C 関数を呼び出すカスタム Simulink ブロックの作成方法を紹介します。そのブロックがモデルの一部であれば、シミュレーション環境の利点を生かしてシステムのより高度な試験をすることができます。</p><p>例として、PI コントローラーの Lookup ブロック (ルックアップ テーブル) は既存の C 関数の呼び出しで置き換えられます。この関数はファイル <tt>SimpleTable.c</tt> と <tt>SimpleTable.h</tt> で定義されています。</p><p><a href="matlab:edit(fullfile(matlabroot,'toolbox','rtw','rtwdemos','EmbeddedCoderOverview','stage_4_files','SimpleTable.c'))"><b>タスク: </b><tt>SimpleTable.c</tt> を表示します。</a></p><p><a href="matlab:edit(fullfile(matlabroot,'toolbox','rtw','rtwdemos','EmbeddedCoderOverview','stage_4_files','SimpleTable.h'))"><b>タスク: </b><tt>SimpleTable.h</tt> を表示します。</a></p><p><img vspace="5" hspace="5" src="../replace_sim_with_external.jpg"></p><h2>C 関数を呼び出すブロックの作成<a name="2"></a></h2><p>既存の C 関数の呼び出しを指定するには、S-Function ブロックを使用します。Simulink Legacy Code Tool を使用すると、S-Function ブロックの作成プロセスを自動化することができます。このツールを使用して、既存の C 関数とのインターフェイスを指定します。そして、S-Function ブロックの作成を自動化するインターフェイスを使用します。</p><p>以下のステップ 1 ～ 6 を完了して、既存の C 関数 <tt>SimpleTable.c</tt> 用の S-Function ブロックを作成します。Legacy Code Tool の使用方法の詳細は、このモジュールの最後にリンクされています。</p><p>1. <a href="matlab:RTWDemos.pcgd_LCT(1)"><b>タスク: </b> 関数インターフェイス定義構造体を作成します。</a></p><p><tt>def=legacy_code('initialize')</tt></p><p>データ構造体 <tt>def</tt> は既存の C コードに対する関数インターフェイスを定義します。</p><p>2. <a href="matlab:RTWDemos.pcgd_LCT(2)"><b>タスク: </b> 関数インターフェイス定義構造体を配置します。</a></p><p><img vspace="5" hspace="5" src="../defineFunctionInterface.jpg"></p><p>3. <a href="matlab:RTWDemos.pcgd_LCT(3)"><b>タスク: </b> S-function を作成します。</a></p><p><tt>legacy_code('sfcn_cmex_generate',def)</tt></p><p>4. <a href="matlab:RTWDemos.pcgd_LCT(4)"><b>タスク: </b> S-function をコンパイルします。</a></p><p><tt>legacy_code('compile',def)</tt></p><p>5. <a href="matlab:RTWDemos.pcgd_LCT(5)"><b>タスク: </b> S-Function ブロックを作成します。</a></p><p><tt>legacy_code('slblock_generate',def)</tt></p><p>S-function の作成は 1 回だけのタスクです。1 回ブロックを作成すれば、どのモデルにも再利用できます。</p><p>6. <a href="matlab:RTWDemos.pcgd_LCT(6)"><b>タスク: </b> TLC ファイルを作成します。</a></p><p><tt>legacy_code('sfcn_tlc_generate',def)</tt></p><p>ステップ 1 ～ 5 で、シミュレーション中の各時間ステップに指定した関数を呼び出す S-function ブロックが作成されました。ステップ 6 では TLC ファイルを作成します。このファイルは Real-Time Workshop&reg; によるブロック用コードの生成方法を指定する S-Function のコンポーネントです。</p><h2>Simulink 環境での外部コードの確認<a name="3"></a></h2><p>既存の C コードを Simulink モデルと統合した場合は、必ず結果を確認してください。</p><p>この例では、Lookup ブロックを既存の C 関数で置き換えます。置換を確認するために、Lookup ブロックで生成されたシミュレーション結果を新しい S-Function ブロックで生成された結果と比較します。</p><p>1. <a href="matlab:RTWDemos.pcgd_open_pcg_model(2,3);"><b>タスク: </b> 確認モデルを開きます。</a></p><div><ul><li>Sine Wave ブロックは範囲が [-2 : 2] の出力値を生成します。2].</li><li>ルックアップ テーブルの入力範囲は [-1 : 1] です。1].</li><li>ルックアップ テーブルからの出力は入力の絶対値です。</li><li>ルックアップ テーブルの出力は、入力の限界値で出力を切り取ります。</li></ul></div><p>2. <a href="matlab:sim(pcgDemoData.helper{2})"><b>タスク: </b> 確認モデルを実行します。</a></p><p>次の図に確認結果を示します。既存の C 関数と Simulink テーブル ブロックとで、出力値が同じになっていることに注意してください。</p><p><img vspace="5" hspace="5" src="../S_Fun_Validate.jpg"></p><h2>Simulink モデルの一部である C コードの確認<a name="4"></a></h2><p>既存の C 関数コードの機能を独立したコンポーネントとして確認した後で、モデルの S-function を確認します。テスト ハーネス モデルを使用して確認作業を完了します。</p><p>1. <a href="matlab:RTWDemos.pcgd_open_pcg_model(4,1);"><b>タスク: </b> テスト ハーネスを開きます。</a></p><p>2. <a href="matlab:RTWDemos.pcgd_runTestHarn(1,4)"><b>タスク: </b> テスト ハーネスを実行します。</a></p><p>シミュレーション結果は期待されるゴールデン値と一致しています。</p><p><img vspace="5" hspace="5" src="../FirstPassTest.jpg"></p><h2>生成コードからの C 関数の呼び出し<a name="5"></a></h2><p>Real-Time Workshop は、S-Function ブロックをシステムの他のブロックと同様に処理するために、TLC ファイルを使用します。S-Function ブロックの C コードを呼び出すと、次のようになります。</p><div><ul><li>データ オブジェクトを使用できます。</li><li><i></i>畳み込み表現、つまり複数の計算を単一の出力計算にまとめる操作が行われます。</li></ul></div><p>1. <a href="matlab:RTWDemos.pcgd_buildDemo(4,0)"><b>タスク: </b> フル モデルをビルドします。</a></p><p>2. <a href="matlab:RTWDemos.pcgd_showSection(4,'Reusable');"><b>タスク: </b>生成コード (<tt>PI_Control_Reusable.c</tt>) を調べます。</a></p><p>生成コードは C 関数 <tt>SimpleTable</tt> を呼び出します。</p><p>次の図に、C コードを統合する前後の生成コードを示します。統合前は、生成コードは <tt>rt_Lookup</tt> を呼び出しました。統合後は、生成コードは C 関数 <tt>SimpleTable</tt> を呼び出します。</p><p><img vspace="5" hspace="5" src="../original_table_call.jpg"></p><p><img vspace="5" hspace="5" src="../external_scheduler.jpg"></p><h2>一歩進んだ学習トピック<a name="6"></a></h2><div><ul><li><a href="matlab:helpview([docroot,'/toolbox/simulink/helptargets.map'],'legacy_code_tool');">Legacy Code Tool の利用</a></li><li><a href="matlab:helpview([docroot,'/toolbox/rtw/helptargets.map'],'write_sfunctions');">コード生成で使用する S-function の記述方法</a></li></ul></div><p class="footer">Copyright 2007-2008 The MathWorks, Inc.<br>Published with MATLAB&reg; 7.11</p><p class="footer" id="trademarks">MATLAB and Simulink are registered trademarks of The MathWorks, Inc.  Please see <a href="http://www.mathworks.com/trademarks">www.mathworks.com/trademarks</a> for a list of other trademarks owned by The MathWorks, Inc.  Other product or brand names are trademarks or registered trademarks of their respective owners.</p></div><!-- ##### SOURCE BEGIN ##### %% Calling External C Code from the Simulink Model and Generated Code % *Overview:* Introduces the Legacy Code Tool as a method for calling % external functions.  The Legacy Code Tool enables you to call the % external function from within the simulation and in the generated code. % % *Time:* 45 minutes % % *Goals* % % Understand... %  % * How to evaluate a C function as part of a Simulink model simulation % * How to call a C function from code generated by Real-Time Workshop % % <matlab:RTWDemos.pcgd_open_pcg_model(4,0); *Task:* Open the model.>  %% Replacement Process % Simulink(R) models are one part of Model-Based Design. % For many applications, a design also includes a set of existing C functions  % that have been tested and validated. The ability to easily integrate  % these functions into a Simulink model and generated code is % critical to using Simulink in the controls development process. % % This module demonstrates how to create a custom Simulink block that  % calls an existing C function.  Once the block is part of the model, you % can take advantage of the simulation environment to further test the system. % % As an example, the Lookup blocks (lookup tables) in the PI controllers are  % replaced with calls to an existing C function.  The function is defined in the % files |SimpleTable.c| and |SimpleTable.h|. %  % <matlab:edit(fullfile(matlabroot,'toolbox','rtw','rtwdemos','EmbeddedCoderOverview','stage_4_files','SimpleTable.c')) *Task:* View |SimpleTable.c|.>  % % <matlab:edit(fullfile(matlabroot,'toolbox','rtw','rtwdemos','EmbeddedCoderOverview','stage_4_files','SimpleTable.h')) *Task:* View |SimpleTable.h|.> % % <html><img vspace="5" hspace="5" src="../replace_sim_with_external.jpg"></html> % %% Creating a Block That Calls a C Function % To specify a call to an existing C function, you use an S-Function block. % You can automate the process of creating the S-Function block by using the  % Simulink Legacy Code Tool. Using this tool, you specify an interface for your % existing C function. The tool then uses that interface to automate creation  % of an S-Function block.  %  % Complete steps 1 through 6 below to create an S-Function block for an existing  % C function |SimpleTable.c|. A link to more information on using the % Legacy Code Tool is provided at the end of this module. % % 1. <matlab:RTWDemos.pcgd_LCT(1) *Task:* Create the function interface definition structure.> % % |def=legacy_code('initialize')|  % % The data structure |def| defines the function interface to the existing C % code. % % 2. <matlab:RTWDemos.pcgd_LCT(2) *Task:* Populate the function interface definition % structure.> % % <html><img vspace="5" hspace="5" src="../defineFunctionInterface.jpg"></html> % % 3. <matlab:RTWDemos.pcgd_LCT(3) *Task:* Create the S-function.> % % |legacy_code('sfcn_cmex_generate',def)| % % 4. <matlab:RTWDemos.pcgd_LCT(4) *Task:* Compile the S-function.>   % % |legacy_code('compile',def)|  % % 5. <matlab:RTWDemos.pcgd_LCT(5) *Task:* Create the S-Function block.> %  % |legacy_code('slblock_generate',def)| % % S-function creation is a one-time task.  Once the block exists, you can reuse % it in any model. % % 6. <matlab:RTWDemos.pcgd_LCT(6) *Task:* Create the TLC file.>  % % |legacy_code('sfcn_tlc_generate',def)| %  % Steps 1 through 5 created an S-function block that calls the  % specified function at each time step during simulation.  Step 6 creates a TLC % file, which is the component of an S-Function that specifies how  % Real-Time Workshop(R) generates code for the block.   % %% Validating the External Code in the Simulink Environment % When you integrate existing C code with a Simulink model, % always validate the results.  %  % In this example, you replace Lookup blocks with an existing C function.  % To validate the replacement, you compare simulation results produced with the  % Lookup block with results produced with the new S-Function block.  % % 1. <matlab:RTWDemos.pcgd_open_pcg_model(2,3); *Task:* Open the validation model.> % % * The Sine Wave block produces output values from [-2 : 2]. % * The input range of the lookup table is from [-1 : 1]. % * The output from the lookup table is the absolute value of the input. % * The lookup table output clips the output at the input limits.  % % 2. <matlab:sim(pcgDemoData.helper{2}) *Task:* Run the validation model.> %  % The following figure shows the validation results. Note that the existing C code  % and the Simulink table block provide the same output values.   % % <html><img vspace="5" hspace="5" src="../S_Fun_Validate.jpg"></html> % %% Validating the C Code as Part of the Simulink Model % After you validate the functionality of the existing C function code as a % standalone component, validate the S-function in the model.  Use the % test harness model to complete the validation. % % 1. <matlab:RTWDemos.pcgd_open_pcg_model(4,1); *Task:* Open the test harness.>  % % 2. <matlab:RTWDemos.pcgd_runTestHarn(1,4) *Task:* Run the test harness.> % % The simulation results match the expected golden values: % % <html><img vspace="5" hspace="5" src="../FirstPassTest.jpg"></html> % %% Calling the C Function from the Generated Code % Real-Time Workshop uses the TLC file to process the S-Function block  % like any other block in the system.  Calls to the C code of the S-Function block: % % * Can use data objects % * Are subject to _expression folding_, an operation that combines  % multiple computations into a single output calculation % % 1. <matlab:RTWDemos.pcgd_buildDemo(4,0) *Task:* Build the full model.> % % 2. <matlab:RTWDemos.pcgd_showSection(4,'Reusable'); *Task:* Examine the generated code % (|PI_Control_Reusable.c|).>  %   % The generated code now calls the |SimpleTable| C function. % % The following figures show the generated code before and after the C code % integration. Before the integration, the generated code called % |rt_Lookup|. After the integration, the generated code calls the C % function |SimpleTable|. % % <html><img vspace="5" hspace="5" src="../original_table_call.jpg"></html> % % <html><img vspace="5" hspace="5" src="../external_scheduler.jpg"></html> % %% Further Study Topics % % * <matlab:helpview([docroot,'/toolbox/simulink/helptargets.map'],'legacy_code_tool'); Using the Legacy Code Tool> % * <matlab:helpview([docroot,'/toolbox/rtw/helptargets.map'],'write_sfunctions'); Writing S-functions for use in code generation>  %   Copyright 2007-2008 The MathWorks, Inc.  displayEndOfDemoMessage(mfilename)  ##### SOURCE END ##### --></body></html>