
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!-- This HTML was auto-generated from MATLAB code. To make changes, update the MATLAB code and republish this document.       --><title>固定小数点の燃料比制御装置</title><meta name="generator" content="MATLAB 7.11"><link rel="schema.DC" href="../http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2010-05-27"><meta name="DC.source" content="rtwdemo_fuelsys_fxp_publish.m"><link rel="stylesheet" type="text/css" href="../../../../matlab/demos/private/style.css"></head><body><div class="header"><div class="left"><a href="matlab:edit rtwdemo_fuelsys_fxp_publish">エディターで rtwdemo_fuelsys_fxp_publish.m を開く</a></div><div class="right"><a href="matlab:echodemo rtwdemo_fuelsys_fxp_publish">コマンド ウィンドウで実行</a></div></div><div class="content"><h1>固定小数点の燃料比制御装置</h1><!--introduction--><p>このデモでは、Simulink&reg; と Stateflow&reg; を使用して設計された固定小数点の燃料比制御装置のコードを生成し、最適化します。モデルの詳細は、<a href="matlab:showdemo('sldemo_fuelsys')">sldemo_fuelsys</a> と <a href="matlab:showdemo('fxpdemo_fuelsys_publish')">fxpdemo_fuelsys</a> を参照してください。このデモでは Real-Time Workshop&reg; Embedded Coder™ (ERT ターゲット) を使用しますが、その概念は Real-Time Workshop にも当てはまります。</p><!--/introduction--><h2>目次</h2><div><ul><li><a href="#1">モデルの関連部分の理解</a></li><li><a href="#12">等間隔の 2 のべき乗のブレークポイントでコードを最適化</a></li><li><a href="#16">Pumping Constant の 2 のべき乗の間隔</a></li><li><a href="#17">圧力推定の 2 のべき乗の間隔</a></li><li><a href="#18">速度推定の 2 のべき乗の間隔</a></li><li><a href="#19">スロットル推定の 2 のべき乗の間隔</a></li><li><a href="#20">Ramp Rate Ki の 2 のべき乗の間隔</a></li><li><a href="#31">おわりに</a></li><li><a href="#32">関連デモ</a></li></ul></div><h2>モデルの関連部分の理解<a name="1"></a></h2><p>図 1 ～ 4 は、&quot;プラント&quot; と &quot;コントローラー&quot; を含む閉ループ システムである sldemo_fuelsys モデルの関連部分を示しています。プラントは、設計の初期段階でのシミュレーション時にコントローラーを検証するために使用します。この例では、関連するコントローラー サブシステム &quot;fuel_rate_control&quot; のコードを生成します。図 1 は、最上位のシミュレーション モデルを示しています。</p><pre class="codeinput"><span class="comment">% Open sldemo_fuelsys via rtwdemo_fuelsys_fxp and compile the diagram to</span>
<span class="comment">% view the signal data types.</span>
rtwdemo_fuelsys_fxp;

sldemo_fuelsys([],[],[],<span class="string">'compile'</span>);
sldemo_fuelsys([],[],[],<span class="string">'term'</span>);
</pre><img vspace="5" hspace="5" src="../rtwdemo_fuelsys_fxp_publish_01.png" alt=""> <p><b>図 1:&quot;プラント&quot; と &quot;コントローラー&quot; の最上位モデル</b></p><p>燃料比制御装置は Simulink および Stateflow ブロックで構成されており、これからコードを生成するモデルの一部分です。</p><pre class="codeinput">open_system(<span class="string">'sldemo_fuelsys/fuel_rate_control'</span>);
</pre><img vspace="5" hspace="5" src="../rtwdemo_fuelsys_fxp_publish_02.png" alt=""> <p><b>図 2:燃料比コントローラー サブシステム</b></p><p>吸入空気流量の推定および閉ループ訂正システムには、2 つのルックアップ テーブル Pumping Constant および Ramp Rate Ki が含まれています。このデモでコードを生成した後、最適化するときに、これらのルックアップ テーブルを参照します。</p><pre class="codeinput">open_system(<span class="string">'sldemo_fuelsys/fuel_rate_control/airflow_calc'</span>);
</pre><img vspace="5" hspace="5" src="../rtwdemo_fuelsys_fxp_publish_03.png" alt=""> <p><b>図 3:airflow_calc サブシステム</b></p><p>制御ロジックは、さまざまな動作モードを指定する Stateflow チャートです。</p><pre class="codeinput">open_system(<span class="string">'sldemo_fuelsys/fuel_rate_control/control_logic'</span>);
</pre><img vspace="5" hspace="5" src="../rtwdemo_fuelsys_fxp_publish_04.png" alt=""> <p><b>図 4:燃料比コントローラー ロジック</b></p><p>ここで、たくさん表示されているウィンドウを閉じましょう。</p><pre class="codeinput">close_system(<span class="string">'sldemo_fuelsys/fuel_rate_control/airflow_calc'</span>);
close_system(<span class="string">'sldemo_fuelsys/fuel_rate_control/fuel_calc'</span>);
close_system(<span class="string">'sldemo_fuelsys/fuel_rate_control/control_logic'</span>);
hDemo.rt=sfroot;hDemo.m=hDemo.rt.find(<span class="string">'-isa'</span>,<span class="string">'Simulink.BlockDiagram'</span>);
hDemo.c=hDemo.m.find(<span class="string">'-isa'</span>,<span class="string">'Stateflow.Chart'</span>,<span class="string">'-and'</span>,<span class="string">'Name'</span>,<span class="string">'control_logic'</span>);
hDemo.c.visible=false;
close_system(<span class="string">'sldemo_fuelsys/fuel_rate_control'</span>);
</pre><p>燃料比制御装置のみをビルドしましょう。コード生成処理が完了すると、生成コードの詳細を示す HTML 形式のレポートが自動的に表示されます。コードの本体部分は fuel_rate_control.c にあります。</p><pre class="codeinput">rtwbuild(<span class="string">'sldemo_fuelsys/fuel_rate_control'</span>);
</pre><pre class="codeoutput">### Starting Real-Time Workshop build procedure for model:fuel_rate_control
### Successful completion of Real-Time Workshop build procedure for model:fuel_rate_control
</pre><p>図 5 は、ルックアップ テーブル <a href="matlab:rtwdemo_fuelsys_fxp,hilite_system(sprintf('sldemo_fuelsys/fuel_rate_control/airflow_calc/Pumping%sConstant',char(32)))">Pumping Constant</a> に対する生成コードの一部を示しています。</p><p>Pumping Constant のコードを表示するには、ブロックを右クリックして <b>[Real-Time Workshop] &gt; [コードに移動...]</b> をクリックします。</p><pre class="codeinput">rtwtrace(<span class="string">'sldemo_fuelsys/fuel_rate_control/airflow_calc/Pumping Constant'</span>);
</pre><p>pumping constant のコードには、2 つのブレークポイント検索と 2D 内挿が含まれます。SpeedVect ブレークポイントが等間隔ではないのに対して、PressVect ブレークポイントは等間隔ですが、どちらも 2 のべき乗の間隔をとりません。除算を含む追加コード (ROM) が必要となり、すべてのブレークポイントがメモリ (RAM) 内にあることが必要となります。</p><p><img vspace="5" hspace="5" src="../rtwdemo_fuelsys_fxp_uneven_lookup_c1.jpg" alt=""> </p><p><img vspace="5" hspace="5" src="../rtwdemo_fuelsys_fxp_uneven_lookup_c2.jpg" alt=""> </p><p><img vspace="5" hspace="5" src="../rtwdemo_fuelsys_fxp_uneven_lookup_c3.jpg" alt=""> </p><p><img vspace="5" hspace="5" src="../rtwdemo_fuelsys_fxp_uneven_lookup_d1.jpg" alt=""> </p><p><b>図 5:Pumping Constant ルックアップ用の生成コード (等間隔でないブレークポイントを含む)</b></p><h2>等間隔の 2 のべき乗のブレークポイントでコードを最適化<a name="12"></a></h2><p>等間隔の 2 のべき乗のブレークポイントを使用して、生成コードのパフォーマンスを最適化できます。この例では、既存の測定データに基づいて燃料比制御装置のルックアップ テーブル データを再マッピングします。</p><p>モデルがその PostLoadFcn を介して読み込まれると、ルックアップ テーブル データはモデル ワークスペースに読み込まれます。オリジナルのテーブル データを sldemo_fuelsys_data を介して取得し、等間隔の 2 のべき乗になるように変更し、モデル ワークスペースに再び割り当てます。</p><pre class="codeinput">td = sldemo_fuelsys_data(<span class="string">'sldemo_fuelsys'</span>, <span class="string">'get_table_data'</span>);
</pre><p>等間隔の 2 のべき乗のブレークポイントに対する新しいテーブル データを計算</p><pre class="codeinput">ntd.SpeedVect   = 64 :2^5 : 640;             <span class="comment">% 32 rad/sec</span>
ntd.PressVect   = 2*2^-5 :2^-5 : 1-(2*2^-5); <span class="comment">% 0.03 bar</span>
ntd.ThrotVect   = 0:2^1:88;                   <span class="comment">% 2 deg</span>
ntd.RampRateKiX = 128:2^7:640;                <span class="comment">% 128 rad/sec</span>
ntd.RampRateKiY = 0:2^-2:1;                   <span class="comment">% 0.25 bar</span>
</pre><p>テーブル データの再マッピング</p><pre class="codeinput">ntd.PumpCon  = interp2(td.PressVect,td.SpeedVect,td.PumpCon, ntd.PressVect',ntd.SpeedVect);
ntd.PressEst = interp2(td.ThrotVect,td.SpeedVect,td.PressEst,ntd.ThrotVect',ntd.SpeedVect);
ntd.SpeedEst = interp2(td.PressVect,td.ThrotVect,td.SpeedEst,ntd.PressVect',ntd.ThrotVect);
ntd.ThrotEst = interp2(td.PressVect,td.SpeedVect,td.ThrotEst,ntd.PressVect',ntd.SpeedVect);
</pre><p>Ramp Rate テーブル データの再計算</p><pre class="codeinput">ntd.RampRateKiZ = (1:length(ntd.RampRateKiX))' * (1:length(ntd.RampRateKiY)) * td.Ki;
</pre><h2>Pumping Constant の 2 のべき乗の間隔<a name="16"></a></h2><pre class="codeinput">figure(<span class="string">'Tag'</span>,<span class="string">'CloseMe'</span>);
mesh(td.PressVect,td.SpeedVect,td.PumpCon), hold <span class="string">on</span>
mesh(ntd.PressVect,ntd.SpeedVect,ntd.PumpCon)
xlabel(<span class="string">'PressVect'</span>), ylabel(<span class="string">'SpeedVect'</span>), zlabel(<span class="string">'PumpCon'</span>)
title(sprintf(<span class="string">'Pumping Constant\nOriginal Spacing (%dx%d) vs. Power of Two Spacing (%dx%d)'</span>,<span class="keyword">...</span>
    size(td.PumpCon,1),size(td.PumpCon,2),size(ntd.PumpCon,1),size(ntd.PumpCon,2)));
</pre><img vspace="5" hspace="5" src="../rtwdemo_fuelsys_fxp_publish_05.png" alt=""> <h2>圧力推定の 2 のべき乗の間隔<a name="17"></a></h2><pre class="codeinput">clf
mesh(td.ThrotVect,td.SpeedVect,td.PressEst), hold <span class="string">on</span>
mesh(ntd.ThrotVect,ntd.SpeedVect,ntd.PressEst)
xlabel(<span class="string">'ThrotVect'</span>), ylabel(<span class="string">'SpeedVect'</span>), zlabel(<span class="string">'PressEst'</span>)
title(sprintf(<span class="string">'Pressure Estimate\nOriginal Spacing (%dx%d) vs. Power of Two Spacing (%dx%d)'</span>,<span class="keyword">...</span>
    size(td.PressEst,1),size(td.PressEst,2),size(ntd.PressEst,1),size(ntd.PressEst,2)));
</pre><img vspace="5" hspace="5" src="../rtwdemo_fuelsys_fxp_publish_06.png" alt=""> <h2>速度推定の 2 のべき乗の間隔<a name="18"></a></h2><pre class="codeinput">clf
mesh(td.PressVect,td.ThrotVect,td.SpeedEst), hold <span class="string">on</span>,
mesh(ntd.PressVect,ntd.ThrotVect,ntd.SpeedEst)
xlabel(<span class="string">'PressVect'</span>), ylabel(<span class="string">'ThrotVect'</span>), zlabel(<span class="string">'SpeedEst'</span>)
title(sprintf(<span class="string">'Speed Estimate\nOriginal Spacing (%dx%d) vs. Power of Two Spacing (%dx%d)'</span>,<span class="keyword">...</span>
    size(td.SpeedEst,1),size(td.SpeedEst,2),size(ntd.SpeedEst,1),size(ntd.SpeedEst,2)));
</pre><img vspace="5" hspace="5" src="../rtwdemo_fuelsys_fxp_publish_07.png" alt=""> <h2>スロットル推定の 2 のべき乗の間隔<a name="19"></a></h2><pre class="codeinput">clf
mesh(td.PressVect,td.SpeedVect,td.ThrotEst), hold <span class="string">on</span>
mesh(ntd.PressVect,ntd.SpeedVect,ntd.ThrotEst)
xlabel(<span class="string">'PressVect'</span>), ylabel(<span class="string">'SpeedVect'</span>), zlabel(<span class="string">'ThrotEst'</span>)
title(sprintf(<span class="string">'Throttle Estimate\nOriginal Spacing (%dx%d) vs. Power of Two Spacing (%dx%d)'</span>,<span class="keyword">...</span>
    size(td.ThrotEst,1),size(td.ThrotEst,2),size(ntd.ThrotEst,1),size(ntd.ThrotEst,2)));
</pre><img vspace="5" hspace="5" src="../rtwdemo_fuelsys_fxp_publish_08.png" alt=""> <h2>Ramp Rate Ki の 2 のべき乗の間隔<a name="20"></a></h2><pre class="codeinput">clf
mesh(td.RampRateKiX,td.RampRateKiY,td.RampRateKiZ'), hold <span class="string">on</span>
mesh(ntd.RampRateKiX,ntd.RampRateKiY,ntd.RampRateKiZ'), hidden <span class="string">off</span>
xlabel(<span class="string">'RampRateKiX'</span>), ylabel(<span class="string">'RampRateKiY'</span>), zlabel(<span class="string">'RampRateKiZ'</span>)
title(sprintf(<span class="string">'Ramp Rate Ki\nOriginal Spacing (%dx%d) vs. Power of Two Spacing (%dx%d)'</span>,<span class="keyword">...</span>
    size(td.RampRateKiZ,1),size(td.RampRateKiZ,2),size(ntd.RampRateKiZ,1),size(ntd.RampRateKiZ,2)));
</pre><img vspace="5" hspace="5" src="../rtwdemo_fuelsys_fxp_publish_09.png" alt=""> <p>このモデルは、最上位信号に対するシミュレーション データのログを作成するように設定されており、それによってシミュレーションの結果がワークスペース変数 sldemo_fuelsys_output に保存されます。  モデル ワークスペースを新しいデータで更新する前に、シミュレーションの結果を hDemo.orig_data に保存することにより、等間隔の 2 のべき乗のテーブルのシミュレーションと後で比較できるようにします。</p><pre class="codeinput">set_param(<span class="string">'sldemo_fuelsys'</span>,<span class="string">'StopTime'</span>,<span class="string">'8'</span>)
sim(<span class="string">'sldemo_fuelsys'</span>)
hDemo.orig_data = sldemo_fuelsys_output;
</pre><p>新しいテーブル データをモデル ワークスペースに再び割り当てます。</p><pre class="codeinput">hDemo.hWS = get_param(<span class="string">'sldemo_fuelsys'</span>, <span class="string">'ModelWorkspace'</span>);
hDemo.hWS.assignin(<span class="string">'PressEst'</span>,   ntd.PressEst);
hDemo.hWS.assignin(<span class="string">'PressVect'</span>,  ntd.PressVect);
hDemo.hWS.assignin(<span class="string">'PumpCon'</span>,    ntd.PumpCon);
hDemo.hWS.assignin(<span class="string">'SpeedEst'</span>,   ntd.SpeedEst);
hDemo.hWS.assignin(<span class="string">'SpeedVect'</span>,  ntd.SpeedVect);
hDemo.hWS.assignin(<span class="string">'ThrotEst'</span>,   ntd.ThrotEst);
hDemo.hWS.assignin(<span class="string">'ThrotVect'</span>,  ntd.ThrotVect);
hDemo.hWS.assignin(<span class="string">'RampRateKiX'</span>,ntd.RampRateKiX);
hDemo.hWS.assignin(<span class="string">'RampRateKiY'</span>,ntd.RampRateKiY);
hDemo.hWS.assignin(<span class="string">'RampRateKiZ'</span>,ntd.RampRateKiZ);
</pre><p>等間隔のデータに合わせてルックアップ テーブルを再設定します。</p><pre class="codeinput">hDemo.lookupTables = find_system(get_param(<span class="string">'sldemo_fuelsys'</span>,<span class="string">'Handle'</span>),<span class="keyword">...</span>
    <span class="string">'BlockType'</span>,<span class="string">'Lookup_n-D'</span>);

<span class="keyword">for</span> hDemo_blkIdx = 1 : length(hDemo.lookupTables)
    hDemo.blkH = hDemo.lookupTables(hDemo_blkIdx);
    set_param(hDemo.blkH,<span class="string">'IndexSearchMethod'</span>,<span class="string">'Evenly spaced points'</span>)
    set_param(hDemo.blkH,<span class="string">'InterpMethod'</span>,<span class="string">'None - Flat'</span>)
    set_param(hDemo.blkH,<span class="string">'ProcessOutOfRangeInput'</span>,<span class="string">'None'</span>)
<span class="keyword">end</span>
</pre><p>等間隔の 2 のべき乗の実装のシミュレーションを再実行し、シミュレーションの結果を hDemo.pow2_data に保存します。</p><pre class="codeinput">sim(<span class="string">'sldemo_fuelsys'</span>)
hDemo.pow2_data = sldemo_fuelsys_output;
</pre><p>燃料の流量と空燃比のシミュレーション結果を比較しましょう。このシミュレーションでは Pumping Constant および Ramp Rate Ki ルックアップ テーブルを使用しましたが、オリジナルのテーブル データに関して、等間隔の 2 のべき乗のブレークポイントに匹敵することがわかります。</p><pre class="codeinput">figure(<span class="string">'Tag'</span>,<span class="string">'CloseMe'</span>);
subplot(2,1,1);
plot(hDemo.orig_data.fuel.Time, hDemo.orig_data.fuel.Data,<span class="string">'r-'</span>);
hold
plot(hDemo.pow2_data.fuel.Time, hDemo.pow2_data.fuel.Data,<span class="string">'b-'</span>);
ylabel(<span class="string">'FuelFlowRate (g/sec)'</span>);
title(<span class="string">'Fuel Control System:Table Data Comparison'</span>);
legend(<span class="string">'original'</span>,<span class="string">'even power of two'</span>)
axis([0 8 .75 2.25]);
subplot(2,1,2);
plot(hDemo.orig_data.air_fuel_ratio.Time, hDemo.orig_data.air_fuel_ratio.Data,<span class="string">'r-'</span>);
hold
plot(hDemo.pow2_data.air_fuel_ratio.Time, hDemo.pow2_data.air_fuel_ratio.Data,<span class="string">'b-'</span>);
ylabel(<span class="string">'Air/Fuel Ratio'</span>);
xlabel(<span class="string">'Time (sec)'</span>)
legend(<span class="string">'original'</span>,<span class="string">'even power of 2'</span>,<span class="string">'Location'</span>,<span class="string">'SouthEast'</span>)
axis([0 8 11 16]);
</pre><pre class="codeoutput">Current plot held
Current plot held
</pre><img vspace="5" hspace="5" src="../rtwdemo_fuelsys_fxp_publish_10.png" alt=""> <p>最後に、燃料比制御装置を再ビルドし、生成されたルックアップ テーブル コードの違いを比較しましょう。</p><pre class="codeinput">rtwbuild(<span class="string">'sldemo_fuelsys/fuel_rate_control'</span>);
</pre><pre class="codeoutput">### Starting Real-Time Workshop build procedure for model:fuel_rate_control
### Successful completion of Real-Time Workshop build procedure for model:fuel_rate_control
</pre><p>図 6 は、ルックアップ テーブル Pumping Constant に対する生成コードの同じ部分を示しています。等間隔の 2 のべき乗のブレークポイントに対する生成コードは、等間隔でないブレークポイントの場合よりもはるかに効率的であることがわかります。子ノードは、2 つの単純なブレークポイント計算と、2D ルックアップ テーブル データ内の直接インデックスで構成されています。計算コストの高い除算が回避されるため、ブレークポイント データがメモリ内になくても構いません。</p><pre class="codeinput">rtwtrace(<span class="string">'sldemo_fuelsys/fuel_rate_control/airflow_calc/Pumping Constant'</span>);
</pre><p><img vspace="5" hspace="5" src="../rtwdemo_fuelsys_fxp_pow2_lookup_c1.jpg" alt=""> </p><p><img vspace="5" hspace="5" src="../rtwdemo_fuelsys_fxp_pow2_lookup_c2.jpg" alt=""> </p><p><b>図 6:Pumping Constant ルックアップ用の生成コード (等間隔の 2 のべき乗のブレークポイント)</b></p><p>デモを閉じます。</p><pre class="codeinput">close(findobj(0,<span class="string">'Tag'</span>,<span class="string">'CloseMe'</span>));
clear <span class="string">hDemo*</span> <span class="string">td</span> <span class="string">ntd</span>
close_system(<span class="string">'sldemo_fuelsys'</span>,0);
</pre><h2>おわりに<a name="31"></a></h2><p>等間隔の 2 のべき乗のブレークポイントの使用によるコードの効率化について説明しました。これは、固定小数点コード生成にとって重要な最適化の 1 つです。Simulink Model Advisor は、Simulink および Stateflow モデルのコードを効率化するその他の方法を見つけるための便利なツールです。特に、Real-Time Workshop Embedded Coder フォルダー下のチェックを実行してください。</p><h2>関連デモ<a name="32"></a></h2><p>sldemo_fuelsys 関連のデモについては、表 1 を参照してください。</p><p>
<TABLE>
<table border=2 CELLPADDING=10>
<TR>
<TD>固定小数点設計</TD>
<TD>
<a href="matlab:sldemo_fuelsys_data('fxpdemo_fuelsys','showdemo','fxpdemo_fuelsys_publish','Simulink&nbsp;Fixed&nbsp;Point')">fxpdemo_fuelsys</a>
</TD>
</TR>
<TR>
<TD>本番用 C/C++ コード生成</TD>
<TD>
<a href="matlab:sldemo_fuelsys_data('fxpdemo_fuelsys','showdemo','rtwdemo_fuelsys_publish','Real-Time&nbsp;Workshop')">rtwdemo_fuelsys</a>
</TD>
</TR>
</TABLE>
</p><p><b>表 1:</b>  sldemo_fuelsys を使用した関連製品のデモ</p><p class="footer">Copyright 1994-2009 The MathWorks, Inc.<br>Published with MATLAB&reg; 7.11</p><p class="footer" id="trademarks">MATLAB and Simulink are registered trademarks of The MathWorks, Inc.  Please see <a href="http://www.mathworks.com/trademarks">www.mathworks.com/trademarks</a> for a list of other trademarks owned by The MathWorks, Inc.  Other product or brand names are trademarks or registered trademarks of their respective owners.</p></div><!-- ##### SOURCE BEGIN ##### %% Fixed-Point Fuel Rate Control System % In this demonstration you will generate and optimize the code for a % fixed-point fuel rate control system designed using Simulink(R) and % Stateflow(R).  See <matlab:showdemo('sldemo_fuelsys') sldemo_fuelsys> and % <matlab:showdemo('fxpdemo_fuelsys_publish') fxpdemo_fuelsys> for a % detailed explanation of the model.  The demonstration uses Real-Time % Workshop(R) Embedded Coder(TM) (ERT target), however the concepts also % apply for Real-Time Workshop.  % Copyright 1994-2009 The MathWorks, Inc. % $Revision: 1.1.4.9.2.1 $  $Date: 2010/07/29 21:28:58 $  %% Familiarize Yourself with the Relevant Portions of the Model % Figures 1-4 show relevant portions of the sldemo_fuelsys model, which is % a closed-loop system containing a "plant" and "controller".  The plant is % used to validate the controller in simulation early in the design cycle. % In this example, we'll generate code for the relevant controller % subsystem, "fuel_rate_control".  Figure 1 shows the top-level simulation % model.  % Open sldemo_fuelsys via rtwdemo_fuelsys_fxp and compile the diagram to % view the signal data types. rtwdemo_fuelsys_fxp;  sldemo_fuelsys([],[],[],'compile'); sldemo_fuelsys([],[],[],'term');  %% % *Figure 1: Top-level model of the "plant" and "controller"* % % The fuel rate control system is comprised of Simulink and Stateflow % blocks, and is the portion of the model for which we'll generated code.  open_system('sldemo_fuelsys/fuel_rate_control');  %% % *Figure 2: The fuel rate controller subsystem* % % The intake airflow estimation and closed loop correction system contains % two lookup tables, Pumping Constant and Ramp Rate Ki, which we'll refer % to later in this demo as we optimize the generated code.  open_system('sldemo_fuelsys/fuel_rate_control/airflow_calc');  %% % *Figure 3: The airflow_calc subsystem* % % The control logic is a Stateflow chart that specifies the different % modes of operation.  open_system('sldemo_fuelsys/fuel_rate_control/control_logic');  %% % *Figure 4: Fuel rate controller logic* %  %% % Now let's remove the window clutter. close_system('sldemo_fuelsys/fuel_rate_control/airflow_calc'); close_system('sldemo_fuelsys/fuel_rate_control/fuel_calc'); close_system('sldemo_fuelsys/fuel_rate_control/control_logic'); hDemo.rt=sfroot;hDemo.m=hDemo.rt.find('-isa','Simulink.BlockDiagram'); hDemo.c=hDemo.m.find('-isa','Stateflow.Chart','-and','Name','control_logic'); hDemo.c.visible=false; close_system('sldemo_fuelsys/fuel_rate_control');  %% % Let's build the fuel rate control system only.  Once the code generation % process is complete, an HTML report detailing the generated code is % displayed automatically.  The main body of the code is located in % fuel_rate_control.c.  rtwbuild('sldemo_fuelsys/fuel_rate_control');  %% % Figure 5 shows snippets of the generated code for the lookup table % <matlab:rtwdemo_fuelsys_fxp,hilite_system(sprintf('sldemo_fuelsys/fuel_rate_control/airflow_calc/Pumping%sConstant',char(32))) Pumping Constant>. % % To see the code for Pumping Constant, right-click the block and select % *Real-Time Workshop > Navigate to code...*  rtwtrace('sldemo_fuelsys/fuel_rate_control/airflow_calc/Pumping Constant');  %% % The code for pumping constant contains two breakpoint searches and % a 2D interpolation.  The SpeedVect breakpoint is unevenly spaced, and % while the PressVect breakpoint is evenly spaced, neither have power of % two spacing.  This leads to extra code (ROM), including a division, and % requires all breakpoints to be in memory (RAM).  %% % % <<rtwdemo_fuelsys_fxp_uneven_lookup_c1.jpg>> % % <<rtwdemo_fuelsys_fxp_uneven_lookup_c2.jpg>> % % <<rtwdemo_fuelsys_fxp_uneven_lookup_c3.jpg>> % % <<rtwdemo_fuelsys_fxp_uneven_lookup_d1.jpg>> %  %% % *Figure 5: Generated code for Pumping Constant lookup (contains unevenly % spaced breakpoints)*  %% Optimizing Code With Evenly Spaced Power of Two Breakpoints % The generated code performance can be optimized using evenly spaced power % of two breakpoints.  In this example, we'll remap the lookup table data % in the fuel rate control system based on the existing measured data. % % The lookup table data is loaded into the model workspace when the model % loads via the model's PostLoadFcn.  We will retrieve the original table % data via sldemo_fuelsys_data, modify it for evenly spaced power of two % and reassign it in the model workspace. td = sldemo_fuelsys_data('sldemo_fuelsys', 'get_table_data');  %% % Compute new table data for evenly spaced power of two breakpoints ntd.SpeedVect   = 64 : 2^5 : 640;             % 32 rad/sec ntd.PressVect   = 2*2^-5 : 2^-5 : 1-(2*2^-5); % 0.03 bar ntd.ThrotVect   = 0:2^1:88;                   % 2 deg ntd.RampRateKiX = 128:2^7:640;                % 128 rad/sec ntd.RampRateKiY = 0:2^-2:1;                   % 0.25 bar  %% % Remap table data ntd.PumpCon  = interp2(td.PressVect,td.SpeedVect,td.PumpCon, ntd.PressVect',ntd.SpeedVect); ntd.PressEst = interp2(td.ThrotVect,td.SpeedVect,td.PressEst,ntd.ThrotVect',ntd.SpeedVect); ntd.SpeedEst = interp2(td.PressVect,td.ThrotVect,td.SpeedEst,ntd.PressVect',ntd.ThrotVect); ntd.ThrotEst = interp2(td.PressVect,td.SpeedVect,td.ThrotEst,ntd.PressVect',ntd.SpeedVect);  %% % Recompute Ramp Rate table data ntd.RampRateKiZ = (1:length(ntd.RampRateKiX))' * (1:length(ntd.RampRateKiY)) * td.Ki;  %% Pumping Constant Power Of Two Spacing figure('Tag','CloseMe'); mesh(td.PressVect,td.SpeedVect,td.PumpCon), hold on mesh(ntd.PressVect,ntd.SpeedVect,ntd.PumpCon) xlabel('PressVect'), ylabel('SpeedVect'), zlabel('PumpCon') title(sprintf('Pumping Constant\nOriginal Spacing (%dx%d) vs. Power of Two Spacing (%dx%d)',...     size(td.PumpCon,1),size(td.PumpCon,2),size(ntd.PumpCon,1),size(ntd.PumpCon,2)));  %% Pressure Estimate Power Of Two Spacing clf mesh(td.ThrotVect,td.SpeedVect,td.PressEst), hold on mesh(ntd.ThrotVect,ntd.SpeedVect,ntd.PressEst) xlabel('ThrotVect'), ylabel('SpeedVect'), zlabel('PressEst') title(sprintf('Pressure Estimate\nOriginal Spacing (%dx%d) vs. Power of Two Spacing (%dx%d)',...     size(td.PressEst,1),size(td.PressEst,2),size(ntd.PressEst,1),size(ntd.PressEst,2)));  %% Speed Estimate Power Of Two Spacing clf mesh(td.PressVect,td.ThrotVect,td.SpeedEst), hold on, mesh(ntd.PressVect,ntd.ThrotVect,ntd.SpeedEst) xlabel('PressVect'), ylabel('ThrotVect'), zlabel('SpeedEst') title(sprintf('Speed Estimate\nOriginal Spacing (%dx%d) vs. Power of Two Spacing (%dx%d)',...     size(td.SpeedEst,1),size(td.SpeedEst,2),size(ntd.SpeedEst,1),size(ntd.SpeedEst,2)));  %% Throttle Estimate Power Of Two Spacing clf mesh(td.PressVect,td.SpeedVect,td.ThrotEst), hold on mesh(ntd.PressVect,ntd.SpeedVect,ntd.ThrotEst) xlabel('PressVect'), ylabel('SpeedVect'), zlabel('ThrotEst') title(sprintf('Throttle Estimate\nOriginal Spacing (%dx%d) vs. Power of Two Spacing (%dx%d)',...     size(td.ThrotEst,1),size(td.ThrotEst,2),size(ntd.ThrotEst,1),size(ntd.ThrotEst,2)));  %% Ramp Rate Ki Power Of Two Spacing clf mesh(td.RampRateKiX,td.RampRateKiY,td.RampRateKiZ'), hold on mesh(ntd.RampRateKiX,ntd.RampRateKiY,ntd.RampRateKiZ'), hidden off xlabel('RampRateKiX'), ylabel('RampRateKiY'), zlabel('RampRateKiZ') title(sprintf('Ramp Rate Ki\nOriginal Spacing (%dx%d) vs. Power of Two Spacing (%dx%d)',...     size(td.RampRateKiZ,1),size(td.RampRateKiZ,2),size(ntd.RampRateKiZ,1),size(ntd.RampRateKiZ,2)));  %% % The model is configured to log simulation data for the top-level signals, % whereby the result of a simulation is stored into workspace variable % sldemo_fuelsys_output.  Before updating the model workspace with the new % data we'll save the result of the simulation in hDemo.orig_data for % later comparison with the evenly spaced power of two table simulation. set_param('sldemo_fuelsys','StopTime','8') sim('sldemo_fuelsys') hDemo.orig_data = sldemo_fuelsys_output;  %% % Reassign the new table data in the model workspace hDemo.hWS = get_param('sldemo_fuelsys', 'ModelWorkspace'); hDemo.hWS.assignin('PressEst',   ntd.PressEst); hDemo.hWS.assignin('PressVect',  ntd.PressVect); hDemo.hWS.assignin('PumpCon',    ntd.PumpCon); hDemo.hWS.assignin('SpeedEst',   ntd.SpeedEst); hDemo.hWS.assignin('SpeedVect',  ntd.SpeedVect); hDemo.hWS.assignin('ThrotEst',   ntd.ThrotEst); hDemo.hWS.assignin('ThrotVect',  ntd.ThrotVect); hDemo.hWS.assignin('RampRateKiX',ntd.RampRateKiX); hDemo.hWS.assignin('RampRateKiY',ntd.RampRateKiY); hDemo.hWS.assignin('RampRateKiZ',ntd.RampRateKiZ);  %% % Reconfigure lookup tables for evenly spaced data. hDemo.lookupTables = find_system(get_param('sldemo_fuelsys','Handle'),...     'BlockType','Lookup_n-D');  for hDemo_blkIdx = 1 : length(hDemo.lookupTables)     hDemo.blkH = hDemo.lookupTables(hDemo_blkIdx);     set_param(hDemo.blkH,'IndexSearchMethod','Evenly spaced points')     set_param(hDemo.blkH,'InterpMethod','None - Flat')     set_param(hDemo.blkH,'ProcessOutOfRangeInput','None') end  %% % Rerun the simulation for the evenly spaced power of two implementation, % and store the result of the simulation in hDemo.pow2_data. sim('sldemo_fuelsys') hDemo.pow2_data = sldemo_fuelsys_output;  %% % Let's compare the result of the simulation for the fuel flow rate and the % air fuel ratio.  The simulation exercised the Pumping Constant and Ramp % Rate Ki lookup tables, and shows an excellent match for the evenly spaced % power of two breakpoints relative to the original table data. figure('Tag','CloseMe'); subplot(2,1,1); plot(hDemo.orig_data.fuel.Time, hDemo.orig_data.fuel.Data,'r-'); hold plot(hDemo.pow2_data.fuel.Time, hDemo.pow2_data.fuel.Data,'b-'); ylabel('FuelFlowRate (g/sec)'); title('Fuel Control System: Table Data Comparison'); legend('original','even power of two') axis([0 8 .75 2.25]); subplot(2,1,2); plot(hDemo.orig_data.air_fuel_ratio.Time, hDemo.orig_data.air_fuel_ratio.Data,'r-'); hold plot(hDemo.pow2_data.air_fuel_ratio.Time, hDemo.pow2_data.air_fuel_ratio.Data,'b-'); ylabel('Air/Fuel Ratio'); xlabel('Time (sec)') legend('original','even power of 2','Location','SouthEast') axis([0 8 11 16]);  %% % Finally, let's rebuild the fuel rate control system and compare the % difference in the generated lookup table code.  rtwbuild('sldemo_fuelsys/fuel_rate_control');  %% % Figure 6 shows the same snippets of the generated code for the % 'Pumping Constant' lookup table.  As you can see, the generated code for % evenly spaced power of two breakpoints is significantly more efficient % than the unevenly spaced breakpoint case.  The code consists of two % simple breakpoint calculations and a direct index into the 2D lookup % table data.  The expensive division is avoided and the breakpoint data % is not required in memory.  rtwtrace('sldemo_fuelsys/fuel_rate_control/airflow_calc/Pumping Constant');  %% % % <<rtwdemo_fuelsys_fxp_pow2_lookup_c1.jpg>> % % <<rtwdemo_fuelsys_fxp_pow2_lookup_c2.jpg>> %  %% % *Figure 6: Generated code for Pumping Constant lookup (evenly spaced % power of two breakpoints)*  %% % Close the demo. close(findobj(0,'Tag','CloseMe')); clear hDemo* td ntd close_system('sldemo_fuelsys',0);  %% Closing Remarks % We touched on improving code efficiency using evenly spaced power of 2 % breakpoints.  This is one such optimization important for fixed-point % code generation.  The Simulink Model Advisor is a great tool for % identifying other methods of improving code efficiency for a Simulink and % Stateflow model.  In particular, run the checks under the Real-Time % Workshop Embedded Coder folder.  %% Related Demos % Refer to Table 1 for demos related to sldemo_fuelsys. % % <html> % <TABLE> % <table border=2 CELLPADDING=10> % <TR> % <TD>Fixed-point design</TD> % <TD> % <a % href="matlab:sldemo_fuelsys_data('fxpdemo_fuelsys','showdemo','fxpdemo_fuelsys_publish','Simulink&nbsp;Fixed&nbsp;Point')"> % fxpdemo_fuelsys</a> % </TD> % </TR> % <TR> % <TD>Production C/C++ code generation</TD> % <TD> % <a % href="matlab:sldemo_fuelsys_data('fxpdemo_fuelsys','showdemo','rtwdemo_fuelsys_publish','Real-Time&nbsp;Workshop')"> % rtwdemo_fuelsys</a> % </TD> % </TR> % </TABLE> % </html> %  % *Table 1:*  Related product demos using sldemo_fuelsys   displayEndOfDemoMessage(mfilename) ##### SOURCE END ##### --></body></html>