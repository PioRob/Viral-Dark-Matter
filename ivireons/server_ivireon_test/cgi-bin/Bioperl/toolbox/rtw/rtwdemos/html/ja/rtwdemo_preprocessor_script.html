
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!-- This HTML was auto-generated from MATLAB code. To make changes, update the MATLAB code and republish this document.       --><title>モデル ブロックを使ったコード バリアント</title><meta name="generator" content="MATLAB 7.11"><link rel="schema.DC" href="../http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2010-05-27"><meta name="DC.source" content="rtwdemo_preprocessor_script.m"><link rel="stylesheet" type="text/css" href="../../../../matlab/demos/private/style.css"></head><body><div class="header"><div class="left"><a href="matlab:edit rtwdemo_preprocessor_script">エディターで rtwdemo_preprocessor_script.m を開く</a></div><div class="right"><a href="matlab:echodemo rtwdemo_preprocessor_script">コマンド ウィンドウで実行</a></div></div><div class="content"><h1>モデル ブロックを使ったコード バリアント</h1><!--introduction--><p>このデモでは、モデル バリアントについて説明します。プリプロセッサーの条件を使用して組み込み実行ファイルにリンクされるコードを制御するコードを生成する方法について説明します。</p><!--/introduction--><h2>目次</h2><div><ul><li><a href="#1">モデル バリアントの概要</a></li><li><a href="#2">モデル ブロックのバリアントの指定</a></li><li><a href="#7">バリアント制御変数の指定</a></li><li><a href="#9">複数のバリアントを持つモデルのシミュレーション</a></li><li><a href="#12">モデル ブロックのすべてのバリアントを生成するための親モデルの設定</a></li><li><a href="#13">生成されたコードの解析</a></li><li><a href="#14">詳細情報</a></li></ul></div><h2>モデル バリアントの概要<a name="1"></a></h2><p>モデル ブロックを使用すると、ある Simulink モデル <i></i>(子モデル) を別の Simulink モデル <i></i>(親モデル) から参照できます。ユーザーがモデル ブロックから可能性のある子モデルのセットを参照するために使用する場合、1 つのモデル ブロックに複数のバリアントを持たせることもできます。<i></i>バリアントは、そのモデル ブロックに参照される可能性があるモデルのセットで構成されます。次の図は、モデル バリアントの概念を示しています。たとえばこのデモでは、<tt>Right Controller</tt> モデル ブロックは 2 つのモデルを参照する可能性があります。これらのモデルは、指定された名目上の機能に基づき、バリアントを提供します。</p><p><img vspace="5" hspace="5" src="../rtwdemo_preprocessor_variants.jpg" alt=""> </p><p>特定のモデル ブロックの場合、アクティブにできるバリアントは 1 つのみです。モデル ブロック ダイアログを使用し、アクティブにするバリアントを選択できます。ただし、アクティブなバリアントの選択をパラメーター化したり、MATLAB のベース ワークスペースの変数およびオブジェクトの値に依存させたりすることを選択することもできます。コードを生成する場合、すべてのバリアントのコードを生成し、コードのコンパイル時までアクティブなバリアントの選択を行わないようにできます。</p><h2>モデル ブロックのバリアントの指定<a name="2"></a></h2><p>すべてのモデル バリアントのコードを生成する親モデルの作成方法を確認するには、<tt>rtwdemo_preprocessor</tt> モデルを使用します。プリプロセッサー条件は、バリアントのコードを保護します。マクロは、コードのコンパイル時にバリアントを定義してアクティブ化します。</p><p>モデルを開く:</p><pre class="codeinput">open_system(<span class="string">'rtwdemo_preprocessor'</span>)
</pre><img vspace="5" hspace="5" src="../rtwdemo_preprocessor_script_01.png" alt=""> <p>モデル ブロック <tt>Left Controller</tt> を右クリックして、<b>[ModelReference パラメーター...]</b> を選択し、モデル参照のダイアログ ボックスを開きます。</p><p><img vspace="5" hspace="5" src="../rtwdemo_preprocessor_dialog.jpg" alt=""> </p><p>このダイアログで、可能なバリアントが 2 つ指定されます。それらの 2 つのバリアントが、<tt>LINEAR</tt> と <tt>NONLINEAR</tt> という 2 つの異なる Simulink.Variant オブジェクトに関連付けられます。これらのオブジェクトはベース ワークスペース内に存在しています。これらのオブジェクトには、boolean として評価され、どのバリアントがアクティブになるのかを特定する式である、<tt>Condition</tt> という名前のプロパティがあります。条件は、モデル参照のダイアログ ボックスにも表示されます。この例では、<tt>LINEAR</tt> および <tt>NONLINEAR</tt> の条件はそれぞれ、'MODE == 0'、'MODE == 1' です。</p><p>この例の <tt>Simulink.Variant</tt> オブジェクトは、MATLAB ベース ワークスペースで作成されています。</p><pre class="codeinput">LINEAR = Simulink.Variant;
LINEAR.Condition = <span class="string">'MODE==0'</span>;
NONLINEAR = Simulink.Variant;
NONLINEAR.Condition = <span class="string">'MODE==1'</span>;
</pre><p>バリアント オブジェクトにより、モデル内で複合条件の任意の再利用が容易にできます。複数のモデル ブロックが同じバリアント オブジェクトを使用すると、子モデルの参照を 1 つのセットとしてまとめて切り替えられます。このセットは、MATLAB 環境の <tt>MODE</tt> の値を変更するとシミュレーション時に切り替えられます。または次の節で説明するように、生成コードのコンパイル時にもできます。この例では、<tt>Left Controller</tt> および <tt>Right Controller</tt> は、同じバリアント オブジェクトを参照しているため、ユーザーはこれらを同時に切り替えられます。</p><p><img vspace="5" hspace="5" src="../rtwdemo_preprocessor_variants_big.jpg" alt=""> </p><p>非線形コントローラー モデルはヒステリシスを実装しますが、線形コントローラー モデルは単純なローパス フィルターとして動作します。左側のチャンネルのモデルを <tt>rtwdemo_nlinl</tt> および <tt>rtwdemo_linl</tt> として開きます。右側のチャンネルのモデルも同様です。</p><pre class="codeinput">open_system(<span class="string">'rtwdemo_nlinl'</span>)
</pre><img vspace="5" hspace="5" src="../rtwdemo_preprocessor_script_02.png" alt=""> <pre class="codeinput">open_system(<span class="string">'rtwdemo_linl'</span>)
</pre><img vspace="5" hspace="5" src="../rtwdemo_preprocessor_script_03.png" alt=""> <h2>バリアント制御変数の指定<a name="7"></a></h2><p>生成されたコードは、バリアント制御変数 <tt>MODE</tt> にユーザー定義マクロとしてアクセスします。この例では、<tt>rtwdemo_importedmacros.h</tt> が <tt>MODE</tt> を提供します。MATLAB 環境では、<tt>Simulink.Parameter</tt> オブジェクトを使用して <tt>MODE</tt> を指定します。プリプロセッサー条件を含むコードを生成する場合、値は無視されます。ただし、値はシミュレーションに使用されます。レガシ ヘッダー ファイルは、生成コードのコンパイル時に使用するマクロの値を指定します。これは最終的に、組み込み実行ファイルの指定された 2 つのバリアントのどちらかをアクティブ化します。</p><pre class="codeinput">MODE = Simulink.Parameter;
MODE.Value = int32(1);
MODE.RTWInfo.StorageClass = <span class="string">'Custom'</span>;
MODE.RTWInfo.CustomStorageClass = <span class="string">'ImportedDefine'</span>;
MODE.RTWInfo.CustomAttributes.HeaderFile = <span class="string">'rtwdemo_importedmacros.h'</span>;
</pre><p><img vspace="5" hspace="5" src="../rtwdemo_preprocessor_MODE.jpg" alt=""> </p><h2>複数のバリアントを持つモデルのシミュレーション<a name="9"></a></h2><p><tt>MODE</tt> の値を 1 に設定しているため、モデルはシミュレーション時に非線形コントローラーを使用します。</p><pre class="codeinput">sim(<span class="string">'rtwdemo_preprocessor'</span>)
youtnl = yout;
</pre><p><tt>MODE</tt> の値が 0 に設定されると、モデルはシミュレーション時に線形コントローラーを使用します。</p><pre class="codeinput">MODE.Value = int32(0);
sim(<span class="string">'rtwdemo_preprocessor'</span>)
youtl = yout;
</pre><p>次のようにして、線形コントローラーおよび非線形コントローラーの応答をプロットして比較できます。</p><pre class="codeinput">figure(<span class="string">'Tag'</span>,<span class="string">'CloseMe'</span>);
plot(tout, youtnl.signals(1).values, <span class="string">'r-'</span>, tout, youtl.signals(1).values, <span class="string">'b-'</span>)
title(<span class="string">'Response of Left Channel Linear and Nonlinear Controllers'</span>);
ylabel(<span class="string">'Response'</span>);
xlabel(<span class="string">'Time (seconds)'</span>);
legend(<span class="string">'nonlinear'</span>,<span class="string">'linear'</span>)
axis([0 100 -0.8 0.8]);
</pre><img vspace="5" hspace="5" src="../rtwdemo_preprocessor_script_04.png" alt=""> <h2>モデル ブロックのすべてのバリアントを生成するための親モデルの設定<a name="12"></a></h2><p>親モデルの [コンフィギュレーション パラメーター] ダイアログ ボックスの[インターフェイス] ペインで、<b>[プリプロセッサーの条件を生成]</b> リストから <b>[ローカル設定を利用]</b> を選択します。</p><p><img vspace="5" hspace="5" src="../rtwdemo_preprocessor_model.jpg" alt=""> </p><p>各モデル ブロックのモデル参照のダイアログボックスで、<b>[バリアントの条件をオーバーライドして以下のバリアントを使用]</b> チェック ボックスをオフにし、<b>[プリプロセッサーの条件を生成]</b> チェック ボックスをオンにします。</p><p><img vspace="5" hspace="5" src="../rtwdemo_preprocessor_blk.jpg" alt=""> </p><h2>生成されたコードの解析<a name="13"></a></h2><p>生成されたコードには、バリアント <tt>LINEAR</tt> および <tt>NONLINEAR</tt> への参照、およびこれらのバリアントに対応するマクロの定義が含まれます。これらの定義は、外部ヘッダー ファイル <tt>rtwdemo_importedmacros.h</tt> によって提供される、<tt>MODE</tt> の値に依存します。アクティブなバリアントは、マクロ <tt>LINEAR</tt> および <tt>NONLINEAR</tt> のチェックにより決定されます。これらのチェックは、組み込みアプリケーションでアクティブになっているバリアントが 1 つだけであることも確認します。</p><p>マクロ <tt>LINEAR</tt> および <tt>NONLINEAR</tt> は、排他的アクティベーションのチェックと共に、<tt>rtwdemo_preprocessor_types.h</tt> で定義されます。</p><p><img vspace="5" hspace="5" src="../rtwdemo_preprocessor_types_h.jpg" alt=""> </p><p><tt>rtwdemo_preprocessor_types.h</tt> では、メイン ブロックが、モデルのデータ構造 (dwork) がバリアントの dwork のサブ構造を条件付きでコンパイルすることを示します。アクティブ バリアントは、マクロ <tt>LINEAR</tt> および <tt>NONLINEAR</tt> より決定されます。これらは、レガシ ヘッダー ファイル <tt>rtwdemo_importedmacros.h</tt> により提供されるとおり、<tt>MODE</tt> の値により決定されます。</p><p><img vspace="5" hspace="5" src="../rtwdemo_preprocessor_h.jpg" alt=""> </p><p><tt>rtwdemo_preprocessor.c</tt> では、バリアントの step 関数および初期化関数の呼び出しが条件付きでコンパイルされます。step 関数の一部を次に示します。</p><p><img vspace="5" hspace="5" src="../rtwdemo_preprocessor_c.jpg" alt=""> </p><p>Real-Time Workshop のコード レポートには、モデル バリアントに関する部分があるため、モデルのどの部分を、レガシ ヘッダー ファイルのマクロの値に基づいて条件付きでアクティブ化するかを容易に決定できます。</p><p><img vspace="5" hspace="5" src="../rtwdemo_preprocessor_report.jpg" alt=""> </p><h2>詳細情報<a name="14"></a></h2><p>詳細については、『Real-Time Workshop Embedded Coder User's Guide』の <a href="matlab:helpview(fullfile(docroot,'toolbox','ecoder','helptargets.map'),'ecoder_preprocessor_conditionals')">Generating Preprocessor Conditionals</a> を参照してください。</p><p>モデル、図、およびデモに関連するワークスペース変数を閉じます。</p><pre class="codeinput">bdclose(<span class="string">'rtwdemo_preprocessor'</span>)
bdclose(<span class="string">'rtwdemo_nlinl'</span>)
bdclose(<span class="string">'rtwdemo_linl'</span>)
close(findobj(0,<span class="string">'Tag'</span>,<span class="string">'CloseMe'</span>));
clear <span class="string">LINEAR</span> <span class="string">NONLINEAR</span> <span class="string">MODE</span>
</pre><p class="footer">Copyright 2009 The MathWorks, Inc.<br>Published with MATLAB&reg; 7.11</p><p class="footer" id="trademarks">MATLAB and Simulink are registered trademarks of The MathWorks, Inc.  Please see <a href="http://www.mathworks.com/trademarks">www.mathworks.com/trademarks</a> for a list of other trademarks owned by The MathWorks, Inc.  Other product or brand names are trademarks or registered trademarks of their respective owners.</p></div><!-- ##### SOURCE BEGIN ##### %% Code Variants Using Model Blocks % This demonstration explains model variants.  It shows you how to  % generate code that uses preprocessor conditionals to control which code % is linked into the embedded executable.  %   Copyright 2009 The MathWorks, Inc. %   $Revision: 1.1.4.2.2.1 $  $Date: 2010/07/29 21:29:01 $  %% Overview of Model Variants % You can use a model block to reference one Simulink model (the _child model_) % from another Simulink model (the _parent model_).  A model block can also % have different _variants_ when the user uses to reference a set of potential % child models from the model block.  The variants comprise a set of models % that the model block can potentially reference.  The figure  % below is a conceptual depiction of model variants.   % For example, in this demo the  % |Right Controller| model block can potentially reference two models. % Those models provide variations upon a nominal, prescribed functionality. % % <<rtwdemo_preprocessor_variants.jpg>> % % For a given model block, only one variant can be active.   % You can use the model block dialog to  % choose which variant is active.  However, you can also choose to % parameterize the choice of the active variant, and make it dependent on the % values of variables and objects in the base MATLAB workspace. % When you generate code, you can generate code for all of the % variants, and defer the choice of active variant until it is time to compile % that code.  %% Specifying Variants for a Model Block % Use the |rtwdemo_preprocessor| model to see how to construct a % parent model that generates code for all of the model variants.  % Preprocessor conditionals guard the   % code for the variants.  Macros define and activate the variants when % the code is compiled. % % Open the model: open_system('rtwdemo_preprocessor')  %% % Right-click the |Left Controller| model block and select % *ModelReference Parameters...* to open the model reference dialog. % % <<rtwdemo_preprocessor_dialog.jpg>> % % The dialog specifies two potential variants.  The two variants are in turn % associated with two distinct Simulink.Variant objects |LINEAR| and |NONLINEAR|,  % which exist in the base workspace.  These objects have a property named  % |Condition|, an expression that evaluates to a Boolean and that determines  % which variant is active.  The condition is also shown in the model reference  % dialog. In this example, the conditions of |LINEAR| and |NONLINEAR| are % 'MODE == 0' and  'MODE == 1', respectively.  % % The |Simulink.Variant| objects of this example have been created in the % base workspace. LINEAR = Simulink.Variant; LINEAR.Condition = 'MODE==0'; NONLINEAR = Simulink.Variant; NONLINEAR.Condition = 'MODE==1';  %% % The variant objects permit easy reuse of arbitrarily complex conditions  % throughout a model.  Multiple model blocks can use the same variant % objects, permitting you to gang and toggle their child model % references as a set.  The set can be toggled at simulation time by  % changing the value of |MODE| in the MATLAB environment, or when compiling the % generated code, as explained in the next section.   % In this example, |Left Controller| % and |Right Controller| reference the same variant objects, so that you % may toggle them simultaneously. % % <<rtwdemo_preprocessor_variants_big.jpg>> % % The nonlinear controller % models implement hysteresis, while the linear controller models act % as simple low-pass filters. Open the  % models for the left channel as |rtwdemo_nlinl| and |rtwdemo_linl|.  The % models for the right channel are similar.  %% open_system('rtwdemo_nlinl')  %% open_system('rtwdemo_linl')  %% Specifying a Variant Control Variable % The generated code accesses the variant control variable |MODE|  % as a user-defined macro.  In this example, |rtwdemo_importedmacros.h| supplies % |MODE|. Within the MATLAB environment, you specify |MODE| using a  % |Simulink.Parameter| object.  Its value will be ignored  % when generating code including preprocessor conditionals. However,  % the value is used for simulation.  The legacy header file specifies the  % value of the macro to be used when compiling the generated code, which  % ultimately activates one of the two specified variants in the embedded % executable.  MODE = Simulink.Parameter; MODE.Value = int32(1); MODE.RTWInfo.StorageClass = 'Custom'; MODE.RTWInfo.CustomStorageClass = 'ImportedDefine'; MODE.RTWInfo.CustomAttributes.HeaderFile = 'rtwdemo_importedmacros.h';  %% % <<rtwdemo_preprocessor_MODE.jpg>>  %% Simulating the Model with Different Variants % Since you set the value of |MODE| to 1, the model uses the  % nonlinear controllers during simulation. sim('rtwdemo_preprocessor') youtnl = yout;  %% % If the value of |MODE| is changed to 0, the model uses the  % linear controllers during simulation.   MODE.Value = int32(0); sim('rtwdemo_preprocessor') youtl = yout;  %% % You can plot and compare the response of the linear and nonlinear % controllers: figure('Tag','CloseMe'); plot(tout, youtnl.signals(1).values, 'r-', tout, youtl.signals(1).values, 'b-') title('Response of Left Channel Linear and Nonlinear Controllers'); ylabel('Response'); xlabel('Time (seconds)'); legend('nonlinear','linear') axis([0 100 -0.8 0.8]);  %% Configuring the Parent Model to Generate All Variants of the Model Block % On the Interface pane of the Configuration Parameters dialog of  % the parent model, % select *Use local settings* from the *Generate preprocessor conditionals* % list  % % <<rtwdemo_preprocessor_model.jpg>> % % On each model block's Model Reference dialog, deselect the checkbox  % *Override variant conditions and use following variant*, and select  % the check box *Generate preprocessor conditionals*. % % <<rtwdemo_preprocessor_blk.jpg>> %  %% Analyzing the Generated Code % The generated code includes references to the variants |LINEAR| and % |NONLINEAR|, as well as the definitions of macros corresponding to those  % variants.  Those definitions depend on the value of |MODE|, which is  % supplied in an external header file |rtwdemo_importedmacros.h|. % The active variant is determined by checks on the macros |LINEAR| and  % |NONLINEAR|.  These checks also ensure that exactly one variant is active % in the embedded application. % % The macros |LINEAR| and |NONLINEAR| are defined in |rtwdemo_preprocessor_types.h|,  % along with the check for exclusive activation. % % <<rtwdemo_preprocessor_types_h.jpg>> %  % In |rtwdemo_preprocessor_types.h|, the main block states data structure % (dwork) for the model % conditionally compiles substructures for the variants' dworks.  The % active variant is determined by the macros |LINEAR| and |NONLINEAR|, which % are in turn determined by the value of |MODE|, as supplied in the legacy % header file |rtwdemo_importedmacros.h|. % % <<rtwdemo_preprocessor_h.jpg>> % % In |rtwdemo_preprocessor.c|, the calls to the variants' step and  % initialization functions are again conditionally compiled; a portion of % the step function is shown below. % % <<rtwdemo_preprocessor_c.jpg>> % % The Real-Time Workshop code report contains a section dedicated to  % the model variants, so % that you can easily determine which parts of the model are activated  % conditionally upon the value of the macros in the legacy header files. % % <<rtwdemo_preprocessor_report.jpg>>  %% Further Information % % See <matlab:helpview(fullfile(docroot,'toolbox','ecoder','helptargets.map'),'ecoder_preprocessor_conditionals') Generating Preprocessor Conditionals> in the Real-Time Workshop Embedded Coder User's Guide.  %% % Close the model, figure and workspace variables associated with demo bdclose('rtwdemo_preprocessor') bdclose('rtwdemo_nlinl') bdclose('rtwdemo_linl') close(findobj(0,'Tag','CloseMe')); clear LINEAR NONLINEAR MODE  displayEndOfDemoMessage(mfilename)   ##### SOURCE END ##### --></body></html>