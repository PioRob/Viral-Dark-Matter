
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!-- This HTML was auto-generated from MATLAB code. To make changes, update the MATLAB code and republish this document.       --><title>モデル参照によるデータ管理の詳細ワークフロー</title><meta name="generator" content="MATLAB 7.11"><link rel="schema.DC" href="../http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2010-06-02"><meta name="DC.source" content="sldemo_mdlref_datamngt2.m"><link rel="stylesheet" type="text/css" href="../../../../../matlab/demos/private/style.css"></head><body><div class="header"><div class="left"></div><div class="right">&nbsp;</div></div><div class="content"><h1>モデル参照によるデータ管理の詳細ワークフロー</h1><!--introduction--><p>このデモでは、モデル参照によるデータ管理ワークフローに使用するいくつかのツールと手法について説明します。</p><p>このトピックの基本的な説明は、<a href="sldemo_mdlref_datamngt.html">モデル参照によるデータ管理の紹介</a>を参照してください。</p><!--/introduction--><h2>目次</h2><div><ul><li><a href="#1">デモの要件</a></li><li><a href="#2">デモ モデルを開く</a></li><li><a href="#3">デモの内容</a></li><li><a href="#4">デモの概要</a></li><li><a href="#5">参照モデル: パラメーターの設定</a></li><li><a href="#16">参照モデル: 出力バス信号の形状の定義</a></li><li><a href="#27">参照モデル: バス出力の初期値の設定</a></li><li><a href="#32">参照モデル: マスクした Model ブロックの作成</a></li><li><a href="#33">最上位モデル: Model ブロックのパラメーター化</a></li><li><a href="#42">最上位モデル: 参照モデルの呼び出しのスケジューリング</a></li><li><a href="#43">最上位モデルのシミュレーション</a></li><li><a href="#48">最上位モデルのコードの生成 (Real-Time Workshop が必要)</a></li><li><a href="#50">モデル引数の型名の制御</a></li><li><a href="#60">最上位モデルにおけるパラメーター表現の制御</a></li><li><a href="#64">最上位モデルのコードの再生成 (Real-Time Workshop が必要)</a></li></ul></div><h2>デモの要件<a name="1"></a></h2><p>このデモの間、Simulink&reg; と Real-Time Workshop&reg; は、現在の作業ディレクトリに作成される Simulink プロジェクト ディレクトリにコードを生成します。このディレクトリにファイルを生成したくない場合 (あるいは生成できない場合) は、作業ディレクトリを変更してください。スタンドアロン アプリケーションに配布されるモデル参照バイナリを生成するには、Real-Time Workshop が必要です。</p><p><b>デモ モデルを変更する予定がある場合は、以下の手順に従います。</b></p><p>1. 以下のファイルを、名前を変更することなく、MATLAB&reg; インストール ディレクトリから他のディレクトリにコピーすることで、デモを元の状態で保存しておきます。</p><pre>toolbox/simulink/simdemos/simfeatures/sldemo_mdlref_datamngt.mdl
toolbox/simulink/simdemos/simfeatures/sldemo_mdlref_datamngt_wsdata.m
toolbox/simulink/simdemos/simfeatures/sldemo_mdlref_counter_datamngt.mdl
toolbox/simulink/simdemos/simfeatures/sldemo_mdlref_counter_datamngt_lib.mdl
toolbox/simulink/simdemos/simfeatures/sldemo_mdlref_counter_datamngt_types.m
toolbox/simulink/simdemos/simfeatures/sldemo_mdlref_counter_datamngt_wsdata.m</pre><p>2. 現在の作業ディレクトリを、ファイルをコピーしたディレクトリに変更します。</p><p>3. デモを続行します。</p><h2>デモ モデルを開く<a name="2"></a></h2><p><a href="matlab:open_system('sldemo_mdlref_datamngt');"><tt>open_system('sldemo_mdlref_datamngt')</tt></a></p><img vspace="5" hspace="5" src="../sldemo_mdlref_datamngt2_01.png" alt=""> <h2>デモの内容<a name="3"></a></h2><p>このデモでは、Counter1、Counter2、および Counter3 という 3 つの Model ブロックを含む最上位モデル (<a href="matlab:open_system('sldemo_mdlref_datamngt')"><tt>sldemo_mdlref_datamngt</tt></a>) を使用します。これらのブロックは、同じモデル (<a href="matlab:open_system('sldemo_mdlref_counter_datamngt');"><tt>sldemo_mdlref_counter_datamngt</tt></a>) を参照します。</p><p>参照モデルは、次のような制限カウンター アルゴリズムを実装します。</p><div><ul><li>最初のトリガー入力が変化したら、カウンターをリセットする</li><li>2 番目の入力が変化したら、指定した量だけカウンターをインクリメントする</li><li>指定した上限および下限の間でカウンターを飽和する</li></ul></div><p>参照モデルは、次の値を含むバス信号を出力します。</p><div><ul><li><b>Count: </b> カウンターの値 (8 ビット整数)</li><li><b>OverflowState: </b> カウンターが上限、下限、または範囲内かを示す列挙値</li></ul></div><p>このモデルは、一緒に機能するいくつかの Simulink 機能を表示するように設定されています。</p><div><ul><li><b>Tunable parameter structure:</b> モデルをパラメーター化する MATLAB 構造体に変数を収集します。このデモでは、参照モデルのモデル引数をパラメーター構造体として定義します。</li><li><b>Model arguments:</b> モデル参照の各インスタンスに異なるパラメーター値を渡します。</li><li><b>Bus objects:</b> モデル参照インターフェイスで使用する信号およびパラメーターの構造体の &quot;形状&quot; を定義します。生成コードの構造体パラメーターと信号の型名を定義します。</li><li><b>Simulink.Bus.createMATLABStruct:</b> バス オブジェクトの形状と一致する MATLAB 構造体を作成する静的メソッド。</li><li><b>Bus initialization:</b> パラメーター構造体を使用してバス信号および状態を初期化します。</li><li><b>Masked Model block:</b> Model Reference ブロックのカスタム インターフェイスを作成します。</li><li><b>Triggered model reference:</b> コンポーネントのスケジューリングを明示的に制御します。</li></ul></div><p>このデモでは、Simulink でのデータ管理に役立つその他の機能も使用します。</p><div><ul><li><b>Simulink.saveVars:</b> MATLAB スクリプトにワークスペース変数をシリアル化します。インクリメント変更、データの差分操作、およびバージョン管理をサポートしています。</li><li><b>Simulink.findVars:</b> モデルによってワークスペース変数がどのように使用されているかを確認します。</li></ul></div><h2>デモの概要<a name="4"></a></h2><p><b>デモの手順は、次のとおりです。</b></p><p>1. 外部インターフェイスで信号とパラメーターの構造体を使用する参照モデル (<tt>sldemo_mdlref_counter_datamngt</tt>) を準備します。</p><p>2. 参照モデルを呼び出す最上位モデル (<tt>sldemo_mdlref_datamngt</tt>) を準備します。</p><p>3. 最上位モデルをシミュレートし、結果を調べます。</p><p>4. コードを生成し、最上位モデルのスタンドアロンの実行ファイルを作成します。</p><h2>参照モデル: パラメーターの設定<a name="5"></a></h2><p>参照モデルには、モデルのブロックをパラメーター化する 2 つのモデル引数 (CounterParams、CounterICs) があります。モデル引数は、参照モデルの各インスタンスに異なるパラメーター値を指定します。このモデルでは、参照モデルに渡される引数の数を低減するために、引数がパラメーター構造体として定義されています。</p><p><b>モデル引数を定義するプロセスは、次のとおりです。</b></p><p>1. 参照モデル (<a href="matlab:open_system('sldemo_mdlref_counter_datamngt');"><tt>sldemo_mdlref_counter_datamngt</tt></a>) を開きます。</p><img vspace="5" hspace="5" src="../sldemo_mdlref_datamngt2_02.png" alt=""> <p>2. MATLAB 構造体を定義して参照モデルをパラメーター化します。</p><pre>CounterParams.Increment  = int8(1);
CounterParams.LowerLimit = int8(-10);
CounterParams.UpperLimit = int8(10);</pre><pre>CounterICs.Count         = int8(0);
CounterICs.OverflowState = SlDemoRangeCheck.InRange;</pre><p><b>メモ:</b> このデモでは、カウンターに 8 ビット整数を使用するため、数値フィールドにも 8 ビット整数を使用します。</p><p>3. MATLAB 構造体をモデル引数として使用します。</p><p>モデル引数は、参照モデルのモデル ワークスペースに変数として定義されています。<a href="matlab:daexplr;">モデル エクスプローラー</a>を使用して、モデル ワークスペースの内容を表示して編集できます。</p><p><img vspace="5" hspace="5" src="../sldemo_mdlref_datamngt_snapshot_01.png" alt=""> </p><p>モデル ワークスペースは、いくつかの異なるデータ ソースから初期化できます。このデモは、MATLAB スクリプト (<a href="matlab:edit('sldemo_mdlref_counter_datamngt_wsdata');"><tt>sldemo_mdlref_counter_datamngt_wsdata</tt></a>) を使用して、モデル引数を定義するためのパラメーター構造体を作成します。MATLAB スクリプトを使用すると、モデルの外部で簡単にパラメーター構造体を作成、および変更することができます。さらに、インクリメント変更、バージョン管理、およびデータの差分操作も容易になります。</p><p>MATLAB スクリプトは、手動で作成するか、<b>Simulink.saveVars</b> を使用できます。</p><pre>Simulink.saveVars('sldemo_mdlref_counter_datamngt_wsdata.m', 'CounterParams', 'CounterICs');</pre><p>ワークスペースの [データ ソース]<b></b> を設定してモデル ワークスペースに MATLAB 構造体を作成し、モデル ワークスペースのダイアログ ボックスの [モデルの引数]<b></b> フィールドに変数名 (CounterParams) を入力します。</p><p><img vspace="5" hspace="5" src="../sldemo_mdlref_datamngt_snapshot_02.png" alt=""> </p><p>または、MATLAB コマンド ラインからモデル ワークスペースを設定することもできます。</p><pre>hWS = get_param('sldemo_mdlref_counter_datamngt', 'ModelWorkspace');
hWS.DataSource = 'MATLAB Code';
hWS.MATLABCode = 'sldemo_mdlref_counter_datamngt_wsdata';
hWS.reload;
set_param('sldemo_mdlref_counter_datamngt', ...
          'ParameterArgumentNames', 'CounterParams,CounterICs');</pre><p>4. 参照モデルがどのようにモデル引数を使用するかを調べます。</p><p>参照モデル内のいくつかのブロックがモデル引数を使用します。</p><div><ul><li>Constant ブロックは、インクリメント量 (CounterParams.Increment) を指定します。</li><li>&quot;Range Check&quot; サブシステム内のさまざまなブロックは、上限および下限 (CounterParams.LowerLimit および CounterParams.UpperLimit) の値を使用します。</li><li>さまざまなブロックがカウンターの初期条件 (CounterICs.Count) を使用します。</li><li>ルートの Outport ブロックは、初期条件構造体 (CounterICs) を使用して、実行前にシステム出力を初期化します。</li></ul></div><p><b>Simulink.findVars</b> を使用して、モデル引数を使用するブロックを確認することができます。</p><pre>paramInfo = Simulink.findVars('sldemo_mdlref_counter_datamngt', ...
                              'Name', 'CounterParams');
icInfo    = Simulink.findVars('sldemo_mdlref_counter_datamngt', ...
                              'SearchMethod', 'cached', ...
                              'Name',         'CounterICs');
paramBlks = paramInfo.UsedByBlocks
icBlks    = icInfo.UsedByBlocks</pre><pre class="codeoutput">
paramBlks = 

    'sldemo_mdlref_counter_datamngt/Increment'
    'sldemo_mdlref_counter_datamngt/Range Check/Detect Overflow'
    'sldemo_mdlref_counter_datamngt/Range Check/Saturate Count'


icBlks = 

    'sldemo_mdlref_counter_datamngt/Initial Count'
    'sldemo_mdlref_counter_datamngt/Previous Count'
    'sldemo_mdlref_counter_datamngt/outputs'

</pre><p><b>メモ:</b> モデルをコンパイルすると、Simulink.findVars を使用して <b>'cached'</b> 変数の使用情報を取得できます。</p><h2>参照モデル: 出力バス信号の形状の定義<a name="16"></a></h2><p>参照モデルは、2 つの結果を生成し、バス信号にパッケージ化します。</p><div><ul><li><b>Count: </b> カウンターの値 (8 ビット整数)</li><li><b>OverflowState: </b> カウンターが上限、下限、または範囲内かを示す列挙値</li></ul></div><p><b>参照モデルのルート出力のバス タイプを定義するには:</b></p><p>1. <a href="matlab:buseditor">バス エディター</a>を使用してバス オブジェクト (OutputType) を定義します。</p><p><img vspace="5" hspace="5" src="../sldemo_mdlref_datamngt_snapshot_03.png" alt=""> </p><p>または、MATLAB コマンド ラインでバス オブジェクトを作成することもできます。</p><pre>OutputType = Simulink.Bus;
OutputType.Elements = Simulink.BusElement;
OutputType.Elements(1).Name = 'Count';
OutputType.Elements(1).DataType = 'int8';
OutputType.Elements(2) = Simulink.BusElement;
OutputType.Elements(2).Name = 'OverflowState';
OutputType.Elements(2).DataType = 'Enum:SlDemoRangeCheck';</pre><p>2. 参照モデルのルートの出力端子を設定して、このバス オブジェクト (OutputType) に基づいて非バーチャルのバス信号を出力します。</p><p><img vspace="5" hspace="5" src="../sldemo_mdlref_datamngt_snapshot_04.png" alt=""> </p><p>または、MATLAB コマンド ラインからブロック パラメーターを設定することもできます。</p><pre>set_param('sldemo_mdlref_counter_datamngt/outputs', ...
          'UseBusObject',      'on', ...
          'BusObject',         'OutputType', ...
          'BusOutputAsStruct', 'on');</pre><p>3. MATLAB スクリプトを作成して、このバス オブジェクトを再作成します。</p><p>このデモでは、MATLAB スクリプト (<a href="matlab:edit('sldemo_mdlref_datamngt_types');"><tt>sldemo_mdlref_datamngt_types</tt></a>) を使用して、参照モデルが使用するバス オブジェクトを再作成します。</p><p>この MATLAB スクリプトは、手動で作成するか、<b>Simulink.saveVars</b> を使用できます。</p><pre>Simulink.saveVars('sldemo_mdlref_counter_datamngt_types.m', 'OutputType');</pre><p>4. 参照モデルを設定して、参照モデルが使用するグローバル データを作成します。</p><p>モデルでは一般的に、モデルが使用するすべてのグローバル データおよび型を再作成します。このデモでは、参照モデルの <b>PreLoadFcn</b> を使用して、参照モデルのバス オブジェクトを作成する MATLAB スクリプトを実行します。参照モデルは、他のグローバル変数を使用しません。</p><p>モデルの <b>PreLoadFcn</b> を設定するには、モデルの [ファイル] <b></b>メニューから [モデル プロパティ] <b></b>ダイアログ ボックスを開くか、MATLAB コマンド ラインから設定します。</p><pre>set_param('sldemo_mdlref_counter_datamngt', ...
          'PreLoadFcn', 'sldemo_mdlref_counter_datamngt_types');</pre><p>5. モデル階層内でバス タイプがどのように使用されているかを調べます。</p><p>このバス タイプは、参照モデルのインターフェイスの一部を構成し、最上位モデルと参照モデルの両方のブロックにより参照されます。<b>find_mdlrefs</b> および <b>Simulink.findVars</b> を使用して、このバス オブジェクトが使用されているモデル参照階層内のすべての場所を確認します。</p><pre>models = find_mdlrefs('sldemo_mdlref_datamngt');
open_system(models);
varInfo = Simulink.findVars(models, 'Name', 'OutputType');
blks = vars.UsedByBlocks</pre><pre class="codeoutput">
models = 

    'sldemo_mdlref_counter_datamngt'
    'sldemo_mdlref_datamngt'


blks = 

    'sldemo_mdlref_counter_datamngt/Initial Count'
    'sldemo_mdlref_counter_datamngt/Previous Count'
    'sldemo_mdlref_counter_datamngt/Range Check/Bus Creator'
    'sldemo_mdlref_counter_datamngt/outputs'
    'sldemo_mdlref_datamngt/Counter1'
    'sldemo_mdlref_datamngt/Counter2'
    'sldemo_mdlref_datamngt/Counter3'

</pre><h2>参照モデル: バス出力の初期値の設定<a name="27"></a></h2><p>一般的に、バス信号と状態の初期値は、'0' と指定することができます。この場合、バスのすべての要素がゼロ (またはそれぞれのグラウンド値) に初期化されます。ただし、バス信号および状態にゼロ以外の初期値を指定することが望ましい場合があります。このデモでは、カウンターの初期状態を調整できるため、出力信号の初期値を常に設定しなければなりません。</p><p><b>参照モデルの出力の初期値を指定するには:</b></p><p>1. 初期化するバス信号と互換性があるパラメーター構造体を作成します。モデル引数の 1 つ (CounterICs) は、出力信号の形状と一致するパラメーター構造体です。この構造体は、次のように定義されています。</p><pre>CounterICs.Count         = int8(0);
CounterICs.OverflowState = SlDemoRangeCheck.InRange;</pre><p>または、静的メソッド <b>Simulink.Bus.createMATLABStruct</b> を使用して、OutputType のグランド値を使用する構造体を作成できます。</p><pre>CounterICs = Simulink.Bus.createMATLABStruct('OutputType');</pre><p>2. ルートの Outport のダイアログ ボックスを開き、[初期出力] <b></b>フィールドに構造体の名前 (CounterICs) を入力します。</p><p><img vspace="5" hspace="5" src="../sldemo_mdlref_datamngt_snapshot_05.png" alt=""> </p><p>または、MATLAB コマンド ラインからブロック パラメーターを設定することもできます。</p><pre>set_param('sldemo_mdlref_counter_datamngt/outputs', ...
          'InitialOutput', 'CounterICs');</pre><p><b>メモ: </b> 一般的に、バス信号または状態を初期化する場合、パラメーター構造体がバス タイプと正確に一致する必要はありませんが、そのフィールドがバス オブジェクトの要素のサブセットでなければならず、これらのフィールドの属性がバス オブジェクトの要素と一致しなければなりません。</p><h2>参照モデル: マスクした Model ブロックの作成<a name="32"></a></h2><p>通常、Model ブロックをマスクしてユーザー インターフェイスをカスタマイズすると便利です。 このデモでは、基礎になる Model ブロックのモデル引数に対して、1 つのマスク パラメーターでマスクを作成します。  再利用しやすくするために、マスクされた Model ブロックをライブラリに配置して、マスクをライブラリ ブロックで定義できます。</p><p>ライブラリを開き、マスクされた Model ブロック (<a href="matlab:open_system('sldemo_mdlref_counter_datamngt_lib')"><tt>sldemo_mdlref_counter_datamngt_lib</tt></a>) を表示します。</p><h2>最上位モデル: Model ブロックのパラメーター化<a name="33"></a></h2><p>参照モデルは、そのモデル引数の構造体を受け入れるように設定されています。 このデモでは、パラメーター値の異なる参照モデルの各インスタンスを呼び出します。</p><p>1. 最上位モデル (<a href="matlab:open_system('sldemo_mdlref_datamngt');"><tt>sldemo_mdlref_datamngt</tt></a>) を開きます。</p><p><img vspace="5" hspace="5" src="../sldemo_mdlref_datamngt2_01.png" alt=""> </p><p>2. 参照モデルで定義されたモデル引数と同じ &quot;形状&quot; のパラメーター構造体を作成します。</p><pre>Param1.Increment  = int8(1);
Param1.LowerLimit = int8(-20);
Param1.UpperLimit = int8(20);</pre><pre>Param2 = Param1;
Param2.Increment  = int8(2);</pre><pre>IC1.Count         = int8(0);
IC1.OverflowState = SlDemoRangeCheck.InRange;</pre><pre>IC2 = IC1;
IC2.Count = int8(-10);</pre><p>3. これらのパラメーターを使用するように、マスクした Model ブロックのマスク パラメーターを設定します。</p><p>たとえば、最初の Model ブロック (<a href="matlab:open_system('sldemo_mdlref_datamngt/Counter1');"><tt>'sldemo_mdlref_datamngt/Counter1'</tt></a>) のパラメーターは次のように設定されています。</p><div><ul><li><b>カウンター パラメーター</b>は <b>Param1</b></li><li><b>初期条件</b>は <b>IC1</b></li></ul></div><p><img vspace="5" hspace="5" src="../sldemo_mdlref_datamngt_snapshot_06.png" alt=""> </p><p>または、MATLAB コマンド ラインからブロック パラメーターを設定することもできます。</p><pre>set_param('sldemo_mdlref_datamngt/Counter1', ...
          'Params', 'Param1', ...
          'ICs',    'IC1');</pre><p>3. MATLAB スクリプトを作成して、これらのワークスペース変数を再作成します。</p><p>このデモでは、MATLAB スクリプト (<a href="matlab:edit('sldemo_mdlref_datamngt_wsdata');"><tt>sldemo_mdlref_datamngt_wsdata</tt></a>) を使用して、これらのワークスペース変数を再作成します。</p><p>この MATLAB スクリプトは、手動で作成するか、<b>Simulink.saveVars</b> を使用できます。</p><pre>Simulink.saveVars('sldemo_mdlref_datamngt_wsdata.m', 'Param*');</pre><p>4. 最上位モデルを設定して、すべてのグローバル変数を作成します。</p><p>最上位モデルで、モデル参照階層を通して使用されるすべてのグローバル データと型を再作成することをお勧めします。  この設定により、最上位モデルをシミュレートするとき、参照モデルを読み込む必要がなくなります。</p><p>このデモでは、最上位モデルの <b>PreLoadFcn</b> を使用して、最上位モデルのワークスペース データと参照モデルの型を作成する MATLAB スクリプトを実行します。  参照モデルは、グローバル データを使用しません。</p><pre>set_param('sldemo_mdlref_datamngt', ...
          'PreLoadFcn', ['sldemo_mdlref_datamngt_wsdata; ', ...
                         'sldemo_mdlref_counter_datamngt_types']);</pre><h2>最上位モデル: 参照モデルの呼び出しのスケジューリング<a name="42"></a></h2><p>前述のように、参照モデルは、2 つのトリガー入力の制限カウンター アルゴリズムを実装します。  このアルゴリズムは、トリガー入力の &quot;立ち上がりエッジ&quot; を検出して、次のように動作します。</p><div><ul><li>最初のトリガー入力が変化したら、カウンターをリセットする。</li><li>2 番目の入力が変化したら、指定した量だけカウンターをインクリメントする。</li></ul></div><p>このデモでは、Stimulus サブシステムにより生成される同じトリガー入力で、カウンター アルゴリズムの 3 つのインスタンスのすべてを駆動します。  トリガー入力の周期とサンプル時間は、Stimulus サブシステムのマスク パラメーターに入力された値によって定義されます。</p><div><ul><li>カウンターを 4 秒ごとにリセットする。</li><li>カウンターを毎秒 5 回インクリメントする (周期 = 0.2 秒)。</li><li>サンプル時間は 0.1 秒である。</li></ul></div><p><b>メモ: </b> リセット周期とインクリメント周期は、サンプル時間の 2 倍以上でなければなりません。</p><h2>最上位モデルのシミュレーション<a name="43"></a></h2><p>1. 参照モデルを保存するか、閉じます。</p><p>最上位モデルで参照モデルを使用するには、参照モデルを保存する必要があります。 または、参照モデルを閉じ、このデモに提供されている元のバージョンのモデルを使用できます。</p><p>2. [シミュレーション]<b></b> メニューから [開始]<b></b> を選択するか、<b>Ctrl+T</b> を押して最上位モデルをシミュレートします。</p><p><a href="matlab:sim('sldemo_mdlref_datamngt');"><tt>sim('sldemo_mdlref_datamngt')</tt></a></p><p><b>メモ: </b> 最上位モデルをシミュレートすると、参照モデルのシミュレーション ターゲットが自動的に生成されます。</p><p>3. Scope ブロックに表示されたシミュレーション結果を確認します。</p><img vspace="5" hspace="5" src="../sldemo_mdlref_datamngt2_03.png" alt=""> <img vspace="5" hspace="5" src="../sldemo_mdlref_datamngt2_04.png" alt=""> <img vspace="5" hspace="5" src="../sldemo_mdlref_datamngt2_05.png" alt=""> <h2>最上位モデルのコードの生成 (Real-Time Workshop が必要)<a name="48"></a></h2><p>[ツール]<b></b> メニューから [Real-Time Workshop]、[モデルのビルド]<b></b> を選択するか <b>Ctrl+B</b> を押して、コードを生成し、最上位モデルのスタンドアロンの実行ファイルを作成します。</p><p><a href="matlab:rtwbuild('sldemo_mdlref_datamngt');"><tt>rtwbuild('sldemo_mdlref_datamngt')</tt></a></p><p><b>メモ: </b> 最上位モデルのコードを生成すると、Real-Time Workshop は、自動的に参照モデルのコードを生成します。 Real-Time Workshop&reg; Embedded Coder™ を使用して、量産用の組み込みコードを生成します。</p><h2>モデル引数の型名の制御<a name="50"></a></h2><p>既定の設定では、Real-Time Workshop は、パラメーター構造体の型名を自動的に生成します。  この名前は、一意で確定的ですが、認識が難しくなります。  Simulink.Parameter オブジェクトを使用して、型を定義するパラメーター構造体と Simulink.Bus オブジェクトを定義することで、この型名を制御することができます。</p><p>1. <a href="matlab:buseditor">バス エディター</a>を使用するか、MATLAB コマンド ラインに次のコマンドを入力してモデル引数のバス タイプを定義します。</p><pre>CounterParamType = Simulink.Bus;
CounterParamType.Elements = Simulink.BusElement;
CounterParamType.Elements(1).Name     = 'Increment';
CounterParamType.Elements(1).DataType = 'int8';
CounterParamType.Elements(2) = Simulink.BusElement;
CounterParamType.Elements(2).Name     = 'LowerLimit';
CounterParamType.Elements(2).DataType = 'int8';
CounterParamType.Elements(3) = Simulink.BusElement;
CounterParamType.Elements(3).Name     = 'UpperLimit';
CounterParamType.Elements(3).DataType = 'int8';</pre><p>2. 既存の MATLAB スクリプトを変更してこのバス オブジェクトを再作成します。</p><p>このバス タイプは、参照モデルの出力のバス タイプと共に、ベース ワークスペースに定義されていなければなりません。  参照モデルの型を定義する MATLAB スクリプトを手動で変更するか、<b>Simulink.saveVars</b> を使用してこの変数を既存の MATLAB スクリプトに付加できます。</p><pre>Simulink.saveVars('sldemo_mdlref_counter_datamngt_types.m', 'CounterParamType', '-append');</pre><p>3. Simulink.Parameters を作成して、モデル引数を定義します。</p><p>バス タイプをモデル引数と関連付けるには、参照モデルのモデル ワークスペースで、MATLAB 構造体の代わりに Simulink.Parameter オブジェクトを使用しなければなりません。</p><pre>CounterParams = Simulink.Parameter;
CounterParams.Value.Increment  = 1;
CounterParams.Value.LowerLimit = -10;
CounterParams.Value.UpperLimit = 10;
CounterParams.DataType = 'Bus: CounterParamType';</pre><pre>CounterICs = Simulink.Parameter;
CounterICs.Value.Count         = 0;
CounterICs.Value.OverflowState = SlDemoRangeCheck.InRange;
CounterICs.DataType = 'Bus:OutputType';</pre><p><b>メモ:</b> パラメーター オブジェクトのデータ型をバス タイプに設定した場合、パラメーター構造体の数値フィールドに倍精度値を使用できます。Simulink は、モデルのコンパイル中に、これらの倍精度値を適切な数値データ型に変換します。</p><p>モデル引数を定義する MATLAB スクリプトを手動で変更するか、<b>Simulink.saveVars</b> を使用して既存の MATLAB スクリプトを更新できます。</p><pre>Simulink.saveVars('sldemo_mdlref_counter_datamngt_wsdata.m', '-update');</pre><p><b>メモ:</b> <b>-update</b> オプションを使用すると、<b>Simulink.saveVars</b> により、MATLAB スクリプトで既に定義されている変数の値のみが書き出されるため、書き出す変数を指定する必要がありません。</p><p>5. モデル ワークスペースの内容を再読み込みします。</p><p>これで、参照モデルのワークスペースで使用されるデータ ソースが変更されました。このモデルが開いている場合は、モデル ワークスペースの内容を再読み込みしなければなりません。</p><p>モデル ワークスペースのダイアログ ボックスを使用するか、MATLAB コマンド ラインから再読み込みすることができます。</p><pre>hWS = get_param('sldemo_mdlref_counter_datamngt', 'ModelWorkspace');
hWS.reload;</pre><h2>最上位モデルにおけるパラメーター表現の制御<a name="60"></a></h2><p>同じアプローチを使用して、Simulink.Parameter オブジェクトを使用するように最上位モデルのパラメーター構造体を変換することができます。この設定では、型名に加え、生成コードにおけるこれらのパラメーターの表示方法を制御できるようになります。</p><p>1. ExportedGlobal ストレージ クラスを使用して Simulink.Parameter オブジェクトを作成し、エクスポートされた調整可能な生成コード内の変数として、最上位モデルのパラメーター構造体を定義します。</p><pre>Param1 = Simulink.Parameter;
Param1.Value.Increment  = 1;
Param1.Value.LowerLimit = -10;
Param1.Value.UpperLimit = 10;
Param1.DataType = 'Bus:CounterParamType';
Param1.RTWInfo.StorageClass = 'ExportedGlobal';</pre><pre>Param2 = Param1.deepCopy;
Param2.Value.Increment = 2;</pre><pre>IC1 = Simulink.Parameter;
IC1.Value.Count = 0;
IC1.Value.OverflowState = SlDemoRangeCheck.InRange;
IC1.DataType = 'Bus:OutputType';
IC1.RTWInfo.StorageClass = 'ExportedGlobal';</pre><pre>IC2 = IC1.deepCopy;
IC2.Value.Count = -10;</pre><p>2. 既存の MATLAB スクリプトを変更して、これらのワークスペース変数を再作成します。</p><p>最上位モデルのパラメーターを定義する MATLAB スクリプトを手動で変更するか、<b>Simulink.saveVars</b> を使用して既存の MATLAB スクリプトを更新できます。</p><pre>Simulink.saveVars('sldemo_mdlref_datamngt_wsdata.m', '-update');</pre><p><b>メモ:</b> <b>-update</b> オプションを使用すると、<b>Simulink.saveVars</b> により、MATLAB スクリプトで既に定義されている変数の値のみが書き出されるため、書き出す変数を指定する必要がありません。</p><h2>最上位モデルのコードの再生成 (Real-Time Workshop が必要)<a name="64"></a></h2><p>[ツール]<b></b> メニューから [Real-Time Workshop]、[モデルのビルド]<b></b> を選択するか <b>Ctrl+B</b> を押して、コードを生成し、最上位モデルのスタンドアロンの実行ファイルを作成します。</p><p><a href="matlab:rtwbuild('sldemo_mdlref_datamngt');"><tt>rtwbuild('sldemo_mdlref_datamngt')</tt></a></p><p class="footer">Copyright 1990-2010 The MathWorks, Inc.<br>Published with MATLAB&reg; 7.11</p><p class="footer" id="trademarks">MATLAB and Simulink are registered trademarks of The MathWorks, Inc.  Please see <a href="http://www.mathworks.com/trademarks">www.mathworks.com/trademarks</a> for a list of other trademarks owned by The MathWorks, Inc.  Other product or brand names are trademarks or registered trademarks of their respective owners.</p></div><!-- ##### SOURCE BEGIN ##### %% Detailed Workflow for Managing Data with Model Reference % This demo describes a number of tools and techniques that make up % a workflow for managing data with model reference. % % For a basic introduction to this topic, see: <sldemo_mdlref_datamngt.html Introduction to Managing Data with Model Reference>.  %   Copyright 1990-2010 The MathWorks, Inc. %   $Revision: 1.1.4.2.2.1 $  $Date: 2010/07/29 21:29:17 $  %% Demo Requirements % During this demo, Simulink(R) and Real-Time Workshop(R) generate code % in a Simulink project directory created in the current directory. % If you do not want to (or if you cannot) generate files in this % directory, you should change your working directory. Real-Time Workshop % is required to generate model reference binaries to be deployed in % standalone applications. %  % *If you plan to alter the demo models:* %  % 1. Preserve the demo in its original state by copying the following files % from your MATLAB(R) installation directory, without changing their names, % to a different directory:      % %  toolbox/simulink/simdemos/simfeatures/sldemo_mdlref_datamngt.mdl %  toolbox/simulink/simdemos/simfeatures/sldemo_mdlref_datamngt_wsdata.m %  toolbox/simulink/simdemos/simfeatures/sldemo_mdlref_counter_datamngt.mdl %  toolbox/simulink/simdemos/simfeatures/sldemo_mdlref_counter_datamngt_lib.mdl %  toolbox/simulink/simdemos/simfeatures/sldemo_mdlref_counter_datamngt_types.m %  toolbox/simulink/simdemos/simfeatures/sldemo_mdlref_counter_datamngt_wsdata.m % % 2. Change your current directory to the directory to which you copied the files. % % 3. Continue with the demo.  % DEVELOPER COMMENT: % REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH % CANNOT TAKE QT SNAPSHOTS IN BaT BECAUSE IT RELIES ON SCREEN CAPTURE. % ==> TAKE SNAPSHOTS IN A PC SANDBOX AND SUBMIT WITH DEMO. takeSnapshots = false; if evalin('base', 'exist(''TakeDemoSnapshots'', ''var'');');   takeSnapshots = evalin('base', 'TakeDemoSnapshots'); end  origPath = addpath(fullfile(matlabroot, 'toolbox', 'simulink', 'internal')); workDir = tempname; mkdir(workDir); origDir  = cd(workDir); addpath(origDir);  %% Open the Demo Model % <matlab:open_system('sldemo_mdlref_datamngt'); |open_system('sldemo_mdlref_datamngt')|> open_system('sldemo_mdlref_datamngt');  close_system('sldemo_mdlref_datamngt/Scope1'); close_system('sldemo_mdlref_datamngt/Scope2'); close_system('sldemo_mdlref_datamngt/Scope3');  %% Demo Content % This demo uses a top model (<matlab:open_system('sldemo_mdlref_datamngt') |sldemo_mdlref_datamngt|>) % that contains three Model blocks: Counter1, Counter2, and Counter3. % These blocks reference the same model % (<matlab:open_system('sldemo_mdlref_counter_datamngt'); |sldemo_mdlref_counter_datamngt|>). % % The referenced model implements a limited counter algorithm that: % % * Resets the counter if the first trigger input changes % * Increments the counter by a specified amount if the second input changes % * Saturates the counter between the specified upper and lower limits % % The referenced model outputs a bus signal that contains: % % * *Count:* the value of the counter as an 8-bit integer % * *OverflowState:* an enumerated value that indicates whether the counter is % at the upper limit, lower limit, or in range % % This model is configured to show a number of Simulink features working together: %  % * *Tunable parameter structures:* Collect variables into a MATLAB structure % that parameterizes the model. In this demo, the model arguments of the referenced % model are defined as parameter structures. % * *Model arguments:* Pass different parameter values to each model % reference instance. % * *Bus objects:* Define the "shape" of structures for signals and parameters % used in the model reference interface. Define type name for structure % parameters and signals in generated code. % * *Simulink.Bus.createMATLABStruct:* Static method for creating a MATLAB % structure that matches the shape of the bus object. % * *Bus initialization:* Uses a parameter structure to initialize bus signals % and states. % * *Masked Model block:* Creates a customized interface for a model % reference block. % * *Triggered model reference:* Explicit control over scheduling of components. % % This demo also uses other features that are useful for managing data in % Simulink: % % * *Simulink.saveVars:* Serialize workspace variables to a MATLAB script. % Supports incremental modification, data differencing, and version control. % * *Simulink.findVars:* Discover how workspace variables are used by a model.  %% Demo Outline % *The sequence of steps in the demo is as follows:* % % 1. Prepare the referenced model (|sldemo_mdlref_counter_datamngt|) to use % structures for the signals and parameters in its external interface. % % 2. Prepare the top model (|sldemo_mdlref_datamngt|) to call the % referenced model. % % 3. Simulate the top model and examine the results. % % 4. Generate code to create a standalone executable for the top model.  %% Referenced Model: Setting Up Parameters % The referenced model has two model arguments (CounterParams, CounterICs) % that parameterize the blocks in the model. Model arguments provide % different parameter values to each instance of a referenced model. In % this model, the arguments are defined as parameter structures to reduce % the number of arguments being passed to the referenced model. % % *The process for defining the model arguments is as follows:*  %% % 1. Open the referenced model (<matlab:open_system('sldemo_mdlref_counter_datamngt'); |sldemo_mdlref_counter_datamngt|>). open_system('sldemo_mdlref_counter_datamngt');  %% % 2. Define MATLAB structures to parameterize the referenced model. % %  CounterParams.Increment  = int8(1); %  CounterParams.LowerLimit = int8(-10); %  CounterParams.UpperLimit = int8(10); % %  CounterICs.Count         = int8(0); %  CounterICs.OverflowState = SlDemoRangeCheck.InRange; CounterParams.Increment  = int8(1); CounterParams.LowerLimit = int8(-10); CounterParams.UpperLimit = int8(10);  CounterICs.Count         = int8(0); CounterICs.OverflowState = SlDemoRangeCheck.InRange;  clear CounterParams CounterICs;  %% % *NOTE:* This demo uses an 8-bit integer for the counter, so the numeric fields % also use 8-bit integers.  %% % 3. Use the MATLAB structures as model arguments. % % Model arguments are defined as variables in the model workspace of a referenced % model.  You can use the <matlab:daexplr; Model Explorer> to view and edit the % contents of the model workspace. % % <<sldemo_mdlref_datamngt_snapshot_01.png>>  if takeSnapshots   modelObj = get_param('sldemo_mdlref_counter_datamngt', 'Object');   children = modelObj.getChildren;   wsNode   = children(1);   assert(isa(wsNode, 'DAStudio.WorkspaceNode'));      me = daexplr;   imme = DAStudio.imExplorer(me);   imme.selectTreeViewNode(wsNode);   me.showDialogView(false);   me.position = [0 0 840 400];    take_qt_snapshot(me, [origDir, filesep, 'sldemo_mdlref_datamngt_snapshot_01.png'], 'png'); end  %% % You can initialize the model workspace from a number of different data sources. % This demo uses a MATLAB script (<matlab:edit('sldemo_mdlref_counter_datamngt_wsdata'); |sldemo_mdlref_counter_datamngt_wsdata|>) % to create the parameter structures to define the model arguments.  Using a % MATLAB script makes it easy to create and modify the parameter structure % outside the model.  It also facilitates incremental changes, version control, % and data differencing. % % You can create the MATLAB script manually, or use *Simulink.saveVars*: % %  Simulink.saveVars('sldemo_mdlref_counter_datamngt_wsdata.m', 'CounterParams', 'CounterICs');  %% % Set the workspace's *Data source* to create the MATLAB structure in the % model workspace and enter the variable name (CounterParams) into the % *Model arguments* field in the model workspace's dialog box. % % <<sldemo_mdlref_datamngt_snapshot_02.png>>  if takeSnapshots   dlg = DAStudio.Dialog(wsNode);   take_qt_snapshot(dlg, [origDir, filesep, 'sldemo_mdlref_datamngt_snapshot_02.png'], 'png'); end  %% % Alternatively, you can configure the model workspace from the MATLAB command line: % %  hWS = get_param('sldemo_mdlref_counter_datamngt', 'ModelWorkspace'); %  hWS.DataSource = 'MATLAB Code'; %  hWS.MATLABCode = 'sldemo_mdlref_counter_datamngt_wsdata'; %  hWS.reload; %  set_param('sldemo_mdlref_counter_datamngt', ... %            'ParameterArgumentNames', 'CounterParams,CounterICs'); hWS = get_param('sldemo_mdlref_counter_datamngt', 'ModelWorkspace'); hWS.DataSource = 'MATLAB Code'; hWS.MATLABCode = 'sldemo_mdlref_counter_datamngt_wsdata'; hWS.reload; set_param('sldemo_mdlref_counter_datamngt', ...           'ParameterArgumentNames', 'CounterParams,CounterICs');  %% % 4. Explore how the referenced model uses the model arguments. %% % A number of blocks in the referenced model use the model arguments: % % * A Constant block specifies the increment amount (CounterParams.Increment). % * Various blocks inside the "Range Check" subsystem use the values of the % lower and upper limits (CounterParams.LowerLimit and CounterParams.UpperLimit). % * Various blocks use the initial condition of the counter (CounterICs.Count). % * The root Outport block uses the initial condition structure (CounterICs) % to initialize the system output prior to execution. % % You can use *Simulink.findVars* to discover the blocks that use the % model argument. % %  paramInfo = Simulink.findVars('sldemo_mdlref_counter_datamngt', ... %                                'Name', 'CounterParams'); %  icInfo    = Simulink.findVars('sldemo_mdlref_counter_datamngt', ... %                                'SearchMethod', 'cached', ... %                                'Name',         'CounterICs'); %  paramBlks = paramInfo.UsedByBlocks %  icBlks    = icInfo.UsedByBlocks paramInfo = Simulink.findVars('sldemo_mdlref_counter_datamngt', ...                               'Name', 'CounterParams'); icInfo    = Simulink.findVars('sldemo_mdlref_counter_datamngt', ...                               'SearchMethod', 'cached', ...                               'Name',         'CounterICs'); paramBlks = paramInfo.UsedByBlocks %#ok PUBLISH COMMAND-LINE OUTPUT icBlks    = icInfo.UsedByBlocks    %#ok PUBLISH COMMAND-LINE OUTPUT  %% % *NOTE:* Once you have compiled the model, you can use Simulink.findVars to retrieve the % *'cached'* variable usage information.  %% Referenced Model: Defining the Shape of the Output Bus Signal % The referenced model produces two results and packages them into a bus signal: % % * *Count:* the value of the counter as an 8-bit integer % * *OverflowState:* an enumerated value that indicates whether the counter is % at the upper limit, lower limit, or in range  %% % *To define the bus type for the root output of the referenced model:* % % 1. Use the <matlab:buseditor Bus Editor> to define the bus object (OutputType). % % <<sldemo_mdlref_datamngt_snapshot_03.png>>  if takeSnapshots   buseditor;   be = BusEditor.getexplorer;   be.position = [0 0 840 400];   be.showDialogView(false);   imme = DAStudio.imExplorer(be);   imme.selectTreeViewNode(helpgetvtnofname(imme,'OutputType'));    take_qt_snapshot(be, [origDir, filesep, 'sldemo_mdlref_datamngt_snapshot_03.png'], 'png'); end  %% % Alternatively, you can create the bus object at the MATLAB command line: % %  OutputType = Simulink.Bus; %  OutputType.Elements = Simulink.BusElement; %  OutputType.Elements(1).Name = 'Count'; %  OutputType.Elements(1).DataType = 'int8'; %  OutputType.Elements(2) = Simulink.BusElement; %  OutputType.Elements(2).Name = 'OverflowState'; %  OutputType.Elements(2).DataType = 'Enum: SlDemoRangeCheck'; OutputType = Simulink.Bus; OutputType.Elements = Simulink.BusElement; OutputType.Elements(1).Name = 'Count'; OutputType.Elements(1).DataType = 'int8'; OutputType.Elements(2) = Simulink.BusElement; OutputType.Elements(2).Name = 'OverflowState'; OutputType.Elements(2).DataType = 'Enum: SlDemoRangeCheck';  %% % 2. Configure the root outport of the referenced model to output a nonvirtual % bus signal based on this bus object (OutputType). % % <<sldemo_mdlref_datamngt_snapshot_04.png>>  if takeSnapshots   open_system('sldemo_mdlref_counter_datamngt/outputs');      dlg = DAStudio.ToolRoot.getOpenDialogs;   dlg = find(dlg, 'dialogTag', 'Outport');   imd = DAStudio.imDialog.getIMWidgets(dlg);   tabs = get(find(imd, '-isa', 'DAStudio.imTabBar'), 'Tag');   dlg.setActiveTab(tabs, 1);    take_qt_snapshot(dlg, [origDir, filesep, 'sldemo_mdlref_datamngt_snapshot_04.png'], 'png');    close_system('sldemo_mdlref_counter_datamngt/outputs'); end  %% % Alternatively, you can set the block parameters from the MATLAB command line: % %  set_param('sldemo_mdlref_counter_datamngt/outputs', ... %            'UseBusObject',      'on', ... %            'BusObject',         'OutputType', ... %            'BusOutputAsStruct', 'on'); set_param('sldemo_mdlref_counter_datamngt/outputs', ...           'UseBusObject',      'on', ...           'BusObject',         'OutputType', ...           'BusOutputAsStruct', 'on');  %% % 3. Create a MATLAB script to recreate this bus object. %% % This demo uses a MATLAB script (<matlab:edit('sldemo_mdlref_datamngt_types'); |sldemo_mdlref_datamngt_types|>) % to recreate the bus objects used by the referenced model. % % You can create this MATLAB script manually, or use *Simulink.saveVars*: % %  Simulink.saveVars('sldemo_mdlref_counter_datamngt_types.m', 'OutputType');  %% % 4. Configure the referenced model to create the global data that it uses. %% % It is common practice for a model to recreate all of the global data and % types that it uses.  In this demo, the referenced model's *PreLoadFcn* is used % to execute the MATLAB script that creates the bus objects for the referenced model. % The referenced model does not use any other global variables. % % To set the model's *PreLoadFcn*, open the *Model Properties* dialog box from % the model's *File* menu or set it from the MATLAB command line. % %  set_param('sldemo_mdlref_counter_datamngt', ... %            'PreLoadFcn', 'sldemo_mdlref_counter_datamngt_types'); set_param('sldemo_mdlref_counter_datamngt', ...           'PreLoadFcn', 'sldemo_mdlref_counter_datamngt_types');  %% % 5. Explore how the bus type is used in the model hierarchy. %% % This bus type forms part of the interface for the referenced model and is % referred to by blocks in both the top and referenced models.  Use % *find_mdlrefs* and *Simulink.findVars* to find out about all the places % where this bus object is used in the model reference hierarchy. % %  models = find_mdlrefs('sldemo_mdlref_datamngt'); %  open_system(models); %  varInfo = Simulink.findVars(models, 'Name', 'OutputType'); %  blks = vars.UsedByBlocks models = find_mdlrefs('sldemo_mdlref_datamngt') %#ok PUBLISH COMMAND-LINE OUTPUT open_system(models);  % DEVELOPER COMMENT: NEED TO USE EVALC TO HIDE COMMAND-LINE OUTPUT WHEN PUBLISHING evalc('varInfo = Simulink.findVars(models, ''Name'', ''OutputType'');');  blks = varInfo.UsedByBlocks                           %#ok PUBLISH COMMAND-LINE OUTPUT  %% Referenced Model: Setting Initial Value for Bus Output % In general, the initial values for bus signals and states can be specified as '0', % in which case all of the elements of the bus will be initialized to zero (or the % relevant ground value). However, in certain cases, it is desirable to specify % nonzero initial values for bus signals and states.  In this demo, the initial % condition of the counter is tunable, so the initial value of output signal must % be set consistently. % % *To specify the initial value of the output of the referenced model:* % % 1. Create a parameter structure that is compatible with the bus signal that % you want to initialize.  One of the model arguments (CounterICs) is a parameter % structure that matches the shape of the output signal.  This structure was % defined as follows: % %  CounterICs.Count         = int8(0); %  CounterICs.OverflowState = SlDemoRangeCheck.InRange; CounterICs.Count         = int8(0); CounterICs.OverflowState = SlDemoRangeCheck.InRange;  %% % Alternatively, you could have used the static method, *Simulink.Bus.createMATLABStruct* % to create the structure using the ground value of the OutputType. % %  CounterICs = Simulink.Bus.createMATLABStruct('OutputType'); CounterICs = Simulink.Bus.createMATLABStruct('OutputType'); %#ok  %% % 2. Open the dialog box for the root outport and enter the name of the % structure (CounterICs) into the *Initial output* field. % % <<sldemo_mdlref_datamngt_snapshot_05.png>>  if takeSnapshots   open_system('sldemo_mdlref_counter_datamngt/outputs');      dlg = DAStudio.ToolRoot.getOpenDialogs;   dlg = find(dlg, 'dialogTag', 'Outport');   imd = DAStudio.imDialog.getIMWidgets(dlg);   tabs = get(find(imd, '-isa', 'DAStudio.imTabBar'), 'Tag');   dlg.setActiveTab(tabs, 0);    take_qt_snapshot(dlg, [origDir, filesep, 'sldemo_mdlref_datamngt_snapshot_05.png'], 'png');    close_system('sldemo_mdlref_counter_datamngt/outputs'); end  %% % Alternatively, you can set the block parameters from the MATLAB command line: % %  set_param('sldemo_mdlref_counter_datamngt/outputs', ... %            'InitialOutput', 'CounterICs'); set_param('sldemo_mdlref_counter_datamngt/outputs', ...           'InitialOutput', 'CounterICs');  %% % *NOTE:* In general, when initializing a bus signal or state, the parameter % structure does not need to match the bus type exactly, but its fields must be % a subset of the elements in the bus object and the attributes of these fields % must match the elements in the bus object.  %% Referenced Model: Creating a Masked Model Block % It is often useful to mask Model blocks to customize the user interface. % This demo creates a mask with a single mask parameter, for the model argument % of the underlying Model block.  To facilitate reuse, you can put the masked % Model block into a library and define the mask on the library block. % % Open the library to see the masked Model block % (<matlab:open_system('sldemo_mdlref_counter_datamngt_lib') |sldemo_mdlref_counter_datamngt_lib|>).  %% Top Model: Parameterizing Model Blocks % The referenced model is configured to accept a structure for its model % argument. This demo calls each instance of the referenced model with % different parameter values. % % 1. Open the top model (<matlab:open_system('sldemo_mdlref_datamngt'); |sldemo_mdlref_datamngt|>).  % DEVELOPER COMMENT: HARD-CODED FILE NAME = SAME AS FIRST IMAGE IN THE DOCUMENT  %% % <<sldemo_mdlref_datamngt2_01.png>>  %% % 2. Create parameter structures with the same "shape" as the model % arguments defined in the referenced model. % %  Param1.Increment  = int8(1); %  Param1.LowerLimit = int8(-20); %  Param1.UpperLimit = int8(20); %   %  Param2 = Param1; %  Param2.Increment  = int8(2); % %  IC1.Count         = int8(0); %  IC1.OverflowState = SlDemoRangeCheck.InRange; % %  IC2 = IC1; %  IC2.Count = int8(-10); clear Param1 Param2 IC1 IC2; Param1.Increment  = int8(1); Param1.LowerLimit = int8(-20); Param1.UpperLimit = int8(20);  Param2 = Param1; Param2.Increment  = int8(2);  IC1.Count         = int8(0); IC1.OverflowState = SlDemoRangeCheck.InRange;  IC2 = IC1; IC2.Count = int8(-10);  %% % 3. Set the mask parameters on the masked Model blocks to use these parameters. % % For example, the parameters of the first Model block % (<matlab:open_system('sldemo_mdlref_datamngt/Counter1'); |'sldemo_mdlref_datamngt/Counter1'|>) % are set as: %  % * *Param1* for the *Counter parameters* % * *IC1* for the *Initial conditions* % % <<sldemo_mdlref_datamngt_snapshot_06.png>>  if takeSnapshots   open_system('sldemo_mdlref_datamngt/Counter1');      dlg = DAStudio.ToolRoot.getOpenDialogs;   dlg = find(dlg, 'dialogTag', 'ModelReference.SlDemoMdlRefCounter');    take_qt_snapshot(dlg, [origDir, filesep, 'sldemo_mdlref_datamngt_snapshot_06.png'], 'png');    close_system('sldemo_mdlref_datamngt/Counter1'); end  %% % Alternatively, you can set the block parameters from the MATLAB command line: % %  set_param('sldemo_mdlref_datamngt/Counter1', ... %            'Params', 'Param1', ... %            'ICs',    'IC1'); set_param('sldemo_mdlref_datamngt/Counter1', 'Params', 'Param1', 'ICs', 'IC1'); set_param('sldemo_mdlref_datamngt/Counter2', 'Params', 'Param2', 'ICs', 'IC1'); set_param('sldemo_mdlref_datamngt/Counter3', 'Params', 'Param2', 'ICs', 'IC2');  %% % 3. Create a MATLAB script to recreate these workspace variables. %% % This demo uses a MATLAB script (<matlab:edit('sldemo_mdlref_datamngt_wsdata'); |sldemo_mdlref_datamngt_wsdata|>) % to recreate these workspace variables. % % You can create this MATLAB script manually, or use *Simulink.saveVars*: % %  Simulink.saveVars('sldemo_mdlref_datamngt_wsdata.m', 'Param*');  %% % 4. Configure the top model to create all global variables. %% % It is good practice for the top model to recreate all of the global data % and types used throughout the model reference hierarchy.  This configuration % avoids loading referenced models when simulating the top model. % % In this demo, the top model's *PreLoadFcn* is used to execute the MATLAB % scripts that create the workspace data for the top model and the types for % the referenced model.  The referenced model does not use any global data. % %  set_param('sldemo_mdlref_datamngt', ... %            'PreLoadFcn', ['sldemo_mdlref_datamngt_wsdata; ', ... %                           'sldemo_mdlref_counter_datamngt_types']); set_param('sldemo_mdlref_datamngt', ...           'PreLoadFcn', ['sldemo_mdlref_datamngt_wsdata; ', sprintf('\n'), ...                          'sldemo_mdlref_counter_datamngt_types']);  %% Top Model: Scheduling Calls to the Referenced Model % As mentioned earlier, the referenced model implements a limited counter % algorithm with two trigger inputs.  The algorithm detects "rising edges" % in the trigger inputs and reacts as follows: % % * Resets the counter if the first trigger input changes. % * Increments the counter by a specified amount if the second input changes. % % In this demo, you drive all three instances of the counter algorithm with % the same trigger inputs, generated by the Stimulus subsystem.  The period % and sample time of the trigger inputs are defined by the values entered % for the mask parameters of the Stimulus subsystem: % % * Reset counter every 4 seconds. % * Increment counter 5 times per second (period = 0.2 second). % * Sample time is 0.1 second. % % *NOTE:* Reset and increment periods must be at least 2 times the sample time.  %% Simulating the Top Model % 1. Save or close the referenced model. % % You need to save the referenced model before it can be used by the top model. % Alternatively, you can close the referenced model and use the original % version of the model provided with this demo.  % DEVELOPMENT COMMENT: % Clear dirty flag rather than closing referenced model so that we can  % test the code in this demo. set_param('sldemo_mdlref_counter_datamngt', 'Dirty', 'off');  %% % 2. Simulate the top model by selecting *Start* from the *Simulation* % menu or by typing *Ctrl+T*. % % <matlab:sim('sldemo_mdlref_datamngt'); |sim('sldemo_mdlref_datamngt')|>  %% % *NOTE:* Simulating the top model automatically generates a simulation % target for the referenced model.  %% % 3. Review the simulation results as displayed by the Scope blocks. open_system('sldemo_mdlref_datamngt/Scope1'); open_system('sldemo_mdlref_datamngt/Scope2'); open_system('sldemo_mdlref_datamngt/Scope3');  % DEVELOPER COMMENT: NEED TO USE EVALC TO HIDE COMMAND-LINE OUTPUT WHEN PUBLISHING evalc('sim(''sldemo_mdlref_datamngt'');');  %% close_system('sldemo_mdlref_datamngt/Scope1'); close_system('sldemo_mdlref_datamngt/Scope2'); close_system('sldemo_mdlref_datamngt/Scope3');  %% Generating Code for the Top Model (Requires Real-Time Workshop)  % Generate code and build a standalone executable for the top model by % selecting *Real-Time Workshop > Build Model* from the *Tools* menu or % by typing *Ctrl+B*. % % <matlab:rtwbuild('sldemo_mdlref_datamngt'); |rtwbuild('sldemo_mdlref_datamngt')|>  % DEVELOPER COMMENT: NEED TO USE EVALC TO HIDE COMMAND-LINE OUTPUT WHEN PUBLISHING evalc('rtwbuild(''sldemo_mdlref_datamngt'');');  %% % *NOTE:* When you generate code for the top model, Real-Time Workshop % automatically generates code for the referenced model. Use  % Real-Time Workshop(R) Embedded Coder(TM) to generate embedded code for  % production deployment.  %% Controlling the Type Name for the Model Argument % By default, Real-Time Workshop generates an automatic name for the type % of the parameter structures.  This name is unique and deterministic, but % not easy to recognize.  You can control this type name by using % Simulink.Parameter objects to define the parameter structures and % Simulink.Bus objects to define the type. % % 1. Define the bus type for the model argument by using the <matlab:buseditor Bus Editor> % or by typing the following commands at the MATLAB command line: % %  CounterParamType = Simulink.Bus; %  CounterParamType.Elements = Simulink.BusElement; %  CounterParamType.Elements(1).Name     = 'Increment'; %  CounterParamType.Elements(1).DataType = 'int8'; %  CounterParamType.Elements(2) = Simulink.BusElement; %  CounterParamType.Elements(2).Name     = 'LowerLimit'; %  CounterParamType.Elements(2).DataType = 'int8'; %  CounterParamType.Elements(3) = Simulink.BusElement; %  CounterParamType.Elements(3).Name     = 'UpperLimit'; %  CounterParamType.Elements(3).DataType = 'int8'; CounterParamType = Simulink.Bus; CounterParamType.Elements = Simulink.BusElement; CounterParamType.Elements(1).Name     = 'Increment'; CounterParamType.Elements(1).DataType = 'int8'; CounterParamType.Elements(2) = Simulink.BusElement; CounterParamType.Elements(2).Name     = 'LowerLimit'; CounterParamType.Elements(2).DataType = 'int8'; CounterParamType.Elements(3) = Simulink.BusElement; CounterParamType.Elements(3).Name     = 'UpperLimit'; CounterParamType.Elements(3).DataType = 'int8';  %% % 2. Modify the existing MATLAB script to recreate this bus object. %% % This bus type must be defined in the base workspace, along with the bus type % for the referenced model's output.  You can manually modify the MATLAB script % that defines the types for the referenced model or use *Simulink.saveVars* to % append this variable to the existing MATLAB script. % %  Simulink.saveVars('sldemo_mdlref_counter_datamngt_types.m', 'CounterParamType', '-append');  %% % 3. Create Simulink.Parameters to define the model arguments. %% % To associate the bus types with the model arguments, you must use % Simulink.Parameter objects in place of the MATLAB structures in % the model workspace of the referenced model. %   %  CounterParams = Simulink.Parameter; %  CounterParams.Value.Increment  = 1; %  CounterParams.Value.LowerLimit = -10; %  CounterParams.Value.UpperLimit = 10; %  CounterParams.DataType = 'Bus: CounterParamType'; %   %  CounterICs = Simulink.Parameter; %  CounterICs.Value.Count         = 0; %  CounterICs.Value.OverflowState = SlDemoRangeCheck.InRange; %  CounterICs.DataType = 'Bus: OutputType'; CounterParams = Simulink.Parameter; CounterParams.Value.Increment  = 1; CounterParams.Value.LowerLimit = -10; CounterParams.Value.UpperLimit = 10; CounterParams.DataType = 'Bus: CounterParamType';  CounterICs = Simulink.Parameter; CounterICs.Value.Count         = 0; CounterICs.Value.OverflowState = SlDemoRangeCheck.InRange; CounterICs.DataType = 'Bus: OutputType';  clear CounterParams CounterICs;  %% % *NOTE:* When you set the data type of a parameter object to be a bus, you can % use double-precision values for the numeric fields of the parameter % structure.  Simulink converts these double-precision values to the % appropriate numeric data type during model compilation.  %% % You can manually modify the MATLAB script that defines the model argument or % use *Simulink.saveVars* to update the existing MATLAB script. % %  Simulink.saveVars('sldemo_mdlref_counter_datamngt_wsdata.m', '-update');  %% % *NOTE:* When you use the *-update* option, you do not need to specify the % variables to be written out because *Simulink.saveVars* writes out only % the values of variables already defined in the MATLAB script.  %% % 5. Reload the contents of the model workspace. %% % You have modified the data source that is used by the referenced model's workspace. % If this model is open, you must reload the contents of the model workspace. % % You can reload by using the model workspace's dialog box or at the MATLAB command line. % %  hWS = get_param('sldemo_mdlref_counter_datamngt', 'ModelWorkspace'); %  hWS.reload; hWS = get_param('sldemo_mdlref_counter_datamngt', 'ModelWorkspace'); hWS.reload;  %% Controlling Representation of Parameters in the Top Model % You can use a similar approach to convert the parameter structures in the % top model to use Simulink.Parameter objects. This configuration gives you % control over the type name and enables you to control how these parameters % appear in the generated code. % % 1. Create Simulink.Parameter objects with the ExportedGlobal storage class % to define the parameter structures for the top model as a exported, tunable % variables in the generated code. % %  Param1 = Simulink.Parameter; %  Param1.Value.Increment  = 1; %  Param1.Value.LowerLimit = -10; %  Param1.Value.UpperLimit = 10; %  Param1.DataType = 'Bus: CounterParamType'; %  Param1.RTWInfo.StorageClass = 'ExportedGlobal'; %   %  Param2 = Param1.deepCopy; %  Param2.Value.Increment = 2; %   %  IC1 = Simulink.Parameter; %  IC1.Value.Count = 0; %  IC1.Value.OverflowState = SlDemoRangeCheck.InRange; %  IC1.DataType = 'Bus: OutputType'; %  IC1.RTWInfo.StorageClass = 'ExportedGlobal'; %   %  IC2 = IC1.deepCopy; %  IC2.Value.Count = -10; Param1 = Simulink.Parameter; Param1.Value.Increment  = 1; Param1.Value.LowerLimit = -10; Param1.Value.UpperLimit = 10; Param1.DataType = 'Bus: CounterParamType'; Param1.RTWInfo.StorageClass = 'ExportedGlobal';  Param2 = Param1.deepCopy; Param2.Value.Increment = 2;  IC1 = Simulink.Parameter; IC1.Value.Count = 0; IC1.Value.OverflowState = SlDemoRangeCheck.InRange; IC1.DataType = 'Bus: OutputType'; IC1.RTWInfo.StorageClass = 'ExportedGlobal';  IC2 = IC1.deepCopy; IC2.Value.Count = -10;  %% % 2. Modify the existing MATLAB script to recreate these workspace variables. %% % You can manually modify the MATLAB script that defines the parameters for the % top model or use *Simulink.saveVars* to update the existing MATLAB script. % %  Simulink.saveVars('sldemo_mdlref_datamngt_wsdata.m', '-update');  %% % *NOTE:* When you use the *-update* option, you do not need to specify the % variables to be written out because *Simulink.saveVars* writes out only % the values of variables already defined in the MATLAB script.  %% Regenerate Code for the Top Model (Requires Real-Time Workshop)  % Generate code and build a standalone executable for the top model by % selecting *Real-Time Workshop > Build Model* from the *Tools* menu or % by typing *Ctrl+B*. % % <matlab:rtwbuild('sldemo_mdlref_datamngt'); |rtwbuild('sldemo_mdlref_datamngt')|>  % DEVELOPER COMMENT: NEED TO USE EVALC TO HIDE COMMAND-LINE OUTPUT WHEN PUBLISHING evalc('rtwbuild(''sldemo_mdlref_datamngt'');');  %% if takeSnapshots   me.showDialogView(true);   be.showDialogView(true);   me.delete;   be.delete; end  cd(origDir); path(origPath); bdclose all clear  ##### SOURCE END ##### --></body></html>