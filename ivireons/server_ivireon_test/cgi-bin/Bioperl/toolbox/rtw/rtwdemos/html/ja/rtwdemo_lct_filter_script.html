
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!-- This HTML was auto-generated from MATLAB code. To make changes, update the MATLAB code and republish this document.       --><title>値またはアドレスで渡される入力</title><meta name="generator" content="MATLAB 7.11"><link rel="schema.DC" href="../http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2010-05-27"><meta name="DC.source" content="rtwdemo_lct_filter_script.m"><link rel="stylesheet" type="text/css" href="../../../../matlab/demos/private/style.css"></head><body><div class="header"><div class="left"><a href="matlab:edit rtwdemo_lct_filter_script">エディターで rtwdemo_lct_filter_script.m を開く</a></div><div class="right"><a href="matlab:echodemo rtwdemo_lct_filter_script">コマンド ウィンドウで実行</a></div></div><div class="content"><h1>値またはアドレスで渡される入力</h1><!--introduction--><p>このデモでは、Legacy Code Tool を使用して、値またはアドレスによって入力引数を渡すレガシ C 関数を統合する方法を示します。</p><p>Legacy Code Tool を使用すると、以下のことができます。</p><div><ul><li>レガシ関数の仕様を提供する。</li><li>レガシ コードを呼び出すためにシミュレーション時に使用される C-MEX S-function を生成する。</li><li>生成された S-function をシミュレーション向けにコンパイルし、ビルドする。</li><li>レガシ コードを呼び出すためにコード生成時に使用される TCL ファイルおよびオプションの rtwmakecfg.m ファイルを生成する。</li></ul></div><!--/introduction--><h2>目次</h2><div><ul><li><a href="#1">レガシ関数の仕様を提供</a></li><li><a href="#2">シミュレーション時に使用する S-function の生成</a></li><li><a href="#3">生成された S-function のシミュレーション向けのコンパイル</a></li><li><a href="#4">コード生成用の TLC ブロック ファイルの生成</a></li><li><a href="#5">コード生成用の rtwmakecfg.m ファイルの生成</a></li><li><a href="#6">生成された S-function を呼び出すためのマスクされた S-function ブロックの生成</a></li><li><a href="#7">レガシ コードとの統合のデモ</a></li></ul></div><h2>レガシ関数の仕様を提供<a name="1"></a></h2><p>Legacy Code Tool に装備されているすべての関数で、特定のデータ構造体または構造体の配列を引数として使用します。このデータ構造体は、1 番目の入力として initialize を使用して関数 legacy_code() を呼び出すことで初期化されます。構造体の初期化後、統合されるレガシ コードに対応する値に、構造体のプロパティを割り当てる必要があります。プロパティの詳細なヘルプは、<a href="matlab:legacy_code('help')">legacy_code('help')</a> を呼び出してください。このデモで呼び出されるレガシ関数のプロトタイプは以下のとおりです。</p><div><ul><li>FLT filterV1(const FLT signal, const FLT prevSignal, const FLT gain)</li><li>FLT filterV2(const FLT* signal, const FLT prevSignal, const FLT gain)</li></ul></div><p>FLT は、float に対する typedef です。レガシ ソース コードは、ファイル <a href="matlab:sldemo_lct_util('edit','sldemo_lct_src/your_types.h')">your_types.h</a>、<a href="matlab:sldemo_lct_util('edit','sldemo_lct_src/myfilter.h')">myfilter.h</a>、<a href="matlab:sldemo_lct_util('edit','sldemo_lct_src/filterV1.c')">filterV1.c</a>、および <a href="matlab:sldemo_lct_util('edit','sldemo_lct_src/filterV2.c')">filterV2.c</a> にあります。</p><p>2 つの構造体で定義されている OutputFcnSpec に違いがあることに注意してください。1 番目のケースでは、1 番目の入力引数が値によって渡されるように指定されています。これに対し、2 番目のケースでは、ポインターによって渡されるように指定されています。</p><pre class="codeinput">defs = [];

<span class="comment">% rtwdemo_sfun_filterV1</span>
def = legacy_code(<span class="string">'initialize'</span>);
def.SFunctionName = <span class="string">'rtwdemo_sfun_filterV1'</span>;
def.OutputFcnSpec = <span class="string">'single y1 = filterV1(single u1, single u2, single p1)'</span>;
def.HeaderFiles   = {<span class="string">'myfilter.h'</span>};
def.SourceFiles   = {<span class="string">'filterV1.c'</span>};
def.IncPaths      = {<span class="string">'sldemo_lct_src'</span>};
def.SrcPaths      = {<span class="string">'sldemo_lct_src'</span>};
defs = [defs; def];

<span class="comment">% rtwdemo_sfun_filterV2</span>
def = legacy_code(<span class="string">'initialize'</span>);
def.SFunctionName = <span class="string">'rtwdemo_sfun_filterV2'</span>;
def.OutputFcnSpec = <span class="string">'single y1 = filterV2(single u1[1], single u2, single p1)'</span>;
def.HeaderFiles   = {<span class="string">'myfilter.h'</span>};
def.SourceFiles   = {<span class="string">'filterV2.c'</span>};
def.IncPaths      = {<span class="string">'sldemo_lct_src'</span>};
def.SrcPaths      = {<span class="string">'sldemo_lct_src'</span>};
defs = [defs; def];
</pre><h2>シミュレーション時に使用する S-function の生成<a name="2"></a></h2><p>入力引数 defs によって示される説明に従って C-MEX S-function の生成を自動的に行うために、1 番目の入力を sfcn_cmex_generate に設定して関数 legacy_code() が再び呼び出されます。S-function は、シミュレーションでレガシ関数を呼び出すときに使用されます。S-function のソース コードは、ファイル <a href="matlab:rtwdemo_lct_util('edit','rtwdemo_sfun_filterV1.c')">rtwdemo_sfun_filterV1.c</a> と <a href="matlab:rtwdemo_lct_util('edit','rtwdemo_sfun_filterV2.c')">rtwdemo_sfun_filterV2.c</a> にあります。</p><pre class="codeinput">legacy_code(<span class="string">'sfcn_cmex_generate'</span>, defs);
</pre><h2>生成された S-function のシミュレーション向けのコンパイル<a name="3"></a></h2><p>C-MEX S-function ソース ファイルの生成後、Simulink&reg; を使用したシミュレーション向けに S-function をコンパイルするために 1 番目の入力を compile に設定して関数 legacy_code() が再び呼び出されます。</p><pre class="codeinput">legacy_code(<span class="string">'compile'</span>, defs);
</pre><pre class="codeoutput">
### Start Compiling rtwdemo_sfun_filterV1
    mex('rtwdemo_sfun_filterV1.c', 'B:\matlab\toolbox\simulink\simdemos\simfeatures\sldemo_lct_src\filterV1.c', '-IB:\matlab\toolbox\simulink\simdemos\simfeatures\sldemo_lct_src', '-IC:\Temp\R2010bd_32_2444\tp3549b43a_9c27_4fb4_b336_96aeddb681bc')
### Finish Compiling rtwdemo_sfun_filterV1
### Exit

### Start Compiling rtwdemo_sfun_filterV2
    mex('rtwdemo_sfun_filterV2.c', 'B:\matlab\toolbox\simulink\simdemos\simfeatures\sldemo_lct_src\filterV2.c', '-IB:\matlab\toolbox\simulink\simdemos\simfeatures\sldemo_lct_src', '-IC:\Temp\R2010bd_32_2444\tp3549b43a_9c27_4fb4_b336_96aeddb681bc')
### Finish Compiling rtwdemo_sfun_filterV2
### Exit
</pre><h2>コード生成用の TLC ブロック ファイルの生成<a name="4"></a></h2><p>S-function をコンパイルしシミュレーションで使用した後、Real Time Workshop を介したコード生成をサポートする TLC ブロック ファイルを生成するために、1 番目の入力を sfcn_tlc_generate に設定して関数 legacy_code() を再び呼び出すことができます。TLC ブロック ファイルが作成されず、S-function を含んでいるモデルのコードを生成しようとすると、コード生成は失敗します。S-function の TLC ブロック ファイルは、<a href="matlab:rtwdemo_lct_util('edit','rtwdemo_sfun_filterV1.tlc')">rtwdemo_sfun_filterV1.tlc</a> および <a href="matlab:rtwdemo_lct_util('edit','rtwdemo_sfun_filterV2.tlc')">rtwdemo_sfun_filterV2.tlc</a> です。</p><pre class="codeinput">legacy_code(<span class="string">'sfcn_tlc_generate'</span>, defs);
</pre><h2>コード生成用の rtwmakecfg.m ファイルの生成<a name="5"></a></h2><p>TLC ブロック ファイルの作成後、Real Time Workshop を介したコード生成をサポートする rtwmakecfg.m ファイルを生成するために、1 番目の入力を rtwmakecfg_generate に設定して関数 legacy_code() を再び呼び出すことができます。このファイルが必要になるのは、S-function にとって必要なソース ファイルとヘッダー ファイルが S-function と同じディレクトリにない場合に、コード生成時に作成される makefile 内にこれらの依存関係を追加したいときのみです。</p><pre class="codeinput">legacy_code(<span class="string">'rtwmakecfg_generate'</span>, defs);
</pre><h2>生成された S-function を呼び出すためのマスクされた S-function ブロックの生成<a name="6"></a></h2><p>C-MEX S-function ソースのコンパイルが終了したら、S-function を呼び出すように設定されたマスクされた S-function ブロックを生成するために、1 番目の入力を slblock_generate に設定して関数 legacy_code() を再び呼び出すことができます。これらのブロックは新しいモデルに配置されますが、既存のモデルにコピーすることもできます。</p><pre class="codeinput"><span class="comment">% legacy_code('slblock_generate', defs);</span>
</pre><h2>レガシ コードとの統合のデモ<a name="7"></a></h2><p>モデル <a href="matlab:rtwdemo_lct_filter">rtwdemo_lct_filter</a> は、レガシ コードとの統合を示しています。サブシステム TestFilter は、以前の出力値の保存に役立つ単位遅延と共に、生成された S-function を介したレガシ C 関数の呼び出しに利用できます。</p><pre class="codeinput">open_system(<span class="string">'rtwdemo_lct_filter'</span>)
open_system(<span class="string">'rtwdemo_lct_filter/TestFilter'</span>)
sim(<span class="string">'rtwdemo_lct_filter'</span>)
</pre><img vspace="5" hspace="5" src="../rtwdemo_lct_filter_script_01.png" alt=""> <img vspace="5" hspace="5" src="../rtwdemo_lct_filter_script_02.png" alt=""> <p class="footer">Copyright 1990-2007 The MathWorks, Inc.<br>Published with MATLAB&reg; 7.11</p><p class="footer" id="trademarks">MATLAB and Simulink are registered trademarks of The MathWorks, Inc.  Please see <a href="http://www.mathworks.com/trademarks">www.mathworks.com/trademarks</a> for a list of other trademarks owned by The MathWorks, Inc.  Other product or brand names are trademarks or registered trademarks of their respective owners.</p></div><!-- ##### SOURCE BEGIN ##### %% Inputs Passed by Value or Address % This demo shows you how to use the Legacy Code Tool to integrate legacy C  % functions that pass their input arguments by value versus address.  % % The Legacy Code Tool allows you to: % % * Provide the legacy function specification, % * Generate a C-MEX S-function that is used during simulation to call the legacy code, % * Compile and build the generated S-function for simulation, and % * Generate a block TLC file and optional rtwmakecfg.m file that is used during code generation to call the legacy code. %  %   Copyright 1990-2007 The MathWorks, Inc. %   $Revision: 1.1.4.2.2.1 $  $Date: 2010/07/29 21:29:01 $  %% Providing the Legacy Function Specification % All functions provided with the Legacy Code Tool take a specific data  % structure or array of structures as the argument. The data structure is  % initialized by calling the function legacy_code() using 'initialize' as the % first input. After initializing the structure, you have to assign its % properties to values corresponding to the legacy code being integrated.   % For detailed help on the properties, call  % <matlab:legacy_code('help') legacy_code('help')>. The  % prototypes of the legacy functions being called in this demo are: % % * FLT filterV1(const FLT signal, const FLT prevSignal, const FLT gain) % * FLT filterV2(const FLT* signal, const FLT prevSignal, const FLT gain) % % where FLT is a typedef to float.  The legacy source code is found in the % files <matlab:sldemo_lct_util('edit','sldemo_lct_src/your_types.h') your_types.h>,  % <matlab:sldemo_lct_util('edit','sldemo_lct_src/myfilter.h') myfilter.h>, % <matlab:sldemo_lct_util('edit','sldemo_lct_src/filterV1.c') filterV1.c>, and % <matlab:sldemo_lct_util('edit','sldemo_lct_src/filterV2.c') filterV2.c>. % % Note the difference in the OutputFcnSpec defined in the two structures; the % first case specifies that the first input argument is passed by % value, while the second case specifies pass by pointer.  defs = [];  % rtwdemo_sfun_filterV1 def = legacy_code('initialize'); def.SFunctionName = 'rtwdemo_sfun_filterV1'; def.OutputFcnSpec = 'single y1 = filterV1(single u1, single u2, single p1)'; def.HeaderFiles   = {'myfilter.h'}; def.SourceFiles   = {'filterV1.c'}; def.IncPaths      = {'sldemo_lct_src'};  def.SrcPaths      = {'sldemo_lct_src'};  defs = [defs; def];  % rtwdemo_sfun_filterV2 def = legacy_code('initialize'); def.SFunctionName = 'rtwdemo_sfun_filterV2'; def.OutputFcnSpec = 'single y1 = filterV2(single u1[1], single u2, single p1)'; def.HeaderFiles   = {'myfilter.h'}; def.SourceFiles   = {'filterV2.c'}; def.IncPaths      = {'sldemo_lct_src'};  def.SrcPaths      = {'sldemo_lct_src'};  defs = [defs; def];   %%  Generating S-Functions for Use During Simulation % The function legacy_code() is called again with the first input set to  % 'sfcn_cmex_generate' in order to automatically generate C-MEX S-functions  % according to the description provided by the input argument 'defs'.   % The S-functions are used to call the legacy functions in simulation. % The source code for the S-functions is found in the files  % <matlab:rtwdemo_lct_util('edit','rtwdemo_sfun_filterV1.c') rtwdemo_sfun_filterV1.c> and % <matlab:rtwdemo_lct_util('edit','rtwdemo_sfun_filterV2.c') rtwdemo_sfun_filterV2.c>.  legacy_code('sfcn_cmex_generate', defs);  %% Compiling the Generated S-Functions for Simulation % After the C-MEX S-function source files are generated, the function  % legacy_code() is called again with the first input set to 'compile' in order % to compile the S-functions for simulation with Simulink(R).  legacy_code('compile', defs);  %% Generating TLC Block Files for Code Generation % After the S-function is compiled and used in simulation, the function % legacy_code() can be called again with the first input set to  % 'sfcn_tlc_generate' in order to generate a TLC block file to support % code generation through Real Time Workshop. Code generation will fail  % if the TLC block file is not created and you try to generate code for a model % that includes the S-function. The TLC block files for the S-functions are % <matlab:rtwdemo_lct_util('edit','rtwdemo_sfun_filterV1.tlc') rtwdemo_sfun_filterV1.tlc> and % <matlab:rtwdemo_lct_util('edit','rtwdemo_sfun_filterV2.tlc') rtwdemo_sfun_filterV2.tlc>.  legacy_code('sfcn_tlc_generate', defs);  %% Generating an rtwmakecfg.m File for Code Generation % After the TLC block file is created, the function % legacy_code() can be called again with the first input set to  % 'rtwmakecfg_generate' in order to generate an rtwmakecfg.m file to support % code generation through Real Time Workshop. The file is needed only if  % the required source and header files for the S-functions are not in the  % same directory as the S-functions, and you want to add these  % dependencies in the makefile produced during code generation.  legacy_code('rtwmakecfg_generate', defs);  %% Generating masked S-Function blocks for calling the generated S-Functions % After the C-MEX S-function source is compiled, the function  % legacy_code() can be called again with the first input set to 'slblock_generate' in order % to generate masked S-function blocks which are configured to call those % S-functions.  The blocks are placed in a new model and can be copied to an % existing model.  % legacy_code('slblock_generate', defs);  %% Demoing the Generated Integration with Legacy Code % The model <matlab:rtwdemo_lct_filter rtwdemo_lct_filter>  % shows integration with the legacy % code.  The subsystem TestFilter serves as a harness for the calls to the % legacy C functions via the generate S-functions, with unit delays serving to  % store the previous output values.  open_system('rtwdemo_lct_filter') open_system('rtwdemo_lct_filter/TestFilter') sim('rtwdemo_lct_filter')  displayEndOfDemoMessage(mfilename)  ##### SOURCE END ##### --></body></html>