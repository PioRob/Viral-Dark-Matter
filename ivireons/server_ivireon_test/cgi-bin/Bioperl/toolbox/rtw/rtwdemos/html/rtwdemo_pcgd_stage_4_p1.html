
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Calling External C Code from the Simulink Model and Generated Code</title><meta name="generator" content="MATLAB 7.11"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2010-06-30"><meta name="DC.source" content="rtwdemo_pcgd_stage_4_p1.m"><link rel="stylesheet" type="text/css" href="../../../matlab/demos/private/style.css"></head><body><div class="header"><div class="left"><a href="matlab:edit rtwdemo_pcgd_stage_4_p1">Open rtwdemo_pcgd_stage_4_p1.m in the Editor</a></div><div class="right"><a href="matlab:echodemo rtwdemo_pcgd_stage_4_p1">Run in the Command Window</a></div></div><div class="content"><h1>Calling External C Code from the Simulink Model and Generated Code</h1><!--introduction--><p><b>Overview:</b> Introduces the Legacy Code Tool as a method for calling external functions.  The Legacy Code Tool enables you to call the external function from within the simulation and in the generated code.</p><p><b>Time:</b> 45 minutes</p><p><b>Goals</b></p><p>Understand...</p><div><ul><li>How to evaluate a C function as part of a Simulink model simulation</li><li>How to call a C function from code generated by Real-Time Workshop</li></ul></div><p><a href="matlab:RTWDemos.pcgd_open_pcg_model(4,0);"><b>Task:</b> Open the model.</a></p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Replacement Process</a></li><li><a href="#2">Creating a Block That Calls a C Function</a></li><li><a href="#3">Validating the External Code in the Simulink Environment</a></li><li><a href="#4">Validating the C Code as Part of the Simulink Model</a></li><li><a href="#5">Calling the C Function from the Generated Code</a></li><li><a href="#6">Further Study Topics</a></li></ul></div><h2>Replacement Process<a name="1"></a></h2><p>Simulink&reg; models are one part of Model-Based Design. For many applications, a design also includes a set of existing C functions that have been tested and validated. The ability to easily integrate these functions into a Simulink model and generated code is critical to using Simulink in the controls development process.</p><p>This module demonstrates how to create a custom Simulink block that calls an existing C function.  Once the block is part of the model, you can take advantage of the simulation environment to further test the system.</p><p>As an example, the Lookup blocks (lookup tables) in the PI controllers are replaced with calls to an existing C function.  The function is defined in the files <tt>SimpleTable.c</tt> and <tt>SimpleTable.h</tt>.</p><p><a href="matlab:edit(fullfile(matlabroot,'toolbox','rtw','rtwdemos','EmbeddedCoderOverview','stage_4_files','SimpleTable.c'))"><b>Task:</b> View <tt>SimpleTable.c</tt>.</a></p><p><a href="matlab:edit(fullfile(matlabroot,'toolbox','rtw','rtwdemos','EmbeddedCoderOverview','stage_4_files','SimpleTable.h'))"><b>Task:</b> View <tt>SimpleTable.h</tt>.</a></p><p><img vspace="5" hspace="5" src="replace_sim_with_external.jpg"></p><h2>Creating a Block That Calls a C Function<a name="2"></a></h2><p>To specify a call to an existing C function, you use an S-Function block. You can automate the process of creating the S-Function block by using the Simulink Legacy Code Tool. Using this tool, you specify an interface for your existing C function. The tool then uses that interface to automate creation of an S-Function block.</p><p>Complete steps 1 through 6 below to create an S-Function block for an existing C function <tt>SimpleTable.c</tt>. A link to more information on using the Legacy Code Tool is provided at the end of this module.</p><p>1. <a href="matlab:RTWDemos.pcgd_LCT(1)"><b>Task:</b> Create the function interface definition structure.</a></p><p><tt>def=legacy_code('initialize')</tt></p><p>The data structure <tt>def</tt> defines the function interface to the existing C code.</p><p>2. <a href="matlab:RTWDemos.pcgd_LCT(2)"><b>Task:</b> Populate the function interface definition structure.</a></p><p><img vspace="5" hspace="5" src="defineFunctionInterface.jpg"></p><p>3. <a href="matlab:RTWDemos.pcgd_LCT(3)"><b>Task:</b> Create the S-function.</a></p><p><tt>legacy_code('sfcn_cmex_generate',def)</tt></p><p>4. <a href="matlab:RTWDemos.pcgd_LCT(4)"><b>Task:</b> Compile the S-function.</a></p><p><tt>legacy_code('compile',def)</tt></p><p>5. <a href="matlab:RTWDemos.pcgd_LCT(5)"><b>Task:</b> Create the S-Function block.</a></p><p><tt>legacy_code('slblock_generate',def)</tt></p><p>S-function creation is a one-time task.  Once the block exists, you can reuse it in any model.</p><p>6. <a href="matlab:RTWDemos.pcgd_LCT(6)"><b>Task:</b> Create the TLC file.</a></p><p><tt>legacy_code('sfcn_tlc_generate',def)</tt></p><p>Steps 1 through 5 created an S-function block that calls the specified function at each time step during simulation.  Step 6 creates a TLC file, which is the component of an S-Function that specifies how Real-Time Workshop&reg; generates code for the block.</p><h2>Validating the External Code in the Simulink Environment<a name="3"></a></h2><p>When you integrate existing C code with a Simulink model, always validate the results.</p><p>In this example, you replace Lookup blocks with an existing C function. To validate the replacement, you compare simulation results produced with the Lookup block with results produced with the new S-Function block.</p><p>1. <a href="matlab:RTWDemos.pcgd_open_pcg_model(2,3);"><b>Task:</b> Open the validation model.</a></p><div><ul><li>The Sine Wave block produces output values from [-2 : 2].</li><li>The input range of the lookup table is from [-1 : 1].</li><li>The output from the lookup table is the absolute value of the input.</li><li>The lookup table output clips the output at the input limits.</li></ul></div><p>2. <a href="matlab:sim(pcgDemoData.helper{2})"><b>Task:</b> Run the validation model.</a></p><p>The following figure shows the validation results. Note that the existing C code and the Simulink table block provide the same output values.</p><p><img vspace="5" hspace="5" src="S_Fun_Validate.jpg"></p><h2>Validating the C Code as Part of the Simulink Model<a name="4"></a></h2><p>After you validate the functionality of the existing C function code as a standalone component, validate the S-function in the model.  Use the test harness model to complete the validation.</p><p>1. <a href="matlab:RTWDemos.pcgd_open_pcg_model(4,1);"><b>Task:</b> Open the test harness.</a></p><p>2. <a href="matlab:RTWDemos.pcgd_runTestHarn(1,4)"><b>Task:</b> Run the test harness.</a></p><p>The simulation results match the expected golden values:</p><p><img vspace="5" hspace="5" src="FirstPassTest.jpg"></p><h2>Calling the C Function from the Generated Code<a name="5"></a></h2><p>Real-Time Workshop uses the TLC file to process the S-Function block like any other block in the system.  Calls to the C code of the S-Function block:</p><div><ul><li>Can use data objects</li><li>Are subject to <i>expression folding</i>, an operation that combines multiple computations into a single output calculation</li></ul></div><p>1. <a href="matlab:RTWDemos.pcgd_buildDemo(4,0)"><b>Task:</b> Build the full model.</a></p><p>2. <a href="matlab:RTWDemos.pcgd_showSection(4,'Reusable');"><b>Task:</b> Examine the generated code (<tt>PI_Control_Reusable.c</tt>).</a></p><p>The generated code now calls the <tt>SimpleTable</tt> C function.</p><p>The following figures show the generated code before and after the C code integration. Before the integration, the generated code called <tt>rt_Lookup</tt>. After the integration, the generated code calls the C function <tt>SimpleTable</tt>.</p><p><img vspace="5" hspace="5" src="original_table_call.jpg"></p><p><img vspace="5" hspace="5" src="external_scheduler.jpg"></p><h2>Further Study Topics<a name="6"></a></h2><div><ul><li><a href="matlab:helpview([docroot,'/toolbox/simulink/helptargets.map'],'legacy_code_tool');">Using the Legacy Code Tool</a></li><li><a href="matlab:helpview([docroot,'/toolbox/rtw/helptargets.map'],'write_sfunctions');">Writing S-functions for use in code generation</a></li></ul></div><p class="footer">Copyright 2007-2008 The MathWorks, Inc.<br>
          Published with MATLAB&reg; 7.11</p><p class="footer" id="trademarks">MATLAB and Simulink are registered trademarks of The MathWorks, Inc.  Please see <a href="http://www.mathworks.com/trademarks">www.mathworks.com/trademarks</a> for a list of other trademarks owned by The MathWorks, Inc.  Other product or brand names are trademarks or registered trademarks of their respective owners.</p></div><!--
##### SOURCE BEGIN #####
%% Calling External C Code from the Simulink Model and Generated Code
% *Overview:* Introduces the Legacy Code Tool as a method for calling
% external functions.  The Legacy Code Tool enables you to call the
% external function from within the simulation and in the generated code.
%
% *Time:* 45 minutes
%
% *Goals*
%
% Understand...
% 
% * How to evaluate a C function as part of a Simulink model simulation
% * How to call a C function from code generated by Real-Time Workshop
%
% <matlab:RTWDemos.pcgd_open_pcg_model(4,0); *Task:* Open the model.> 
%% Replacement Process
% Simulink(R) models are one part of Model-Based Design.
% For many applications, a design also includes a set of existing C functions 
% that have been tested and validated. The ability to easily integrate 
% these functions into a Simulink model and generated code is
% critical to using Simulink in the controls development process.
%
% This module demonstrates how to create a custom Simulink block that 
% calls an existing C function.  Once the block is part of the model, you
% can take advantage of the simulation environment to further test the system.
%
% As an example, the Lookup blocks (lookup tables) in the PI controllers are 
% replaced with calls to an existing C function.  The function is defined in the
% files |SimpleTable.c| and |SimpleTable.h|.
% 
% <matlab:edit(fullfile(matlabroot,'toolbox','rtw','rtwdemos','EmbeddedCoderOverview','stage_4_files','SimpleTable.c')) *Task:* View |SimpleTable.c|.> 
%
% <matlab:edit(fullfile(matlabroot,'toolbox','rtw','rtwdemos','EmbeddedCoderOverview','stage_4_files','SimpleTable.h')) *Task:* View |SimpleTable.h|.>
%
% <html><img vspace="5" hspace="5" src="replace_sim_with_external.jpg"></html>
%
%% Creating a Block That Calls a C Function
% To specify a call to an existing C function, you use an S-Function block.
% You can automate the process of creating the S-Function block by using the 
% Simulink Legacy Code Tool. Using this tool, you specify an interface for your
% existing C function. The tool then uses that interface to automate creation 
% of an S-Function block. 
% 
% Complete steps 1 through 6 below to create an S-Function block for an existing 
% C function |SimpleTable.c|. A link to more information on using the
% Legacy Code Tool is provided at the end of this module.
%
% 1. <matlab:RTWDemos.pcgd_LCT(1) *Task:* Create the function interface definition structure.>
%
% |def=legacy_code('initialize')| 
%
% The data structure |def| defines the function interface to the existing C
% code.
%
% 2. <matlab:RTWDemos.pcgd_LCT(2) *Task:* Populate the function interface definition
% structure.>
%
% <html><img vspace="5" hspace="5" src="defineFunctionInterface.jpg"></html>
%
% 3. <matlab:RTWDemos.pcgd_LCT(3) *Task:* Create the S-function.>
%
% |legacy_code('sfcn_cmex_generate',def)|
%
% 4. <matlab:RTWDemos.pcgd_LCT(4) *Task:* Compile the S-function.>  
%
% |legacy_code('compile',def)| 
%
% 5. <matlab:RTWDemos.pcgd_LCT(5) *Task:* Create the S-Function block.>
% 
% |legacy_code('slblock_generate',def)|
%
% S-function creation is a one-time task.  Once the block exists, you can reuse
% it in any model.
%
% 6. <matlab:RTWDemos.pcgd_LCT(6) *Task:* Create the TLC file.> 
%
% |legacy_code('sfcn_tlc_generate',def)|
% 
% Steps 1 through 5 created an S-function block that calls the 
% specified function at each time step during simulation.  Step 6 creates a TLC
% file, which is the component of an S-Function that specifies how 
% Real-Time Workshop(R) generates code for the block.  
%
%% Validating the External Code in the Simulink Environment
% When you integrate existing C code with a Simulink model,
% always validate the results. 
% 
% In this example, you replace Lookup blocks with an existing C function. 
% To validate the replacement, you compare simulation results produced with the 
% Lookup block with results produced with the new S-Function block. 
%
% 1. <matlab:RTWDemos.pcgd_open_pcg_model(2,3); *Task:* Open the validation model.>
%
% * The Sine Wave block produces output values from [-2 : 2].
% * The input range of the lookup table is from [-1 : 1].
% * The output from the lookup table is the absolute value of the input.
% * The lookup table output clips the output at the input limits. 
%
% 2. <matlab:sim(pcgDemoData.helper{2}) *Task:* Run the validation model.>
% 
% The following figure shows the validation results. Note that the existing C code 
% and the Simulink table block provide the same output values.  
%
% <html><img vspace="5" hspace="5" src="S_Fun_Validate.jpg"></html>
%
%% Validating the C Code as Part of the Simulink Model
% After you validate the functionality of the existing C function code as a
% standalone component, validate the S-function in the model.  Use the
% test harness model to complete the validation.
%
% 1. <matlab:RTWDemos.pcgd_open_pcg_model(4,1); *Task:* Open the test harness.> 
%
% 2. <matlab:RTWDemos.pcgd_runTestHarn(1,4) *Task:* Run the test harness.>
%
% The simulation results match the expected golden values:
%
% <html><img vspace="5" hspace="5" src="FirstPassTest.jpg"></html>
%
%% Calling the C Function from the Generated Code
% Real-Time Workshop uses the TLC file to process the S-Function block 
% like any other block in the system.  Calls to the C code of the S-Function block:
%
% * Can use data objects
% * Are subject to _expression folding_, an operation that combines 
% multiple computations into a single output calculation
%
% 1. <matlab:RTWDemos.pcgd_buildDemo(4,0) *Task:* Build the full model.>
%
% 2. <matlab:RTWDemos.pcgd_showSection(4,'Reusable'); *Task:* Examine the generated code
% (|PI_Control_Reusable.c|).> 
%  
% The generated code now calls the |SimpleTable| C function.
%
% The following figures show the generated code before and after the C code
% integration. Before the integration, the generated code called
% |rt_Lookup|. After the integration, the generated code calls the C
% function |SimpleTable|.
%
% <html><img vspace="5" hspace="5" src="original_table_call.jpg"></html>
%
% <html><img vspace="5" hspace="5" src="external_scheduler.jpg"></html>
%
%% Further Study Topics
%
% * <matlab:helpview([docroot,'/toolbox/simulink/helptargets.map'],'legacy_code_tool'); Using the Legacy Code Tool>
% * <matlab:helpview([docroot,'/toolbox/rtw/helptargets.map'],'write_sfunctions'); Writing S-functions for use in code generation>

%   Copyright 2007-2008 The MathWorks, Inc.

displayEndOfDemoMessage(mfilename)

##### SOURCE END #####
--></body></html>