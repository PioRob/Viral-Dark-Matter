
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!-- This HTML was auto-generated from MATLAB code. To make changes, update the MATLAB code and republish this document.       --><title>固定小数点の数値制御発振器の解析</title><meta name="generator" content="MATLAB 7.11"><link rel="schema.DC" href="../http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2010-05-27"><meta name="DC.source" content="ddcncoanalysisdemo.m"><link rel="stylesheet" type="text/css" href="../../../../matlab/demos/private/style.css"></head><body><div class="header"><div class="left"><a href="matlab:edit ddcncoanalysisdemo">エディターで ddcncoanalysisdemo.m を開く</a></div><div class="right"><a href="matlab:echodemo ddcncoanalysisdemo">コマンド ウィンドウで実行</a></div></div><div class="content"><h1>固定小数点の数値制御発振器の解析</h1><!--introduction--><p>数値制御発振器 (NCO) は、正弦波信号を生成する効率的な方法で、可変周波数で連続位相の正弦波信号が必要な場合に役立ちます。</p><!--/introduction--><h2>目次</h2><div><ul><li><a href="#1">はじめに</a></li><li><a href="#3">数値制御発振器</a></li><li><a href="#6">NCO 出力のスペクトル解析</a></li><li><a href="#10">右のウィンドウの選択</a></li><li><a href="#16">SFDR の測定</a></li><li><a href="#20">ディザーリングの効果の調査</a></li><li><a href="#38">結果の比較</a></li><li><a href="#41">まとめ</a></li></ul></div><h2>はじめに<a name="1"></a></h2><p>このデモは、固定小数点演算で実装されたデジタル周波数変換器 (DDC) の NCO を解析するために MATLAB&reg; および Signal Processing Toolbox™ を使用します。スペクトル解析を使用して、NCO のスプリアス フリー ダイナミック レンジ (SFDR) を測定すると共に、位相振動を加えるときの影響を調べます。ディザーのビット数は、ハードウェア実行の選択に影響します。シミュレーションでディザーのビット数を調整すると、ノイズ フロア レベル、スプリアスの影響、ハードウェア内で DDC を実行する前のディザーのビット数の間のトレードオフを確認することができます。デモの DDC は、GSM 仕様を満たすよう設計されており、Graychip 4016 をモデル化します。</p><p>DDC は、デジタル無線の主要な構成要素です。DDC によって、デジタル無線の高入力サンプル レートが低いサンプル レート (ベースバンド) に変換され、以降の処理が容易になります。この例では、GSM 仕様に従い、DDC の入力レートは 69.333MHz で、このレートを 270KHz に変換します。</p><p>DDC は、NCO と、入力信号をベースバンドに直交逓降変換するミキサーで構成されます。次に、カスケード接続積分器櫛形 (CIC) によってベースバンド信号がローパス フィルター処理され、2 つの FIR 間引きフィルターと共に、信号がダウンサンプリングされ、目的の低サンプル レートになります。これで、次の処理に移行できます。最終段階では、用途に応じて、目的のサンプル レートを達成するために信号を補間または間引きするリサンプラーを使用する場合もあります。リサンプラーを使用することで、フィルター処理をさらに実行できます。典型的な DDC については、以下のブロック線図を参照してください。Simulink&reg; では複素数信号を処理するため、I チャンネルと Q チャンネルを別々に処理する必要はありません。</p><p><img vspace="5" hspace="5" src="../ddcdemomodel.png" alt=""> </p><p>このデモでは NCO の解析を主に取り上げますが、3 ステージのマルチレート固定小数点フィルター連鎖および HDL コード生成の設計について取り上げる <a href="../../../filterdesign/filtdesdemos/html/ddcfilterchaindemo.html">Implementing the Filter Chain of a Digital Down-Converter</a> では、Filter Design Toolbox™ を利用します。</p><h2>数値制御発振器<a name="3"></a></h2><p>DDC のデジタル ミキサー セクションには、乗数およびラジオのチャンネルの選択とチューニングを行う NCO が含まれます。ミキサーは、基本的に正弦-余弦発生器であり、正弦と余弦の組み合わせごとに複素数値を作成します。典型的な NCO には、位相積和器、位相加算器、ディザー発生器、および正弦-余弦ルックアップ テーブルの 4 つのコンポーネントが含まれています。</p><p>以下のブロック線図は、Simulink でモデル化された典型的な NCO 回路で、Graychip データ シートの図に似ています。</p><pre class="codeinput">open_system(<span class="string">'ddcnco'</span>);
</pre><img vspace="5" hspace="5" src="../ddcncoanalysisdemo_01.png" alt=""> <p>NCO の位相積和器は、入力周波数に基づいて、正弦-余弦ルックアップ テーブルで使用される値を生成します。位相加算器は、位相積和器の出力を変調する位相オフセットを指定します。ディザー発生器によって生じる位相のディザーリングは、振幅の量子化ノイズを軽減し、NCO の SFDR を改善します。Sine/Cosine Lookup ブロックは、実際の複素正弦波信号を生成し、その出力は変数 nco_nodither に保存されます。</p><p>Graychip のチューニング周波数は、チップのクロック レートに対して正規化された値として指定されます。したがって、チューニング周波数が F の場合、正規化された周波数は F/Fclk です。ここで、Fclk はチップのクロック レートです。位相オフセットは、ラジアン単位で指定され、範囲は 0 ～ 2pi です。このデモでは、正規化されたチューニング周波数は 5/24 に設定され、位相オフセットは 0 に設定されています。チューニング周波数は 32 ビット ワードで指定され、位相オフセットは 16 ビット ワードで指定されます。</p><p>NCO は、固定小数点演算を使用して実装されるため、望ましくない振幅の量子化の影響を受けます。このような数値の歪みは、語長が有限であるために生じます。基本的に、正弦波を量子化すると、時間領域で累積的、確定的、および周期的な誤差が発生します。このような誤差は、周波数領域のラインスペクトルまたはスパーとして現れます。対象の信号のピークから最大スパーまでの減衰量が SFDR です。</p><p>Graychip の SFDR は 106dB ですが、GSM 仕様では、SFDR が 110dB より大きい必要があります。SFDR を改善する方法は複数あり、位相振動を NCO に加えてその影響を調べます。</p><p>Graychip の NCO には、基本的に発振器の出力純度を改善するために使用される乱数整数発生器である位相振動発生器が含まれています。ディザーリングによって、意図しない量子化ノイズ (スペクトルの &quot;スパイク&quot; の原因で、SFDR を低下させる) の周期性が広範囲のスペクトルに広がり、望ましくないスペクトル ピークを効果的に減少できます。ただしエネルギー保存が適用されるため、この広がりによってノイズ フロア全体が効果的に上昇します。すなわち、ディザーリングはある程度までは SFDR に効果的です。</p><p>NCO モデルを実行し、MATLAB ワークスペースの出力を解析します。このモデルでは、ディザーリングは使用しません。</p><pre class="codeinput">sim(<span class="string">'ddcnco'</span>);
whos <span class="string">nco*</span>
</pre><pre class="codeoutput">  Name              Size                  Bytes  Class     Attributes

  nco_nodither      1x1x20545            328720  double    complex   

</pre><p>次のプロットは、NCO 出力の最初の 128 のサンプルの実数部で、変数 nco_nodither に保存されます。</p><pre class="codeinput">plot(real(squeeze(nco_nodither(1:128)))); grid
title(<span class="string">'Real Part of NCO Output - No Dithering'</span>)
ylabel(<span class="string">'Amplitude'</span>);
xlabel(<span class="string">'Samples'</span>);
set(gcf,<span class="string">'color'</span>,<span class="string">'white'</span>);
</pre><img vspace="5" hspace="5" src="../ddcncoanalysisdemo_02.png" alt=""> <h2>NCO 出力のスペクトル解析<a name="6"></a></h2><p>スペクトルを推定するための適切な方法は、データをどれだけ理解しているかによって異なります。データ セットのサイズが大きい場合 (20,000 サンプル以上)、ピリオドグラムなどの FFT ベースの従来の方法を使用して NCO の出力のスペクトルを計算できます。</p><p>信号にランダム性がある場合でも、これは主に正弦波であるため、パワー スペクトル密度ではなく、ランダム信号のパワーの測定により適した平均二乗スペクトルを測定します。パワーの測定のデモの詳細は、<a href="deterministicsignalpower.html">確定的周期信号のパワーの測定</a>を参照してください。ここでは、msspectrum メソッドを使用して、NCO 信号の平均二乗スペクトルを計算およびプロットします。</p><p>スペクトル解析アルゴリズムを定義します。</p><pre class="codeinput">h = spectrum.periodogram
</pre><pre class="codeoutput"> 
h =
 
    EstimationMethod: 'Periodogram'
          WindowName: 'Rectangular'

</pre><p>平均二乗スペクトルを計算およびプロットします。</p><pre class="codeinput">Fs = 69.333e6;
msspectrum(h,real(nco_nodither),<span class="string">'Fs'</span>,Fs)
set(gcf,<span class="string">'color'</span>,<span class="string">'white'</span>);
</pre><img vspace="5" hspace="5" src="../ddcncoanalysisdemo_03.png" alt=""> <p>予想どおり、平均二乗スペクトル プロットは、14.44MHz でピークを示しています。すなわち、NCO のチューニング周波数は 5/24*Fs = 14.444MHz です。</p><p>ただし、ノイズ フロアは約 -82dB で、GSM 仕様を満たすには高過ぎ、-110dB 以下にする必要があります。位相振動によって改善する場合もありますが、ディザーを加える前に、十分に解析を検討してください。</p><h2>右のウィンドウの選択<a name="10"></a></h2><p>ピリオドグラム スペクトル解析では、箱形ウィンドウを使用します。この結果、周波数の解像度は高くなりますが (メインローブの帯域幅は狭くなる)、ノイズ フロアが高くなります。箱形ウィンドウによって正弦波 NCO 信号を乗算することは、周波数領域で 2 つの信号を畳み込むことと同じです。正弦波信号の周波数応答の畳み込みは、箱形ウィンドウでデルタで、周波数応答が sin(x)/x の場合、中心がデルタの周波数の sin(x)/x 応答になります。したがって、周波数領域にデルタ関数のスメアリングが現れます。ノイズ フロアによって、2 つの信号が追加されます。箱形ウィンドウのノイズ フロアは最大信号スパーよりもさらに大きくなります。</p><p>ウィンドウのノイズ フロアによって信号スパーが見えなくなることを調べるには、箱形ウィンドウの時間および周波数応答を確認します。WinTool などのウィンドウ設計ツールを使用してもウィンドウなどを設計できますが、ここではコマンド ラインを使用します。</p><p>箱形ウィンドウの周波数応答を定義して、表示します。</p><pre class="codeinput">N = length(nco_nodither);
wrect = sigwin.rectwin(N)
</pre><pre class="codeoutput"> 
wrect =
 
      Name: 'Rectangular'
    Length: 20545

</pre><pre class="codeinput">wvtool(wrect)
</pre><img vspace="5" hspace="5" src="../ddcncoanalysisdemo_04.png" alt=""> <p>データ マーカーを拡大または使用する場合、箱形ウィンドウの最大減衰量が約 84dB であることを確認します。これは、NCO 出力のスペクトラム プロットに現れる大まかなノイズ フロアです。</p><p>2 つの正弦波を分解しないで、100dB 以下のスペクトルを探すには、減衰量が 100dB 以上の Von Hann ウィンドウを使用します。</p><pre class="codeinput">whann = sigwin.hann(N)
</pre><pre class="codeoutput"> 
whann =
 
            Name: 'Hann'
          Length: 20545
    SamplingFlag: 'symmetric'

</pre><p>Von Hann ウィンドウ (または単に Hann ウィンドウ) を時間領域と周波数領域に表示します。</p><pre class="codeinput">wvtool(whann)
</pre><img vspace="5" hspace="5" src="../ddcncoanalysisdemo_05.png" alt=""> <p>右側の周波数領域のプロットは、Hann ウィンドウのノイズ フロアが非常に低いことを示し、Hann ウィンドウがこの特定の問題により適していることを表しています。以下は、Hann ウィンドウを使用して NCO 出力のスペクトル推定値を計算した結果です。</p><pre class="codeinput">h.WindowName = <span class="string">'Hann'</span>;
hh = msspectrum(h,real(nco_nodither),<span class="string">'Fs'</span>,Fs);
figure,
plot(hh)        <span class="comment">% Plot Mean-square Spectrum</span>
set(gcf,<span class="string">'color'</span>,<span class="string">'white'</span>);
</pre><img vspace="5" hspace="5" src="../ddcncoanalysisdemo_06.png" alt=""> <p>Hann ウィンドウを使用すると、ノイズ フロアは非常に低くなり、スプリアス ピークが発生します。これで、SFDR を測定し、位相振動によってスプリアス ピークを減少させる方法を見つけることができます。</p><h2>SFDR の測定<a name="16"></a></h2><p>axis コマンドを使用して拡大し、搬送波のピークと最大スプリアス ピークを確認します。</p><pre class="codeinput">axis([0 35 -5 0])
</pre><img vspace="5" hspace="5" src="../ddcncoanalysisdemo_07.png" alt=""> <p>ピークは約 -3.25dB です。最大スパーまで拡大します。</p><pre class="codeinput">axis([0 35 -120 -100])
</pre><img vspace="5" hspace="5" src="../ddcncoanalysisdemo_08.png" alt=""> <p>最大スパーは約 -110dB です。SFDR 値は約 106.75dB と予測できます。また、SFDR は次のようにして取得できます。</p><pre class="codeinput">[sfd,spur,frq] = sfdr(hh,<span class="string">'MinSpurDistance'</span>,5e6)
</pre><pre class="codeoutput">
sfd =

  106.5971


spur =

 -109.8527


frq =

     8666625

</pre><p>取得した SFDR 値は 106.5971dB で、目視で判断したおおよその値に近い値です。また、最大スパーの大きさ (dB 単位) と発生する周波数も得られます。最小スパー距離に 5Mhz を指定すると、搬送波付近に現れるピークが無視されます。</p><h2>ディザーリングの効果の調査<a name="20"></a></h2><p>ディザーを NCO に追加した場合の効果を調査するために、上記の NCO 回路がサブシステムでカプセル化され、3 回複製されています。NCO ごとに異なる量のディザーが選択されています。NCO では 1 ～ 19 ビットの範囲のディザーを指定できますが、このデモではいくつかの値を指定してみます。このモデルを実行すると、追加されたディザーの量に基づいて 3 つの異なる NCO 出力が生成されます。</p><pre class="codeinput">open_system(<span class="string">'ddcncowithdither'</span>)
</pre><img vspace="5" hspace="5" src="../ddcncoanalysisdemo_09.png" alt=""> <p>このシミュレーションを実行すると、MATLAB ワークスペースで 3 つの信号が生成され、これまでに定義したスペクトル解析アルゴリズムを使用して、解析できます。このシミュレーションは、モデルまたはコマンド ラインから sim コマンドを使用して実行できます。</p><pre class="codeinput">sim(<span class="string">'ddcncowithdither'</span>)
</pre><p>シミュレーションが完了すると、NCO の出力である信号が示されます。各信号は異なる量のディザーリングを示しています。</p><pre class="codeinput">whos <span class="string">nco*</span>
</pre><pre class="codeoutput">  Name              Size                  Bytes  Class     Attributes

  nco_dither3       1x1x20501            328016  double    complex   
  nco_dither5       1x1x20501            328016  double    complex   
  nco_dither7       1x1x20501            328016  double    complex   
  nco_nodither      1x1x20545            328720  double    complex   

</pre><p>上記のように、Von Hann ウィンドウでは、スプリアス ピークがマスクされず、Graychip のモデル化で予想されるように、最大スパーは約 -110dB です。SFDR は約 107dB です。GSM 仕様では、SFDR は 110 dB 以上である必要があります。すなわち、仕様を満たすためにディザーリングが役に立っています。</p><p>3 ビットのディザーリングを追加して、開始します。</p><pre class="codeinput">hh = msspectrum(h,real(nco_dither3),<span class="string">'Fs'</span>,Fs);
figure,
plot(hh)        <span class="comment">% Plot Mean-square Spectrum</span>
set(gcf,<span class="string">'color'</span>,<span class="string">'white'</span>);
</pre><img vspace="5" hspace="5" src="../ddcncoanalysisdemo_10.png" alt=""> <p>axis コマンドを使用して再度拡大し、搬送波のピークと最大スプリアス ピークを確認します。</p><pre class="codeinput">axis([0 35 -5 0])
</pre><img vspace="5" hspace="5" src="../ddcncoanalysisdemo_11.png" alt=""> <p>予想どおり、ピークは約 -3.25dB です。最大スパーまで拡大します。</p><pre class="codeinput">axis([0 35 -120 -100])
</pre><img vspace="5" hspace="5" src="../ddcncoanalysisdemo_12.png" alt=""> <p>ここで、SFDR を測定します。</p><pre class="codeinput">[sfd,spur] = sfdr(hh,<span class="string">'MinSpurLevel'</span>,-140,<span class="string">'MinSpurDistance'</span>,5e6)
</pre><pre class="codeoutput">
sfd =

  108.5962


spur =

 -111.8508

</pre><p>最小スパー レベルが -140dB に指定されているため、-140dB 未満のスパーは無視されます。最小スパー レベルを指定すると、処理時間の短縮に役立ちます。</p><p>3 つのディザーのビットが追加されたため、最大スパーは約 112dB です。SFDR は 108.5962dB です。まだ GSM 仕様を満たしていません。</p><p>ここで、5 ビットのディザーリングを追加します。</p><pre class="codeinput">hh = msspectrum(h,real(nco_dither5),<span class="string">'Fs'</span>,Fs);
figure,
plot(hh)        <span class="comment">% Plot Mean-square Spectrum</span>
set(gcf,<span class="string">'color'</span>,<span class="string">'white'</span>);
</pre><img vspace="5" hspace="5" src="../ddcncoanalysisdemo_13.png" alt=""> <p>搬送波周波数のピークは約 -3.25dB である必要があります。最大スパーまで拡大します。</p><pre class="codeinput">axis([0 35 -130 -120])
</pre><img vspace="5" hspace="5" src="../ddcncoanalysisdemo_14.png" alt=""> <p>5 ビットのディザーが追加されたため、最大スパーは約 -127dB です。</p><p>ここで、SFDR を計算します。</p><pre class="codeinput">[sfd,spur] = sfdr(hh,<span class="string">'MinSpurLevel'</span>,-140,<span class="string">'MinSpurDistance'</span>,5e6)
</pre><pre class="codeoutput">
sfd =

  123.7116


spur =

 -126.9662

</pre><p>SFDR は 123.7116dB で、GSM 仕様を超えています。</p><p>大きいディザーを追加するとよい結果が得られたため、7 ビットのディザーリングを追加します。</p><pre class="codeinput">hh = msspectrum(h,real(nco_dither7),<span class="string">'Fs'</span>,Fs);
figure,
plot(hh)        <span class="comment">% Plot Mean-square Spectrum</span>
set(gcf,<span class="string">'color'</span>,<span class="string">'white'</span>);
</pre><img vspace="5" hspace="5" src="../ddcncoanalysisdemo_15.png" alt=""> <p>SFDR を計算します。</p><pre class="codeinput">[sfd,spur] = sfdr(hh,<span class="string">'MinSpurLevel'</span>,-140,<span class="string">'MinSpurDistance'</span>,5e6)
</pre><pre class="codeoutput">
sfd =

  119.1595


spur =

 -122.4141

</pre><p>最大スパーの大きさは -122.4141dB で、SFDR は 119.1595dB です。7 ビットのディザーリングを使用すると GSM 仕様は満たされますが、5 ビットのディザーリングを使用したときと比較すると効果的ではありません。</p><h2>結果の比較<a name="38"></a></h2><p>NCO 出力ごとのディザーリング量に対する NCO 出力ごとの SFDR を表にします。</p><pre> Number of   Spur Free Dynamic
Dither bits   Range(dBc)</pre><pre>   0            106.5971</pre><pre>   3            108.5962</pre><pre>   5            123.7116</pre><pre>   7            119.1595</pre><h2>まとめ<a name="41"></a></h2><p>このデモでは、GSM アプリケーションのデジタル周波数変換器で使用される NCO の出力を解析しました。SFDR (最大スパーと対象の信号のピークの差) の測定にはスペクトル解析を使用しました。スパーは、量子化の影響による確定的、周期的な誤差です。また、このデモでは、NCO におけるディザーを追加した場合の効果を調査し、純度を改善するためランダムなデータを NCO に追加しました。その結果、5 ビットのディザーリングを使用すると最大の SFDR を達成できることがわかりました。</p><p class="footer">Copyright 1988-2007 The MathWorks, Inc.<br>Published with MATLAB&reg; 7.11</p><p class="footer" id="trademarks">MATLAB and Simulink are registered trademarks of The MathWorks, Inc.  Please see <a href="http://www.mathworks.com/trademarks">www.mathworks.com/trademarks</a> for a list of other trademarks owned by The MathWorks, Inc.  Other product or brand names are trademarks or registered trademarks of their respective owners.</p></div><!-- ##### SOURCE BEGIN ##### %% Analysis of Fixed-Point Numerically Controlled Oscillator % Numerically controlled oscillators (NCOs) are an efficient means of % generating sinusoidal signals, and are useful when you require a % continuous-phase sinusoidal signal with variable frequency. % % Copyright 1988-2007 The MathWorks, Inc.  % $Revision: 1.1.4.2.2.1 $ $Date: 2010/07/29 21:29:04 $  %% Introduction % This demo uses MATLAB(R) and the Signal Processing Toolbox(TM) to analyze the % NCO of a digital down-converter (DDC) implemented in fixed-point % arithmetic. Using spectral analysis, you will measure the spurious free % dynamic range (SFDR) of the NCO, and explore the effects of adding phase % dither. The number of dither bits affects hardware implementation % choices. Adjusting the number of dither bits in simulation lets you see % the trade-offs among noise floor level, spurious effects, and number of % dither bits before implementing the DDC in hardware. The DDC in the demo, % designed to meet the GSM specification, models the Graychip 4016.   % % The DDC is a key component of digital radios.  It translates the % high-input sample rates of a digital radio down to lower sample rates % (baseband) for further and easier processing. Adhering to the GSM % specifications, in this example, the DDC has an input rate of 69.333 MHz % and is tasked with converting the rate down to 270 KHz. % % The DDC consists of an NCO and a mixer to quadrature down convert the % input signal to baseband.  A Cascaded Integrator-Comb (CIC) then low-pass % filters the baseband signal, and along with two FIR decimating filters % downsample the signal to achieve the desired low sample rate, which is % then ready for further processing.  The final stage, depending on the % application, often includes a resampler that interpolates or decimates % the signal to achieve the desired sample rate.  Further filtering can be % achieved with the resampler.  See the block diagram of a typical DDC, % below. Note that Simulink(R) handles complex signals, so we don't have to % treat the I and Q channels separately. % % <<ddcdemomodel.png>>  %% % While this demo focuses on the analysis of the NCO, a demo titled % <../../../filterdesign/filtdesdemos/html/ddcfilterchaindemo.html % "Implementing the Filter Chain of a Digital Down-Converter">, focusing on % designing the three-stage, multirate, fixed-point filter chain and HDL % code generation is available in the Filter Design Toolbox(TM).  %% The Numerically Controlled Oscillator % The digital mixer section of the DDC includes a multiplier and an NCO, % which provide channel selection or tuning for the radio. The mixer is % basically a sine-cosine generator, creating complex values for each % sine-cosine pair.  The typical NCO has four components: the phase % accumulator, the phase adder, the dither generator, and sine-cosine % lookup table.   % % Here is a typical NCO circuit modeled in Simulink, similar to what you % might see in the Graychip data sheet.  open_system('ddcnco');  %% % Based on the input frequency, the NCO's phase accumulator produces values % that address a sine-cosine lookup table.  The phase adder specifies a % phase offset that modulates the output of the phase accumulator. The % Dither Generator provides phase dithering to reduce amplitude % quantization noise, and improving the SFDR of the NCO.  The Sine/Cosine % Lookup block produces the actual complex sinusoidal signal, and the % output is stored in the variable nco_nodither. % % In the Graychip, the tuning frequency is specified as a normalized value % relative to the chip's clock rate. So for a tuning frequency of F, the % normalized frequency is F/Fclk, where Fclk is the chip's clock rate. The % phase offset is specified in radians, ranging from 0 to 2pi.  In this % demo the normalized tuning frequency is set to 5/24 while the phase % offset is set to 0. The tuning frequency is specified as a 32-bit word % and the phase offset is specified as a 16-bit word.  % % Since the NCO is implemented using fixed-point arithmetic, it experiences % undesirable amplitude quantization effects. These numerical distortions % are due to the effects of finite wordlengths.  Basically, sinusoids are % quantized creating cumulative, deterministic, and periodic errors in the % time domain.  These errors, appear as line spectra or spurs in the % frequency domain.  The amount of attenuation from the peak of the signal % of interest to the highest spur is the SFDR. % % The SFDR of the Graychip is 106 dB, but the GSM specification requires % that the SFDR be greater than 110 dB. There are several ways to improve % the SFDR, and you will explore adding phase dither to the NCO.   %  % The Graychip's NCO contains a phase dither generator which is basically a % random integer generator used to improve the oscillator's output purity. % Dithering causes the unintended periodicities of the quantization noise % (which causes "spikes" in spectra and thus poor SFDR) to be spread across % a broad spectrum, effectively reducing these undesired spectral peaks. % Conservation of energy applies, however, so the spreading effectively % raises the overall noise floor.  That is, the dithering is good for SFDR, % but only up to a point. % % Let's run the NCO model and analyze its output in the MATLAB workspace. % This model does not use dithering. sim('ddcnco'); whos nco*  %% % The plot below displays the real part of the first 128 samples of the % NCO's output, stored in the variable, nco_nodither. plot(real(squeeze(nco_nodither(1:128)))); grid title('Real Part of NCO Output - No Dithering') ylabel('Amplitude'); xlabel('Samples'); set(gcf,'color','white');  %% Spectral Analysis of NCO Output % Choosing an appropriate technique for estimating spectra depends on % understanding your data well.  Given a large data set (more than 20,000 % samples), you can rely on an FFT-based classical method, such as a % periodogram, to calculate the spectral content of the NCO's output.  % % Although the signal has some randomness, it is primarily sinusoidal, so % you will measure its mean-square spectrum, rather than the power spectral % density, which is more appropriate for measuring the power of random % signals. For a demo on measuring power, refer to % <deterministicsignalpower.html Measuring the Power of Deterministic % Periodic Signals.> Below we use the msspectrum method to calculate and % plot the mean-square spectrum of the NCO signal.  %% % Define the spectral analysis algorithm. h = spectrum.periodogram  %% % Calculate and plot the mean-square spectrum. Fs = 69.333e6;  msspectrum(h,real(nco_nodither),'Fs',Fs)  set(gcf,'color','white'); %% % As expected, the mean-square spectrum plot shows a peak at 14.44 MHz, % which is the NCO's tuning frequency, 5/24*Fs = 14.444 MHz. % % The noise floor, however, is about -82 dB, which is too high to meet the % GSM specification, which requires -110 dB or less.  Phase dither can % improve this, but before you add dither take a closer look at your % analysis.  %% Choosing the Right Window % Periodogram spectral analysis uses a rectangular window, which provides % good frequency resolution (that is, it has a narrow mainlobe bandwidth), % but has a high noise floor.  Multiplying the sinusoidal NCO signal by a % rectangular window is the same as convolving the two signals in the % frequency domain.  The convolution of a sinusoidal signal's frequency % response, which is a delta, by a rectangular window, whose frequency % response is a sin(x)/x, results in a sin(x)/x response centered at % the frequency of the delta.  So there is a smearing of the delta function % in the frequency domain. The noise floor will be the addition of the two % signals.  Therefore, what you see is the noise floor of the rectangular % window, which is much higher than the highest signal spur. % % To verify that the noise floor of the window is preventing you from % seeing the signal spurs, look at the time and frequency response of a % rectangular window.  You can design such a window using the window design % tool, WinTool, but here you will use the command line. % % Define and view the frequency response of a rectangular window. N = length(nco_nodither); wrect = sigwin.rectwin(N) %% wvtool(wrect)  %% % If you zoom in or use data markers you see that the maximum attenuation % of the rectangular window is about 84 dB, which is roughly the noise % floor seen in the spectrum plot of the NCO output. % % Since you are not trying to resolve two sinusoids, but rather looking for % spectral content below 100 dB, use a Von Hann window, which provides more % than 100 dB of attenuation.    whann = sigwin.hann(N)  %% % View the Von Hann, or simply Hann, window in time and the frequency % domain. wvtool(whann)  %% % The frequency domain plot on the right shows the Hann window's much lower % noise floor, demonstrating that, the Hann window is better suited for % this particular problem.  Here are the results of using the Hann window % to calculate the spectral estimate of the NCO output.  h.WindowName = 'Hann'; hh = msspectrum(h,real(nco_nodither),'Fs',Fs); figure, plot(hh)        % Plot Mean-square Spectrum set(gcf,'color','white');  %% % Using a Hann window produced a much lower noise floor with its attendant % spurious peaks.  Now you can measure the SFDR and look for ways to % decrease the spurious peaks through phase dithering.  %% Measuring SFDR % Zoom in using the axis command to observe the peak of the % carrier and the highest spurious peak. axis([0 35 -5 0])  %% % The peak is roughly -3.25 dB.  Now zoom in to the highest spur. axis([0 35 -120 -100])  %% % The highest spur is about -110 dB.  We expect a SFDR value around 106.75 % dB. Alternatively, SFDR can be obtained by [sfd,spur,frq] = sfdr(hh,'MinSpurDistance',5e6) %% % We obtain the value of SFDR to be 106.5971 dB which is close to the rough % value obtained by visual inspection. Also the magnitude of the highest % spur in dB and the frequency at which it occurs are provided. A % minimum spur distance of 5 Mhz is specified to ignore peaks that appear in % close proximity to the carrier.   %% Exploring the Effects of Dithering % To explore adding dither to the NCO, the NCO circuit shown above has been % encapsulated in a subsystem and duplicated three times.  A different % amount of dither was selected for each NCO.  Although the NCO allows a % range of 1 to 19 bits of dither to be specified, you will try just few % values.  Running this model will produce three different NCO outputs % based on the amount of dither added. open_system('ddcncowithdither')  %% % Running the simulation will produce three signals in the MATLAB workspace % that you can then analyze using the spectral analysis algorithm defined % above.  You can run the simulation from the model or from the command % line using the sim command.  sim('ddcncowithdither')  %% % After the simulation completes you are left with the signals that are the % NCOs' output. Each signal shows a different amount of dithering. whos nco*  %% % As seen above, a Von Hann window doesn't mask the spurious peaks, and as % expected with modeling a Graychip, the highest spur is at about -110 dB. % The SFDR is about 107 dB. The GSM specification, remember, requires % that it be at least 110 dB. This is where dithering will help meet the % specification.   %% % Start by adding 3 bits of dithering. hh = msspectrum(h,real(nco_dither3),'Fs',Fs); figure, plot(hh)        % Plot Mean-square Spectrum set(gcf,'color','white');  %% % Zoom in again using the axis command to look at the carrier peak and the % highest spurious peak. axis([0 35 -5 0])  %% % As expected, the peak is again roughly -3.25 dB.  Now zoom in to the % highest spur. axis([0 35 -120 -100])  %%  % Now measure SFDR [sfd,spur] = sfdr(hh,'MinSpurLevel',-140,'MinSpurDistance',5e6)  %% % A minimum spur level of -140 dB is specified to ignore spurs that are % below -140 dB. Specifying a minimum spur level helps in reducing the % processing time. %% % With three bits of dither added, the highest spur is now about 112 dB. % The SFDR is 108.5962 dB.  It still fails to meet the GSM specification. % %% % Now add 5 bits of dithering. hh = msspectrum(h,real(nco_dither5),'Fs',Fs); figure, plot(hh)        % Plot Mean-square Spectrum set(gcf,'color','white');  %% % The peak of the carrier frequency should still be roughly -3.25 dB.  Zoom % in to the highest spur. axis([0 35 -130 -120])  %% % With five bits of dither added, the highest spur is now about -127 dB. % %% % Now calculate SFDR [sfd,spur] = sfdr(hh,'MinSpurLevel',-140,'MinSpurDistance',5e6) %% % The SFDR is 123.7116 dB, exceeding the GSM  specification.  %%   % It appears that more dither gives better results, so add 7 bits of % dithering. hh = msspectrum(h,real(nco_dither7),'Fs',Fs);  figure, plot(hh)        % Plot Mean-square Spectrum set(gcf,'color','white');  %% % Calculate SFDR [sfd,spur] = sfdr(hh,'MinSpurLevel',-140,'MinSpurDistance',5e6) %%  % The magnitude of highest spur is -122.4141 dB, which results in SFDR % of 119.1595 dB.  Using 7 bits of dithering meets the GSM specification, % but is not as effective as using 5 bits of dithering.  %% Comparing Results  % Tabulate the SFDR for each NCO output against the amounts of dithering % for each NCO output.   %% % %   Number of   Spur Free Dynamic  %  Dither bits   Range(dBc)  % %% % %     0            106.5971  % %     3            108.5962  % %     5            123.7116  % %     7            119.1595  %  %% Summary  % This demo analyzed the output of an NCO used in a digital down converter % for a GSM application. Spectral analysis was used to measure the SFDR, % the difference between the highest spur and the peak of the signal of % interest. Spurs are deterministic, periodic errors that result from % quantization effects. The demo also explored the effects of adding dither % in the NCO, which adds random data to the NCO to improve its purity.  We % found that using five bits of dithering achieved the highest SFDR.   displayEndOfDemoMessage(mfilename)  ##### SOURCE END ##### --></body></html>